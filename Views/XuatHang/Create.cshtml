@{
    ViewBag.Title = "T·∫°o phi·∫øu xu·∫•t h√†ng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* --- 1. BASE STYLE --- */
    .bg-ebike { background: linear-gradient(135deg, #28a745, #218838) !important; color: white; }
    .text-ebike { color: #28a745 !important; }
    
    /* --- 2. B·∫¢NG H√ÄNG H√ìA --- */
    .table-input { 
        width: 100%; border: 1px solid #dee2e6; padding: 6px 8px; 
        border-radius: 4px; text-align: right; font-weight: 600; color: #495057;
        transition: border-color 0.2s;
    }
    .table-input:focus { outline: none; border-color: #28a745; background-color: #fff; }
    .table-input[readonly] { background-color: #f8f9fa; border: none; font-weight: 700; color: #212529; }

    /* --- 3. SUMMARY BOX (C·ªòT PH·∫¢I) - PHONG C√ÅCH H√ìA ƒê∆†N --- */
    .summary-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .summary-header {
        background-color: #fff;
        border-bottom: 2px solid #f1f1f1;
        padding: 15px 20px;
    }

    .summary-body {
        padding: 20px;
        background-color: #fff;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-size: 0.95rem;
        color: #6c757d;
    }
    
    .summary-row strong { color: #343a40; }

    /* √î nh·∫≠p gi·∫£m gi√° ƒë·∫πp h∆°n */
    .discount-input-group {
        position: relative;
        width: 140px;
    }
    .discount-input-group input {
        padding-right: 25px;
        text-align: right;
        font-weight: bold;
        color: #dc3545;
        border: 1px dashed #ced4da;
        border-radius: 4px;
    }
    .discount-input-group input:focus {
        border-style: solid;
        border-color: #dc3545;
        box-shadow: none;
    }
    .discount-symbol {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #dc3545;
        font-size: 0.8rem;
    }

    /* Khu v·ª±c T·ªïng ti·ªÅn ch·ªët ƒë∆°n */
    .final-total-box {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        text-align: right;
        border: 1px solid #e9ecef;
    }
    .final-label { display: block; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; margin-bottom: 5px; }
    .final-value { font-size: 1.8rem; color: #28a745; font-weight: 800; line-height: 1; }

    /* N√∫t b·∫•m */
    .btn-action-lg {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
        border: none;
    }
    .btn-action-lg:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3); }
    
    /* Search Input */
    .search-box { border-radius: 50px; padding-left: 20px; border: 1px solid #e9ecef; background: #f8f9fa; }
    .search-box:focus { background: #fff; border-color: #28a745; box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1); }
    /* T√¨m ƒëo·∫°n n√†y trong <style> */
    .btn-ebike { 
        /* ƒê·ªïi m√†u n·ªÅn ch√≠nh ·ªü ƒë√¢y */
        background-color: #0d6efd !important; /* M√†u xanh d∆∞∆°ng */
        color: white; 
        border: none; 
        /* ... */
    }
    .btn-ebike:hover { 
        /* ƒê·ªïi m√†u khi di chu·ªôt v√†o (n√™n ƒë·∫≠m h∆°n m√†u ch√≠nh x√≠u) */
        background-color: #0b5ed7 !important; 
        /* ... */
    }
</style>

<div class="container-fluid pt-4 pb-5">
    
    <div class="d-flex align-items-center mb-4">
        <a href="@Url.Action("Index", "XuatHang")" class="btn btn-light rounded-circle me-3 shadow-sm" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-arrow-left text-secondary"></i>
        </a>
        <h3 class="m-0 text-dark fw-bold">T·∫°o phi·∫øu xu·∫•t h√†ng</h3>
    </div>

    <div class="row g-4"> 
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4">
                    <div class="mb-4 position-relative">
                        <i class="fas fa-search text-muted position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%);"></i>
                        <input type="text" id="searchInput" class="form-control form-control-lg search-box" style="padding-left: 45px;" placeholder="T√¨m ki·∫øm h√†ng h√≥a (F3)..." />
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="text-center" style="width: 50px">#</th>
                                    <th style="width: 120px">M√£ h√†ng</th>
                                    <th>T√™n h√†ng</th>
                                    <th class="text-center" style="width: 80px">ƒêVT</th>
                                    <th class="text-center" style="width: 80px">T·ªìn</th>
                                    <th class="text-end" style="width: 100px">SL Xu·∫•t</th>
                                    <th class="text-end" style="width: 130px">ƒê∆°n gi√°</th>
                                    <th class="text-end" style="width: 130px">Th√†nh ti·ªÅn</th>
                                    <th style="width: 50px"></th>
                                </tr>
                            </thead>
                            <tbody id="productTable"></tbody>
                        </table>
                        
                        <div id="emptyState" class="text-center py-5" style="display:none;">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-box-open fa-2x text-muted opacity-50"></i>
                            </div>
                            <p class="text-muted fw-bold">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
                            <small class="text-secondary">Vui l√≤ng t√¨m ki·∫øm v√† ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t kho</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-pen-alt text-warning me-2"></i>
                        <h6 class="m-0 fw-bold text-secondary">Ghi ch√∫ xu·∫•t h√†ng</h6>
                    </div>
                    <textarea class="form-control bg-light border-0" rows="2" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4">
            
            <div class="summary-card bg-white">
                <div class="summary-header">
                    <h5 class="m-0 fw-bold text-ebike"><i class="fas fa-file-invoice me-2"></i>Th√¥ng tin phi·∫øu</h5>
                </div>
                
                <div class="summary-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted fw-bold text-uppercase">M√£ phi·∫øu</label>
                        <input type="text" class="form-control fw-bold text-dark bg-light" readonly value="PX-20251202-001" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small text-muted fw-bold text-uppercase">Kh√°ch h√†ng <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select class="form-select fw-bold" id="slKhachHang">
                                <option value="KH001">Kh√°ch l·∫ª</option>
                                <option value="KH002">ƒê·∫°i l√Ω C·∫ßn Th∆°</option>
                            </select>
                            <button class="btn btn-outline-secondary"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small text-muted fw-bold text-uppercase">Ng√†y xu·∫•t</label>
                        <input type="datetime-local" class="form-control" id="dtNgayXuat" readonly />
                    </div>

                    <hr class="my-4 opacity-10">

                    <div class="summary-row">
                        <span>T·ªïng s·ªë l∆∞·ª£ng</span>
                        <strong id="totalQty">0</strong>
                    </div>
                    
                    <div class="summary-row">
                        <span>T·ªïng ti·ªÅn h√†ng</span>
                        <strong id="subTotal">0</strong>
                    </div>

                    <div class="summary-row">
                        <span>Gi·∫£m gi√°</span>
                        <div class="discount-input-group">
                            <input type="text" class="form-control form-control-sm" id="giamGia" value="0">
                            <span class="discount-symbol">ƒë</span>
                        </div>
                    </div>

                    <div class="final-total-box">
                        <span class="final-label">Kh√°ch ph·∫£i tr·∫£</span>
                        <div class="final-value" id="canTra">0</div>
                    </div>

                    <div class="mt-4 d-grid gap-3">
                        <button type="button" id="btnHoanTat" class="btn btn-ebike btn-action-lg text-white">
                            <i class="fas fa-check-circle me-2"></i> Ho√†n t·∫•t
                        </button>
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <button id="btnLuuNhap" class="btn btn-outline-secondary w-100 fw-bold border-0 bg-light">
                                    <i class="fas fa-save me-1"></i> L∆∞u nh√°p
                                </button>
                            </div>
                            <div class="col-6">
                                <a href="@Url.Action("Index", "XuatHang")" class="btn btn-outline-danger w-100 fw-bold border-0 bg-light text-danger">
                                    <i class="fas fa-times me-1"></i> H·ªßy b·ªè
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN').format(amount);

        function setCurrentTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dtNgayXuat').value = now.toISOString().slice(0,16);
        }

        let demoProducts = [
            {stt:1, ma:'HH003', ten:'ƒê√®n pha LED', dvt:'C√°i', ton: 50, sl:2, dg:450000},
            {stt:2, ma:'HH004', ten:'Khung xe ƒëi·ªán', dvt:'B·ªô', ton: 20, sl:1, dg:2500000}
        ];

        function renderProducts() {
            const table = document.getElementById('productTable');
            const emptyState = document.getElementById('emptyState');
            table.innerHTML = '';
            
            if (demoProducts.length === 0) {
                emptyState.style.display = 'block';
                calculateTotal();
                return;
            } else {
                emptyState.style.display = 'none';
            }

            demoProducts.forEach((p, index) => {
                const tr = document.createElement('tr');
                const thanhTien = p.sl * p.dg;
                
                tr.innerHTML = `
                    <td class="text-center text-muted fw-bold">${index + 1}</td>
                    <td class="fw-bold text-success small">${p.ma}</td>
                    <td class="fw-bold text-dark">${p.ten}</td>
                    <td class="text-center text-secondary small">${p.dvt}</td>
                    <td class="text-center text-muted small">${p.ton}</td>
                    <td>
                        <input type="number" class="table-input" value="${p.sl}" min="1" max="${p.ton}" data-index="${index}">
                    </td>
                    <td>
                        <input type="text" class="table-input" readonly value="${formatMoney(p.dg)}" style="background:transparent; border:none; padding-right:0;">
                    </td>
                    <td class="text-end fw-bold text-dark">${formatMoney(thanhTien)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm text-danger p-0 border-0" onclick="deleteRow(${index})"><i class="fas fa-times-circle"></i></button>
                    </td>
                `;
                table.appendChild(tr);
            });
            
            calculateTotal();
            addEventListeners();
        }

        function deleteRow(index) {
            if (confirm('X√≥a d√≤ng n√†y?')) {
                demoProducts.splice(index, 1);
                renderProducts();
            }
        }

        function calculateTotal() {
            let totalQty = 0;
            let subTotal = 0;

            demoProducts.forEach(p => {
                totalQty += p.sl;
                subTotal += (p.sl * p.dg);
            });

            const giamGiaStr = document.getElementById('giamGia').value.replace(/\./g, '');
            const giamGia = parseFloat(giamGiaStr) || 0;
            
            document.getElementById('totalQty').textContent = totalQty;
            document.getElementById('subTotal').textContent = formatMoney(subTotal);
            document.getElementById('canTra').textContent = formatMoney(subTotal - giamGia);
        }

        function addEventListeners() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    const index = this.dataset.index;
                    let val = parseInt(this.value) || 1;
                    let max = parseInt(this.max);
                    if(val > max) { alert("Qu√° t·ªìn kho!"); val = max; this.value = val; }
                    demoProducts[index].sl = val;
                    renderProducts();
                });
            });

            document.getElementById('giamGia').addEventListener('input', function() {
                let val = this.value.replace(/\D/g, '');
                this.value = val ? parseInt(val).toLocaleString('vi-VN') : 0;
                calculateTotal();
            });
        }

        $(document).ready(function() {
            setCurrentTime();
            $('#btnHoanTat').click(function() { if(demoProducts.length>0 && confirm("Ho√†n t·∫•t phi·∫øu?")) alert("‚úÖ XONG!"); });
            $('#btnLuuNhap').click(function() { if(demoProducts.length>0) alert("üíæ ƒê√É L∆ØU!"); });
            renderProducts();
        });
    </script>
}