@{
    ViewBag.Title = "Danh sách phiếu xuất";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<style>
    /* 1. HEADER MOBILE & CSS CHUNG */
    .app-header {
        background-color: #28a745; 
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between; 
        align-items: center;
        position: sticky; top: 0; z-index: 1000;
    }
    .app-header .btn-header-group { display: flex; align-items: center; }
    .app-header .btn-white-green-text {
        color: #28a745 !important; background-color: white !important;
        border: 1px solid white !important; font-weight: bold;
        margin-left: 5px; padding: 0.25rem 0.5rem; font-size: 0.8rem;
        display: inline-flex; align-items: center; justify-content: center;
    }

    /* 2. NÚT BẤM THẲNG HÀNG */
    .action-buttons { display: flex; align-items: center; gap: 5px; height: 100%; }
    .action-buttons .btn {
        white-space: nowrap !important; height: 38px;
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 90px; font-weight: 600; border-radius: 5px; padding: 0 12px;
    }
    #searchInput { height: 38px; }
    .input-group-append .btn {
        height: 38px; display: flex; align-items: center; justify-content: center;
        padding-top: 0; padding-bottom: 0;
    }

    /* 3. RESPONSIVE */
    @@media (max-width: 767.98px) {
        .app-header h4 { max-width: 50%; font-size: 1.1rem; }
        .app-header .btn-header-group { overflow-x: auto; white-space: nowrap; justify-content: flex-end; }
        .action-buttons .btn { font-size: 0.8rem; padding: 0 8px; }
    }
    @@media (min-width: 768px) { .app-header { display: none !important; } }

    /* 4. IN ẤN */
    @@media print {
        .app-header, .main-sidebar, .main-header, .action-buttons, #filterCollapseContent, #searchBtn, #searchInput, .main-footer, .card-header, #selectAll {
            display: none !important;
        }
        .content-wrapper { margin-left: 0 !important; padding-top: 0 !important; background: white !important; }
        .card { box-shadow: none !important; border: none !important; }
        table { width: 100% !important; border-collapse: collapse !important; }
        th, td { border: 1px solid #000 !important; padding: 5px !important; color: #000 !important; }
    }
</style>

<div class="app-header">
    <h4 class="m-0 font-weight-bold"><i class="fas fa-file-export mr-2"></i> Phiếu xuất hàng</h4>
    <div class="btn-header-group d-flex d-md-none">
        <a href="@Url.Action("Create", "XuatHang")" class="btn btn-white-green-text">
            <i class="fas fa-plus"></i>
        </a>
        <button class="btn btn-white-green-text" id="btnPrintMobile"><i class="fas fa-print"></i></button>
        <button class="btn btn-white-green-text" id="btnExportMobile"><i class="fas fa-file-excel"></i></button>
    </div>
</div>

<section class="content">
    <div class="container-fluid pt-3">
        <div class="d-none d-md-flex justify-content-between align-items-center mb-3">
            <h3 class="font-weight-bold text-dark m-0">Danh sách phiếu xuất</h3>
        </div>

        <div class="row">
            <div class="col-12 col-md-3 mb-3 collapse d-md-block" id="filterCollapseContent">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="font-weight-bold mb-3 text-dark">Bộ lọc phiếu xuất</h5>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Chi nhánh</label>
                            <select class="form-control" id="chiNhanhFilter">
                                <option value="">Tất cả</option>
                                <option value="CN Nguyễn Văn Cừ - Cần Thơ">CN Nguyễn Văn Cừ</option>
                                <option value="CN Ninh Kiều">CN Ninh Kiều</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Thời gian</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="thoigian" id="thangnay" value="month" checked>
                                <label class="form-check-label text-dark" for="thangnay">Tháng này</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="thoigian" id="tuychinh" value="custom">
                                <label class="form-check-label text-dark" for="tuychinh">Tùy chỉnh</label>
                            </div>
                            <input type="date" class="form-control" id="dateFilter" style="display:none;" /> 
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Người tạo</label>
                            <select class="form-control" id="nguoiTaoFilter">
                                <option value="">Tất cả</option>
                                <option value="Nguyễn Văn B">Nguyễn Văn B</option>
                                <option value="Trần Thị C">Trần Thị C</option>
                            </select>
                        </div>

                        <button class="btn btn-success btn-block font-weight-bold mt-3" id="applyFilter">
                            <i class="fas fa-filter"></i> Áp dụng bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="d-flex align-items-center mb-3">
                    <div class="input-group flex-grow-1 mr-2">
                        <input type="text" class="form-control" id="searchInput" placeholder="Theo mã phiếu, khách hàng..." />
                        <div class="input-group-append">
                            <button class="btn btn-success" id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-secondary d-md-none" type="button" data-toggle="collapse" data-target="#filterCollapseContent">
                        <i class="fas fa-filter"></i> 
                    </button>
                    
                    <div class="ml-auto d-none d-md-flex action-buttons">
                        <a href="@Url.Action("Create", "XuatHang")" class="btn btn-success font-weight-bold mr-2">
                            <i class="fas fa-plus"></i> Tạo phiếu xuất
                        </a>
                        <button class="btn btn-outline-success mr-2" id="btnPrint">
                            <i class="fas fa-print mr-1"></i> In danh sách
                        </button>
                        <button class="btn btn-outline-secondary" id="btnExport">
                            <i class="fas fa-file-excel mr-1"></i> Xuất Excel
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header font-weight-bold bg-success text-white">
                        Danh sách phiếu xuất
                    </div>
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="phieuXuatTable">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th><input type="checkbox" id="selectAll" /></th>
                                    <th>Mã phiếu</th>
                                    <th>Khách hàng</th>
                                    <th>Ngày tạo</th>
                                    <th>Người tạo</th>
                                    <th>Tổng tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-chinhanh="CN Nguyễn Văn Cừ - Cần Thơ" data-nguoitao="Nguyễn Văn B">
                                    <td><input type="checkbox" /></td>
                                    <td class="fw-bold text-success">PX001</td>
                                    <td>Khách hàng A</td>
                                    <td>05/11/2025</td>
                                    <td>Nguyễn Văn B</td>
                                    <td class="fw-bold">8,000,000 ₫</td>
                                </tr>
                                <tr data-chinhanh="CN Nguyễn Văn Cừ - Cần Thơ" data-nguoitao="Trần Thị C">
                                    <td><input type="checkbox" /></td>
                                    <td class="fw-bold text-success">PX002</td>
                                    <td>Khách hàng B</td>
                                    <td>06/11/2025</td>
                                    <td>Trần Thị C</td>
                                    <td class="fw-bold">12,500,000 ₫</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center py-5 text-muted" id="noResults" style="display:none;">
                        <i class="fas fa-inbox fa-3x text-secondary"></i>
                        <p class="mt-2">Không tìm thấy kết quả</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 1. XỬ LÝ NÚT IN & EXPORT
            $('#btnPrint, #btnPrintMobile').click(function() { window.print(); });
            
            $('#btnExport, #btnExportMobile').click(function() {
                var html = document.getElementById("phieuXuatTable").outerHTML;
                var blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.download = "DanhSachPhieuXuat.xls";
                link.href = url;
                link.click();
            });

            // 2. LOGIC LỌC & TÌM KIẾM
            $('#dateFilter').hide();
            $('input[name="thoigian"]').change(function () {
                if ($(this).val() === 'custom') $('#dateFilter').slideDown();
                else { $('#dateFilter').slideUp(); $('#dateFilter').val(''); }
            });

            $('#applyFilter').click(function () {
                if ($(window).width() < 768) $('#filterCollapseContent').collapse('hide');
                performFilter();
            });

            $('#searchBtn').click(function () { performSearch(); });
            $('#searchInput').on('keyup', function (e) { if (e.key === 'Enter') performSearch(); });

            function performSearch() {
                var keyword = $('#searchInput').val().toLowerCase().trim();
                var found = false;
                $('#phieuXuatTable tbody tr').each(function () {
                    var text = $(this).text().toLowerCase();
                    if (text.indexOf(keyword) > -1) { $(this).show(); found = true; }
                    else { $(this).hide(); }
                });
                toggleNoResults(!found);
            }

            function performFilter() {
                var cn = $('#chiNhanhFilter').val();
                var user = $('#nguoiTaoFilter').val();
                var date = $('input[name="thoigian"]:checked').val() === 'custom' ? $('#dateFilter').val() : '';
                var visibleCount = 0;

                $('#phieuXuatTable tbody tr').each(function () {
                    var row = $(this);
                    var rCN = row.data('chinhanh');
                    var rUser = row.data('nguoitao');
                    var rDate = row.find('td:eq(3)').text().trim(); // Ngày tạo ở cột 4 (index 3)

                    var show = true;
                    if (cn && rCN.indexOf(cn) === -1) show = false;
                    if (user && rUser !== user) show = false;
                    
                    if (date) {
                        var fDate = date.split('-').reverse().join('/');
                        if (rDate !== fDate) show = false;
                    }

                    if (show) { row.show(); visibleCount++; } else { row.hide(); }
                });
                
                toggleNoResults(visibleCount === 0);
            }

            function toggleNoResults(isEmpty) {
                if (isEmpty) { $('#noResults').show(); $('#phieuXuatTable').hide(); }
                else { $('#noResults').hide(); $('#phieuXuatTable').show(); }
            }
            
            $('#selectAll').click(function () {
                $('#phieuXuatTable tbody input[type="checkbox"]').prop('checked', this.checked);
            });
        });
    </script>
}