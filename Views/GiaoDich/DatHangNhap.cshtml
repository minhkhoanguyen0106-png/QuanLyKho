@{
    ViewBag.Title = "Đặt hàng nhập";
    Layout = "/Views/Shared/_Layout.cshtml";
    var successColor = "#28a745"; 
}

<style>
/* 1. CSS Cho Header và Bộ lọc Responsive */
.app-header {
    background-color: #4CAF50; 
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    position: sticky; 
    top: 0;
    z-index: 1000;
}
.app-header .btn-header-group {
    display: flex;
    align-items: center;
}
/* *** CSS MỚI CHO NÚT MÀU TRẮNG NỀN, CHỮ XANH LÁ *** */
.app-header .btn {
    /* Đảm bảo nút nhỏ gọn và có khoảng cách */
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    line-height: 1.5;
    margin-left: 5px; 
}

/* Định nghĩa màu sắc cho TẤT CẢ 3 NÚT: Nền Trắng, Chữ Xanh Lá */
.app-header .btn-white-green-text {
    color: #4CAF50 !important; /* Chữ xanh lá */
    background-color: white !important; /* Nền trắng */
    border: 1px solid white !important; /* Viền trắng */
    font-weight: bold; /* Thêm bold cho dễ nhìn */
}

/* ******************************************* */


/* 2. CSS Cho Nút Trạng thái (Selectable Badges) */
.selectable-badge {
    display: flex; 
    align-items: center;
    justify-content: center;
    width: 120px; 
    height: 35px; 
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    white-space: nowrap; 
    background-color: white !important;
    color: #212529 !important; 
    border: 1px solid #28a745;
}
.selectable-badge.active-status {
    background-color: #28a745 !important;
    color: white !important;
    font-weight: bold;
    border-color: #28a745;
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); 
}

/* 3. CSS Cho Bố cục Nút trên Mobile (Chỉnh kích thước nhỏ và cách đều) */
@@media (max-width: 767.98px) {
    .app-header h4 {ewxsszR5U8
        max-width: 50%;
        font-size: 1.1rem;
    }
    .app-header .btn-header-group {
        overflow-x: auto; 
        white-space: nowrap;
        justify-content: flex-end;
    }

    .input-group + .btn.d-md-none {
        padding: 0.375rem 0.75rem;
    }
}
/* Ẩn các nút chức năng trong header trên desktop vì chúng đã có ở khu vực chính */
@@media (min-width: 768px) {
    .app-header .btn-header-group {
        display: none !important;
    }
}
</style>

<div class="app-header">
    <h4 class="m-0 font-weight-bold"><i class="fas fa-truck-loading mr-2"></i> Đặt hàng nhập</h4>
    
    <div class="btn-header-group d-flex d-md-none">
        
        <button class="btn btn-white-green-text">
            <i class="fas fa-plus"></i> Đặt hàng nhập
        </button>

        <button class="btn btn-white-green-text">
            <i class="fas fa-download"></i>
        </button>
        <button class="btn btn-white-green-text">
            <i class="fas fa-cog"></i>
        </button>
    </div>
</div>

<section class="content">
    <div class="container-fluid pt-3">
    <div class="row">

            <div class="col-12 col-md-3 mb-3 collapse d-md-block" id="filterCollapseContent">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="font-weight-bold mb-3 text-dark">Bộ lọc Đặt hàng nhập</h5>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Chi nhánh</label>
                            <select class="form-control" id="chiNhanhFilter">
                                <option value="CN - NVC (Cần Thơ)">CN - NVC (Cần Thơ)</option>
                                <option value="Kho tổng">Kho tổng</option>
                                <option value="CN Trần Hoàng Na">CN Trần Hoàng Na</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Trạng thái</label>
                            <div class="d-flex flex-wrap" style="gap: 5px;" id="trangThaiContainer">
                                <span class="badge selectable-badge active-status" data-status="">Tất cả</span>
                                <span class="badge selectable-badge" data-status="Phiếu tạm">Phiếu tạm</span>
                                <span class="badge selectable-badge" data-status="Đã xác nhận NCC">Đã xác nhận NCC</span>
                                <span class="badge selectable-badge" data-status="Nhập một phần">Nhập một phần</span>
                                <span class="badge selectable-badge" data-status="Hoàn tất">Hoàn tất</span>
                                <span class="badge selectable-badge" data-status="Hủy">Hủy</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Thời gian</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="thoigian" id="thangnay" value="month" checked>
                                <label class="form-check-label text-dark" for="thangnay">Tháng này</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="thoigian" id="tuychinh" value="custom">
                                <label class="form-check-label text-dark" for="tuychinh">Tùy chỉnh</label>
                            </div>
                            <input type="date" class="form-control" id="dateFilter" style="display:none;" /> 
                        </div>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Người tạo</label>
                            <select class="form-control" id="nguoiTaoFilter">
                                <option value="">Chọn người tạo</option>
                                <option value="Nguyễn Văn A">Nguyễn Văn A</option>
                                <option value="Trần Thị B">Trần Thị B</option>
                                <option value="Lê Văn C">Lê Văn C</option>
                            </select>
                        </div>
                        <button class="btn btn-success btn-block font-weight-bold mt-3" id="applyFilter">
                            <i class="fas fa-filter"></i> Áp dụng bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                
                <div class="d-flex align-items-center mb-3">
                    <div class="input-group flex-grow-1 mr-2">
                        <input type="text" class="form-control" id="searchInput" placeholder="Theo mã phiếu đặt hàng nhập..." />
                        <div class="input-group-append">
                            <button class="btn btn-success" id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-secondary d-md-none" 
                            type="button" 
                            data-toggle="collapse" 
                            data-target="#filterCollapseContent"
                            aria-expanded="false" 
                            aria-controls="filterCollapseContent">
                        <i class="fas fa-filter"></i> 
                    </button>
                    
                    <div class="ml-auto d-none d-md-flex">
                        <button class="btn btn-success font-weight-bold mr-2">
                            <i class="fas fa-plus"></i> Đặt hàng nhập
                        </button>
                        <button class="btn btn-outline-success mr-2">
                            <i class="fas fa-download"></i> Xuất file
                        </button>
                        <button class="btn btn-outline-secondary">
                            <i class="fas fa-cog"></i> Cài đặt
                        </button>
                    </div>

                </div>
                <div class="card shadow-sm border-0">
                    <div class="card-header font-weight-bold bg-success text-white">
                        Danh sách phiếu đặt hàng nhập
                    </div>
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="phieuDatHangTable">
                            <thead class="bg-success text-white">
                                <tr><th><input type="checkbox" id="selectAll" /></th>
                                    <th>Mã đặt hàng nhập</th>
                                    <th>Thời gian</th>
                                    <th>Nhà cung cấp</th>
                                    <th>Ngày nhập dự kiến</th>
                                    <th>Số ngày chờ</th>
                                    <th>Cần trả NCC</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-status="Phiếu tạm" data-chinhanh="CN - NVC (Cần Thơ)" data-nguoitao="Nguyễn Văn A">
                                    <td><input type="checkbox" /></td>
                                    <td>PO00452</td>
                                    <td>03/11/2025 15:32</td>
                                    <td>VIPOMALL</td>
                                    <td>05/11/2025</td>
                                    <td>2</td>
                                    <td>12,600,000 ₫</td>
                                    <td><span class="badge badge-secondary">Phiếu tạm</span></td>
                                </tr>
                                <tr data-status="Đã xác nhận NCC" data-chinhanh="Kho tổng" data-nguoitao="Trần Thị B">
                                    <td><input type="checkbox" /></td>
                                    <td>PO00451</td>
                                    <td>02/11/2025 14:10</td>
                                    <td>SAKI</td>
                                    <td>03/11/2025</td>
                                    <td>1</td>
                                    <td>24,000,000 ₫</td>
                                    <td><span class="badge badge-primary">Đã xác nhận NCC</span></td>
                                </tr>
                                <tr data-status="Hoàn tất" data-chinhanh="CN - NVC (Cần Thơ)" data-nguoitao="Lê Văn C">
                                    <td><input type="checkbox" /></td>
                                    <td>PO00449</td>
                                    <td>01/11/2025 10:40</td>
                                    <td>EBIKE PHỤ TÙNG</td>
                                    <td>02/11/2025</td>
                                    <td>0</td>
                                    <td>18,450,000 ₫</td>
                                    <td><span class="badge badge-success">Hoàn tất</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center py-5 text-muted" id="noResults" style="display:none;">
                        <i class="fas fa-inbox fa-3x text-secondary"></i>
                        <p class="mt-2">Không tìm thấy kết quả<br /><a href="#" class="text-dark font-weight-bold">Nhấn vào đây</a> để tiếp tục tìm kiếm.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {

            // Mặc định ẩn ô nhập ngày
            $('#dateFilter').hide();

            // 1. Toggle hiển thị ô nhập ngày
            $('input[name="thoigian"]').change(function () {
                if ($(this).val() === 'custom') {
                    $('#dateFilter').show();
                } else {
                    $('#dateFilter').hide();
                    $('#dateFilter').val(''); 
                }
            });
            
            // 2. Xử lý logic chọn/bỏ chọn cho các trạng thái (Selectable Badges)
            $('.selectable-badge').click(function () {
                $('.selectable-badge').removeClass('active-status');
                $(this).addClass('active-status');
            });
            
            // 3. Xử lý logic đóng bộ lọc sau khi áp dụng trên mobile/tablet
            $('#applyFilter').click(function () {
                if ($(window).width() < 768) {
                    $('#filterCollapseContent').collapse('hide');
                }
                performFilter();
            });

            // 4. Tìm kiếm theo mã phiếu
            $('#searchBtn').click(function () {
                performSearch();
            });

            $('#searchInput').on('keyup', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            function performSearch() {
                var keyword = $('#searchInput').val().toLowerCase().trim();
                var resultsFound = 0;

                $('#phieuDatHangTable tbody tr').each(function () {
                    var code = $(this).find('td:eq(1)').text().toLowerCase(); 
                    
                    if (code.includes(keyword)) {
                        $(this).show();
                        resultsFound++;
                    } else {
                        $(this).hide();
                    }
                });

                if (resultsFound === 0) {
                    $('#noResults').show();
                    $('#phieuDatHangTable').hide();
                } else {
                    $('#noResults').hide();
                    $('#phieuDatHangTable').show();
                }
            }

            // 5. Hàm thực hiện lọc dữ liệu
            function performFilter() {
                var selectedStatus = $('.selectable-badge.active-status').data('status') || '';
                var selectedChiNhanh = $('#chiNhanhFilter').val();
                var selectedNguoiTao = $('#nguoiTaoFilter').val();
                var selectedDate = $('input[name="thoigian"]:checked').val() === 'custom' ? $('#dateFilter').val() : '';var visibleRows = 0;

                $('#phieuDatHangTable tbody tr').each(function () {
                    var row = $(this);
                    var rowStatus = row.data('status');
                    var rowChiNhanh = row.data('chinhanh');
                    var rowNguoiTao = row.data('nguoitao');
                    var rowNgayDuKien = row.find('td:eq(4)').text().trim(); 

                    var showRow = true;

                    // Lọc 1: Trạng thái 
                    if (selectedStatus && rowStatus !== selectedStatus) {
                        showRow = false;
                    }

                    // Lọc 2: Chi nhánh
                    if (selectedChiNhanh && rowChiNhanh !== selectedChiNhanh) { 
                        showRow = false; 
                    }

                    // Lọc 3: Người tạo
                    if (selectedNguoiTao && rowNguoiTao !== selectedNguoiTao) { 
                        showRow = false; 
                    }
                    
                    // Lọc 4: Ngày nhập dự kiến
                    if (selectedDate) {
                        var formattedDateFilter = selectedDate.split('-').reverse().join('/');
                        if (rowNgayDuKien !== formattedDateFilter) {
                           showRow = false;
                        }
                    }

                    if (showRow) {
                        row.show();
                        visibleRows++;
                    } else {
                        row.hide();
                    }
                });

                if (visibleRows === 0) {
                    $('#noResults').show();
                    $('#phieuDatHangTable').hide();
                } else {
                    $('#noResults').hide();
                    $('#phieuDatHangTable').show();
                }
            }
            
            // 6. Toggle chọn tất cả
            $('#selectAll').click(function () {
                $('#phieuDatHangTable tbody input[type="checkbox"]').prop('checked', this.checked);
            });
        });
    </script>
}
// Dấu ngoặc nhọn đóng này đã được thêm vào
// để khắc phục lỗi RZ1006.