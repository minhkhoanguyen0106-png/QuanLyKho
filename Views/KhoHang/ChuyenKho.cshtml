@{
    ViewBag.Title = "Chuyển kho";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<style>
    /* 1. HEADER MOBILE & CSS CHUNG */
    .app-header {
        background-color: #28a745; 
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between; 
        align-items: center;
        position: sticky; top: 0; z-index: 1000;
    }

    .app-header .btn-header-group { display: flex; align-items: center; }
    .app-header .btn-white-green-text {
        color: #28a745 !important; background-color: white !important;
        border: 1px solid white !important; font-weight: bold;
        margin-left: 5px; padding: 0.25rem 0.5rem; font-size: 0.8rem;
        display: inline-flex; align-items: center; justify-content: center;
    }

    /* 2. BADGE TRẠNG THÁI (TỰ CO GIÃN) */
    #trangThaiContainer { display: flex; flex-wrap: wrap; gap: 5px; }
    .selectable-badge {
        display: flex; align-items: center; justify-content: center;
        width: auto !important; flex-grow: 1; height: 35px; padding: 0 10px;
        cursor: pointer; transition: all 0.2s ease-in-out; white-space: nowrap; 
        background-color: white !important; color: #212529 !important; 
        border: 1px solid #28a745; border-radius: 4px; font-size: 13px;
    }
    .selectable-badge:hover { background-color: #f1f8f2 !important; }
    .selectable-badge.active-status {
        background-color: #28a745 !important; color: white !important;
        font-weight: bold; border-color: #28a745;
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); 
    }

    /* 3. NÚT BẤM THẲNG HÀNG (ACTION BUTTONS) */
    .action-buttons { display: flex; align-items: center; gap: 5px; height: 100%; }
    .action-buttons .btn {
        white-space: nowrap !important; height: 38px;
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 90px; font-weight: 600; border-radius: 5px; padding: 0 12px;
    }

    #searchInput { height: 38px; }
    .input-group-append .btn {
        height: 38px; display: flex; align-items: center; justify-content: center;
        padding-top: 0; padding-bottom: 0;
    }

    /* 4. RESPONSIVE */
    @@media (max-width: 767.98px) {
        .app-header h4 { max-width: 50%; font-size: 1.1rem; }
        .app-header .btn-header-group { overflow-x: auto; white-space: nowrap; justify-content: flex-end; }
        .action-buttons .btn { font-size: 0.8rem; padding: 0 8px; }
        .input-group + .btn.d-md-none { padding: 0.375rem 0.75rem; }
    }
    @@media (min-width: 768px) { .app-header { display: none !important; } }

    /* 5. CSS KHI IN ẤN (ẨN MENU) */
    @@media print {
        .app-header, .main-sidebar, .main-header, .action-buttons, #filterCollapseContent, #searchBtn, #searchInput, .main-footer, .card-header, #selectAll {
            display: none !important;
        }
        .content-wrapper { margin-left: 0 !important; padding-top: 0 !important; background: white !important; }
        .card { box-shadow: none !important; border: none !important; }
        table { width: 100% !important; border-collapse: collapse !important; }
        th, td { border: 1px solid #000 !important; padding: 5px !important; color: #000 !important; }
    }
</style>

<div class="app-header">
    <h4 class="m-0 font-weight-bold"><i class="fas fa-exchange-alt mr-2"></i> Chuyển kho</h4>
    <div class="btn-header-group d-flex d-md-none">
        <a href="/KhoHang/ChonKhoDeChuyen" class="btn btn-white-green-text"><i class="fas fa-plus"></i></a>
        <button class="btn btn-white-green-text" id="btnPrintMobile"><i class="fas fa-print"></i></button>
        <button class="btn btn-white-green-text" id="btnExportMobile"><i class="fas fa-file-excel"></i></button>
    </div>
</div>

<section class="content">
    <div class="container-fluid pt-3">
        <div class="d-none d-md-flex justify-content-between align-items-center mb-3">
            <h3 class="font-weight-bold text-dark m-0">Chuyển kho</h3>
        </div>

        <div class="row">
            <div class="col-12 col-md-3 mb-3 collapse d-md-block" id="filterCollapseContent">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="font-weight-bold mb-3 text-dark">Bộ lọc Chuyển hàng</h5>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Kho chuyển (Đi)</label>
                            <select class="form-control" id="khoDiFilter">
                                <option value="">Tất cả chi nhánh</option>
                                <option value="Kho hàng bán">Kho hàng bán</option>
                                <option value="CN Nguyễn Văn Cừ">CN Nguyễn Văn Cừ</option>
                                <option value="CN Trần Hoàng Na">CN Trần Hoàng Na</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Kho nhận (Đến)</label>
                            <select class="form-control" id="khoDenFilter">
                                <option value="">Tất cả chi nhánh</option>
                                <option value="CN Nguyễn Văn Cừ">CN Nguyễn Văn Cừ</option>
                                <option value="Kho hàng bán">Kho hàng bán</option>
                                <option value="CN Trần Hoàng Na">CN Trần Hoàng Na</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Trạng thái</label>
                            <div id="trangThaiContainer">
                                <span class="selectable-badge active-status" data-status="">Tất cả</span>
                                <span class="selectable-badge" data-status="Phiếu tạm">Phiếu tạm</span>
                                <span class="selectable-badge" data-status="Đang chuyển">Đang chuyển</span>
                                <span class="selectable-badge" data-status="Đã nhận">Đã nhận</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Thời gian</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="thoigian" id="thangnay" value="month" checked>
                                <label class="form-check-label text-dark" for="thangnay">Tháng này</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="thoigian" id="tuychinh" value="custom">
                                <label class="form-check-label text-dark" for="tuychinh">Tùy chỉnh</label>
                            </div>
                            <input type="date" class="form-control" id="dateFilter" style="display:none;" /> 
                        </div>

                        <button class="btn btn-success btn-block font-weight-bold mt-3" id="applyFilter">
                            <i class="fas fa-filter"></i> Áp dụng bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="d-flex align-items-center mb-3">
                    <div class="input-group flex-grow-1 mr-2">
                        <input type="text" class="form-control" id="searchInput" placeholder="Theo mã phiếu chuyển..." />
                        <div class="input-group-append">
                            <button class="btn btn-success" id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-secondary d-md-none" type="button" data-toggle="collapse" data-target="#filterCollapseContent">
                        <i class="fas fa-filter"></i> 
                    </button>
                    
                    <div class="ml-auto d-none d-md-flex action-buttons">
                        <a href="/KhoHang/ChonKhoDeChuyen" class="btn btn-success font-weight-bold">
                            <i class="fas fa-plus mr-1"></i> Chọn kho để chuyển
                        </a>
                        
                        <button class="btn btn-outline-success" id="btnPrint">
                            <i class="fas fa-print"></i> In danh sách
                        </button>
                        
                        <button class="btn btn-outline-secondary" id="btnExport">
                            <i class="fas fa-file-excel"></i> Xuất file
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header font-weight-bold bg-success text-white">
                        Danh sách phiếu chuyển
                    </div>
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center" id="chuyenKhoTable">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th><input type="checkbox" id="selectAll" /></th>
                                    <th>Mã phiếu</th>
                                    <th>Ngày chuyển</th>
                                    <th>Ngày nhận</th>
                                    <th>Từ chi nhánh</th>
                                    <th>Tới chi nhánh</th>
                                    <th>Giá trị</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-status="Đang chuyển">
                                    <td><input type="checkbox" /></td>
                                    <td>TRF004454</td>
                                    <td>03/11/2025 16:48</td>
                                    <td>-</td>
                                    <td>Kho hàng bán</td>
                                    <td>CN Nguyễn Văn Cừ - Cần Thơ</td>
                                    <td>25,187,900</td>
                                    <td><span class="badge badge-primary">Đang chuyển</span></td>
                                </tr>
                                <tr data-status="Đã nhận">
                                    <td><input type="checkbox" /></td>
                                    <td>TRF004453</td>
                                    <td>03/11/2025 16:40</td>
                                    <td>03/11/2025 19:25</td>
                                    <td>CN Nguyễn Văn Cừ - Cần Thơ</td>
                                    <td>CN Trần Hoàng Na - Cần Thơ</td>
                                    <td>18,600,004</td>
                                    <td><span class="badge badge-success">Đã nhận</span></td>
                                </tr>
                                <tr data-status="Đã nhận">
                                    <td><input type="checkbox" /></td>
                                    <td>TRF004450</td>
                                    <td>02/11/2025 16:39</td>
                                    <td>02/11/2025 16:46</td>
                                    <td>CN Trần Hoàng Na</td>
                                    <td>CN Nguyễn Văn Cừ</td>
                                    <td>12,060,000</td>
                                    <td><span class="badge badge-success">Đã nhận</span></td>
                                </tr>
                                <tr data-status="Phiếu tạm">
                                    <td><input type="checkbox" /></td>
                                    <td>TRF004449</td>
                                    <td>02/11/2025 13:11</td>
                                    <td>-</td>
                                    <td>CN Trần Hoàng Na</td>
                                    <td>CN Nguyễn Văn Cừ</td>
                                    <td>11,621,720</td>
                                    <td><span class="badge badge-secondary">Phiếu tạm</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center py-5 text-muted" id="noResults" style="display:none;">
                        <i class="fas fa-inbox fa-3x text-secondary"></i>
                        <p class="mt-2">Không tìm thấy kết quả</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            // --- 1. XỬ LÝ NÚT IN & EXPORT (Desktop + Mobile) ---
            $('#btnPrint, #btnPrintMobile').click(function() {
                window.print();
            });

            $('#btnExport, #btnExportMobile').click(function() {
                var table = document.getElementById("chuyenKhoTable");
                var html = table.outerHTML;
                var blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.download = "DanhSachChuyenKho.xls";
                link.href = url;
                link.click();
            });

            // --- 2. XỬ LÝ GIAO DIỆN KHÁC (Giữ nguyên) ---
            $('#dateFilter').hide();
            $('input[name="thoigian"]').change(function () {
                if ($(this).val() === 'custom') $('#dateFilter').slideDown();
                else { $('#dateFilter').slideUp(); $('#dateFilter').val(''); }
            });

            $('.selectable-badge').click(function () {
                if($(this).hasClass('active-status') && $(this).data('status') !== "") {
                     $(this).removeClass('active-status');
                     $('.selectable-badge[data-status=""]').addClass('active-status');
                } else {
                    $('.selectable-badge').removeClass('active-status');
                    $(this).addClass('active-status');
                }
            });

            $('#applyFilter').click(function () {
                if ($(window).width() < 768) $('#filterCollapseContent').collapse('hide');
                performFilter();
            });

            $('#searchBtn').click(function () { performSearch(); });
            $('#searchInput').keyup(function (e) { if (e.key === 'Enter') performSearch(); });

            function performSearch() {
                var keyword = $('#searchInput').val().toLowerCase().trim();
                $('#chuyenKhoTable tbody tr').each(function () {
                    var code = $(this).find('td:eq(1)').text().toLowerCase();
                    $(this).toggle(code.includes(keyword));
                });
            }

            function performFilter() {
                var status = $('.selectable-badge.active-status').data('status');
                var khoDi = $('#khoDiFilter').val();
                var khoDen = $('#khoDenFilter').val();
                var timeType = $('input[name="thoigian"]:checked').val();
                var selectedDate = $('#dateFilter').val(); 
                var now = new Date();
                var hasRow = false;

                $('#chuyenKhoTable tbody tr').each(function () {
                    var row = $(this);
                    var rStatus = row.data('status');
                    var rKhoDi = row.find('td:eq(4)').text();
                    var rKhoDen = row.find('td:eq(5)').text();
                    var dateText = row.find('td:eq(2)').text().trim().split(' ')[0];
                    var parts = dateText.split('/');
                    var rDate = new Date(parts[2], parts[1]-1, parts[0]);

                    var show = true;
                    if (status && rStatus !== status) show = false;
                    if (khoDi && !rKhoDi.includes(khoDi)) show = false;
                    if (khoDen && !rKhoDen.includes(khoDen)) show = false;

                    if (show) {
                        if (timeType === 'month') {
                            if (rDate.getMonth() !== now.getMonth() || rDate.getFullYear() !== now.getFullYear()) show = false;
                        } else if (timeType === 'custom' && selectedDate) {
                            var filterDate = new Date(selectedDate);
                            if (rDate.setHours(0,0,0,0) !== filterDate.setHours(0,0,0,0)) show = false;
                        }
                    }

                    if(show) { row.show(); hasRow = true; } else { row.hide(); }
                });

                hasRow ? $('#noResults').hide() : $('#noResults').show();
            }

            $('#selectAll').click(function () {
                $('#chuyenKhoTable tbody input[type="checkbox"]').prop('checked', this.checked);
            });

            performFilter();
        });
    </script>
}