@{
    ViewBag.Title = "Qu·∫£n l√Ω kho";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    /* S·ª≠ d·ª•ng bi·∫øn CSS ƒë·ªÉ qu·∫£n l√Ω m√†u s·∫Øc nh·∫•t qu√°n, ƒê·ªíNG B·ªò V·ªöI NCC: #28a745 */
    :root {
        --primary-green-dark: #28a745; 
        --table-header-bg: white; 
        --table-header-color: #4a4a4a; 
        --background-color: #f7fcf7;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e1e1e1; /* Vi·ªÅn nh·∫π h∆°n */
        --action-blue: #007bff; /* M√†u xanh d∆∞∆°ng cho ph√¢n trang/n√∫t xu·∫•t file */
        --light-green-border: #28a745; /* Vi·ªÅn nh·∫π h∆°n cho input */
    }

    /* ====== M√ÄU V√Ä GIAO DI·ªÜN CHUNG ====== */
    body {
        background-color: var(--background-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
     .text-success, h4.text-success, h5.text-success, .filter-label {
        color: var(--primary-green-dark) !important;
    }
    .btn-xanhbo {
        background-color: var(--primary-green-dark);
        color: #fff;
        border: none;
        transition: 0.3s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-xanhbo:hover {
        background-color: #218838; 
        color: #fff;
    }
    
    /* N√∫t Xu·∫•t file (ƒê·ªìng b·ªô v·ªõi NCC) */
    .btn-action-blue {
        background-color: var(--action-blue);
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-action-blue:hover {
        background-color: #0069d9;
        color: #fff;
    }

    .text-success, h4.text-success, .filter-label {
        color: var(--primary-green-dark) !important;
    }
    h4.text-success {
        color: #4a4a4a !important; /* ƒê·ªïi m√†u ti√™u ƒë·ªÅ ch√≠nh */
    }

    /* ====== KHUNG L·ªåC (filter-card) ====== */
    .filter-card {
        background-color: #fff;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        padding: 18px;
        border: 1px solid var(--border-color);
    }
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
        color: #555; /* M√†u ch·ªØ label ƒë·ªìng b·ªô */ 
    }

    .form-control, .form-select {
        border-radius: 6px;
        font-size: 14px;
        border-color: var(--light-green-border);
    }
    
    /* Focus */
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25);
        border-color: var(--primary-green-dark);
    }

    /* ====== THANH T√åM KI·∫æM + N√öT (action-bar) ====== */
    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
    }
    #globalSearchBox {
        font-size: 14px;
    }

    /* ====== B·∫¢NG D·ªÆ LI·ªÜU ====== */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden; 
        border: 1px solid var(--border-color);
    }
    .table th {
        background-color: var(--table-header-bg) !important;
        color: var(--table-header-color);
        font-weight: 600;
        font-size: 13px; /* ƒê·ªìng b·ªô font size */
        border-bottom: 2px solid #ddd !important;
        border-top: none !important;
        padding: 10px 8px;
    }
    
    .table td {
        font-size: 13px; /* ƒê·ªìng b·ªô font size */
        border-top: 1px solid #f0f0f0;
        vertical-align: middle;
        padding: 8px;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f5fff5; 
    }

    /* ƒê·ªäNH D·∫†NG DATATABLES PH√ÇN TRANG (ƒê·ªìng b·ªô v·ªõi NCC) */
    .dataTables_paginate .paginate_button.current, 
    .dataTables_paginate .paginate_button.current:hover {
        background: var(--action-blue) !important; 
        color: white !important;
        border-color: var(--action-blue) !important;
        border-radius: 4px;
    }
    .dataTables_paginate .paginate_button {
        border-radius: 4px;
        padding: 5px 10px;
    }
    
    /* Modal Header */
    #newPartModal .modal-header {
        background-color: var(--primary-green-dark) !important;
        color: white;
        border-bottom: none;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    .modal-title {
        font-weight: 600;
    }
    /* Badge cho nh√≥m linh ki·ªán (ƒê·ªìng b·ªô v·ªõi badge linh ki·ªán c·ªßa trang tr∆∞·ªõc) */
    .badge-linhkien-group { 
        background-color: var(--primary-green-dark); /* M√†u xanh l√° ƒë·∫≠m */
        color: white; 
        padding: 5px 8px; 
        border-radius: 4px; 
        font-size: 11px;
        font-weight: 500;
    }
    /* ƒêi·ªÅu ch·ªânh style icon s·ª≠a ƒë·ªÉ nh√¨n gi·ªëng n√∫t h∆°n */
    .btn-action-edit {
        background-color: var(--primary-green-dark); /* M√†u xanh l√° */
        color: white;
        border-radius: 4px;
        padding: 5px 8px;
        font-size: 13px;
        transition: background-color 0.2s;
    }
    .btn-action-edit:hover {
        background-color: #218838;
        color: white;
    }

</style>

<div class="container-fluid mt-4">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <h5 class="mb-3 text-success fw-bold"><i class="fa-solid fa-filter"></i> B·ªô l·ªçc Linh ki·ªán</h5>

                <div class="mb-3">
                    <label class="filter-label" for="filterGroup">Nh√≥m linh ki·ªán</label>
                    <select id="filterGroup" class="form-select">
                        <option value="">T·∫•t c·∫£ nh√≥m linh ki·ªán</option>
                        <option>·∫Æc quy</option>
                        <option>ƒê·ªông c∆°</option>
                        <option>Phanh - th·∫Øng</option>
                        <option>Khung s∆∞·ªùn</option>
                        <option>Kh√°c</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="filterStock">T·ªìn kho</label>
                    <select id="filterStock" class="form-select">
                        <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                        <option value="available">C√≤n h√†ng</option>
                        <option value="outOfStock">H·∫øt h√†ng</option>
                    </select>
                </div>
                
            </div>
        </div>

        <div class="col-lg-9">
            <h4 class="fw-bold text-success mb-3">
                <i class="fa-solid fa-boxes-stacked"></i> Kho linh ki·ªán
            </h4>
            
            <div class="action-bar mb-3 d-flex justify-content-between flex-wrap align-items-center"> 
                <input type="text" id="globalSearchBox" class="form-control me-2" placeholder="üîç Theo m√£, t√™n linh ki·ªán/h√†ng h√≥a..." style="width: 250px;">
                
                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <button class="btn btn-xanhbo" data-bs-toggle="modal" data-bs-target="#newPartModal">
                        <i class="fa fa-plus"></i> T·∫°o m·ªõi
                    </button>
                    <button class="btn btn-action-blue" onclick="alert('Ch·ª©c nƒÉng Xu·∫•t file ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh.');">
                        <i class="fa-solid fa-file-export"></i> Xu·∫•t file
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="partsTable" class="table table-hover bg-white" style="width:100%">
                    <thead class="text-center">
                        <tr>
                            <th>M√£ linh ki·ªán</th>
                            <th>T√™n linh ki·ªán</th> 
                            <th>Nh√≥m linh ki·ªán</th> 
                            <th>Gi√° b√°n</th> 
                            <th>Gi√° v·ªën</th> 
                            <th>T·ªìn kho</th> 
                            <th>Kh√°ch ƒë·∫∑t</th> 
                            <th>Th·ªùi gian t·∫°o</th> 
                            <th>ƒê·∫∑t NCC</th> 
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info" id="partsTable_info" role="status" aria-live="polite"></div>
                <div class="dataTables_paginate paging_simple_numbers" id="partsTable_paginate"></div>
            </div>

        </div> </div> </div> <div class="modal fade" id="newPartModal" tabindex="-1" aria-labelledby="newPartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newPartModalLabel"><i class="fa fa-plus"></i> Th√™m Linh Ki·ªán M·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPartForm">
                    <div class="mb-3">
                        <label for="partName" class="form-label">T√™n linh ki·ªán <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="partName" required>
                    </div>
                    <div class="mb-3">
                        <label for="partCode" class="form-label">M√£ linh ki·ªán (ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông t·∫°o)</label>
                        <input type="text" class="form-control" id="partCode">
                    </div>
                    <div class="mb-3">
                        <label for="partGroup" class="form-label">Nh√≥m linh ki·ªán</label>
                        <select class="form-select" id="partGroup" required>
                            <option value="·∫Æc quy">·∫Æc quy</option>
                            <option value="ƒê·ªông c∆°">ƒê·ªông c∆°</option>
                            <option value="Phanh - th·∫Øng">Phanh - th·∫Øng</option>
                            <option value="Khung s∆∞·ªùn">Khung s∆∞·ªùn</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sellPrice" class="form-label">Gi√° b√°n (‚Ç´)</label>
                            <input type="number" class="form-control" id="sellPrice" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="costPrice" class="form-label">Gi√° v·ªën (‚Ç´)</label>
                            <input type="number" class="form-control" id="costPrice" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="initialStock" class="form-label">T·ªìn kho ban ƒë·∫ßu</label>
                        <input type="number" class="form-control" id="initialStock" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-xanhbo" onclick="handleNewPartSubmit()">L∆∞u Linh Ki·ªán</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ===========================================
    // 1. ƒê·ªäNH NGHƒ®A H·∫∞NG S·ªê CH·ªà S·ªê C·ªòT (0-indexed)
    // ===========================================
    var table; // Bi·∫øn table c·∫ßn l√† global
    const CODE_COL = 0;
    const GROUP_COL = 2;
    const SELL_PRICE_COL = 3;
    const COST_PRICE_COL = 4;
    const STOCK_COL = 5;
    const CREATED_DATE_COL = 7;
    const ACTION_COL = 9;

    // ===========================================
    // 2. H√ÄM PH·ª§ TR·ª¢ (Currency, Filter Logic, Date)
    // ===========================================
    function formatCurrency(number) {
        const num = parseInt(number) || 0;
        return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND', minimumFractionDigits:0}).format(num).replace('‚Ç´', 'ƒë'); 
    }

    function formatDate(data) {
        if (!data) return '';
        const date = new Date(data);
        // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa ng√†y th√°ng
        if (isNaN(date.getTime())) return data; 
        // ƒê·ªãnh d·∫°ng: dd/mm/yyyy hh:mm
        return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN').substring(0,5); 
    }

    function applyGroupFilter(groupValue) {
        // √Åp d·ª•ng filter b·∫±ng regex ƒë·ªÉ l·ªçc ch√≠nh x√°c gi√° tr·ªã
        table.column(GROUP_COL).search(groupValue ? '^'+groupValue+'$' : '', true, false).draw();
    }

    function triggerCustomFilters() { 
        table.draw(); 
    }
    
    function openEditModal(maHang) {
        alert('Ch·ª©c nƒÉng Ch·ªânh s·ª≠a cho M√£: ' + maHang + ' ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh. (ƒê√£ g·ªçi openEditModal)');
    }

    function deleteProduct(maHang) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a linh ki·ªán c√≥ M√£: ${maHang}? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
        return; 
    }
    
    $.ajax({
        url: '/HangHoa/DeleteAjax', // D√πng chung API x√≥a v·ªõi H√†ng h√≥a
        type: 'POST', 
        contentType: 'application/json',
        data: JSON.stringify({ MaHang: maHang }), // Truy·ªÅn M√£ h√†ng (linh ki·ªán) ƒë·ªÉ x√≥a
        success: function(res) {
            if (res.success) {
                alert(`ƒê√£ x√≥a linh ki·ªán [${maHang}] th√†nh c√¥ng kh·ªèi h·ªá th·ªëng!`);
                
                // 2. T·∫£i l·∫°i DataTables ƒë·ªÉ x√≥a linh ki·ªán kh·ªèi giao di·ªán
                table.ajax.reload(null, false); 
            } else {
                alert("X√≥a linh ki·ªán th·∫•t b·∫°i! L·ªói: " + (res.message || 'Kh√¥ng r√µ.'));
            }
        },
        error: function(xhr) {
            console.error("L·ªói AJAX khi x√≥a:", xhr.responseText);
            alert('C√≥ l·ªói Server khi th·ª±c hi·ªán x√≥a linh ki·ªán.');
        }
    });
}
    function handleNewPartSubmit() {
        const name = $('#partName').val().trim();
        if (!name) { alert("Vui l√≤ng nh·∫≠p T√™n linh ki·ªán."); return; }

        // L·∫•y d·ªØ li·ªáu form
        const data = {
            MaHang: $('#partCode').val().trim(),
            TenHang: name,
            LoaiHang: $('#partGroup').val(),
            GiaBan: parseInt($('#sellPrice').val()) || 0,
            GiaVon: parseInt($('#costPrice').val()) || 0,
            TonKho: parseInt($('#initialStock').val()) || 0,
            KhachDat: 0, 
            DatNCC: 0 
        };
        
        // G·ª≠i d·ªØ li·ªáu l√™n Server
        $.ajax({
            url: "/HangHoa/Create", 
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(res) {
                if (res.success) {
                    alert(`ƒê√£ th√™m linh ki·ªán "${data.TenHang}" th√†nh c√¥ng! M√£: ${res.maHang}`);
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newPartModal'));
                    modal.hide();
                    $('#addPartForm')[0].reset();
                    
                    table.ajax.reload(null, false); 
                } else {
                    alert('Th√™m linh ki·ªán th·∫•t b·∫°i. L·ªói: ' + (res.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'));
                }
            },
            error: function(xhr) {
                console.error("L·ªói AJAX:", xhr.responseText);
                alert('L·ªói k·∫øt n·ªëi Server khi th√™m linh ki·ªán.');
            }
        });
    }

    // ===========================================
    // 4. KH·ªûI T·∫†O DATATABLES
    // ===========================================
    $(document).ready(function() {
        table = $('#partsTable').DataTable({
            // üõ†Ô∏è C·∫•u h√¨nh AJAX ƒë·ªÉ t·∫£i d·ªØ li·ªáu
            ajax:{
                url: "/HangHoa/GetAllLinhKien", // G·ªçi Action trong Controller
                dataSrc: ""
            },
            // üõ†Ô∏è ƒê·ªãnh nghƒ©a c√°c c·ªôt
            columns:[
                { data:"maHang", className:"text-center" }, ¬† ¬† 
                { data:"tenHang", className:"text-start" }, ¬† ¬†
                { data:"loaiHang", className:"text-center" }, ¬† 
                { data:"giaBan", className:"text-end" }, ¬† ¬† ¬† ¬†
                { data:"giaVon", className:"text-end" }, ¬† ¬† ¬† ¬†
                { data:"tonKho", className:"text-center" }, ¬† ¬† 
                { data:"khachDat", className:"text-center" }, ¬† 
                { data:"thoiGianTao", className:"text-center" }, 
                { data:"datNCC", className:"text-center" }, ¬† ¬† 
                // C·ªôt Thao t√°c
                { data:"maHang", orderable:false, searchable:false, className:"text-center" }
            ],
            
            // C·∫•u h√¨nh DOM, Order, Language
            dom:'rtip',
            order:[[STOCK_COL,'desc']],
            language: {
                sProcessing: "ƒêang x·ª≠ l√Ω...",
                sLengthMenu: "Xem _MENU_ m·ª•c",
                sZeroRecords: "Kh√¥ng t√¨m th·∫•y linh ki·ªán n√†o ph√π h·ª£p",
                sInfo: "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng s·ªë _TOTAL_ m·ª•c",
                sInfoEmpty: "Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong t·ªïng s·ªë 0 m·ª•c",
                sInfoFiltered: "(ƒë∆∞·ª£c l·ªçc t·ª´ t·ªïng s·ªë _MAX_ m·ª•c)",
                sSearch: "T√¨m ki·∫øm:",
                oPaginate: { sFirst:"ƒê·∫ßu", sLast:"Cu·ªëi", sNext:"Ti·∫øp", sPrevious:"Tr∆∞·ªõc" }
            },
            columnDefs: [
                // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
                { targets:[SELL_PRICE_COL, COST_PRICE_COL], render:function(data,type){ const num=parseInt(data)||0; return (type==='display'||type==='filter')?formatCurrency(num):num; }, className:'text-end' },
                
                // ƒê·ªãnh d·∫°ng Nh√≥m linh ki·ªán (D√πng badge xanh l√° ƒë·∫≠m ƒë·ªìng b·ªô)
                { 
                    targets:GROUP_COL, 
                    render:function(data,type){ 
                        if(type==='display') return `<span class="badge badge-linhkien-group">${data}</span>`; 
                        return data; 
                    }, 
                    className:'text-center' 
                },
                // ƒê·ªãnh d·∫°ng T√™n h√†ng (Ch·ªâ ƒë·ªÉ cho ch·∫Øc ch·∫Øn)
                { targets:1, className:'text-start' },
                
                // ƒê·ªãnh d·∫°ng Th·ªùi gian t·∫°o
                { 
                    targets:CREATED_DATE_COL,
                    render: function(data, type) {
                        return (type === 'display') ? formatDate(data) : data;
                    }
                },
                
                // C·ªôt Thao t√°c (ƒê·ªìng b·ªô v·ªõi trang H√†ng h√≥a)
                { 
                    targets:ACTION_COL, 
                    orderable:false, 
                    searchable:false, 
                    render: function(d){
                        return `
                            <div class="d-flex justify-content-center gap-2">
                                <a href="javascript:void(0)" onclick="openEditModal('${d}')" class="btn btn-sm btn-xanhbo" title="Ch·ªânh s·ª≠a"><i class="fa-solid fa-pen-to-square"></i></a>
                                <a href="javascript:void(0)" onclick="deleteProduct('${d}')" class="btn btn-sm btn-danger" title="X√≥a linh ki·ªán"><i class="fa-solid fa-trash"></i></a>
                            </div>
                        `;
                    }
                }
            ]
        });

        // Custom Filter t·ªìn kho
        $.fn.dataTable.ext.search.push(function(settings,data){
            if(settings.nTable.id!=='partsTable') return true;
            const stockFilter = $('#quickFilterStock').val() || $('#filterStock').val();
            const stock = parseInt(data[STOCK_COL])||0;
            if(stockFilter==='available' && stock<=0) return false;
            if(stockFilter==='outOfStock' && stock>0) return false;
            return true;
        });

        // Sidebar Filter ƒë·ªìng b·ªô v·ªõi Quick Filter
        $('#filterGroup').on('change', function(){ const val=$(this).val(); $('#quickFilterGroup').val(val); applyGroupFilter(val); });
        $('#filterStock').on('change', function(){ const val=$(this).val(); $('#quickFilterStock').val(val); triggerCustomFilters(); });

        // Quick Filter ƒë·ªìng b·ªô v·ªõi Sidebar Filter
        $('#quickFilterGroup').on('change', function(){ const val=$(this).val(); $('#filterGroup').val(val); applyGroupFilter(val); });
        $('#quickFilterStock').on('change', function(){ const val=$(this).val(); $('#filterStock').val(val); triggerCustomFilters(); });

        // Global search
        $('#globalSearchBox').on('keyup', function(){ table.search(this.value).draw(); });
    });
</script>