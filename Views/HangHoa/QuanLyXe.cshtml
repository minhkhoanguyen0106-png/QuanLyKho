@{
    ViewBag.Title = "Qu·∫£n l√Ω h√†ng h√≥a";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    /* S·ª≠ d·ª•ng bi·∫øn CSS ƒë·ªÉ qu·∫£n l√Ω m√†u s·∫Øc nh·∫•t qu√°n */
    :root {
        --primary-green-dark: #28a745;
        --table-header-bg: white; 
        --table-header-color: #4a4a4a; 
        --background-color: #f7fcf7;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e1e1e1; /* Vi·ªÅn nh·∫π h∆°n */
        --action-blue: #007bff; /* M√†u xanh d∆∞∆°ng cho ph√¢n trang/n√∫t xu·∫•t file */
        --light-green-border: #28a745; /* M√†u xanh l√° nh·∫°t cho border input */
    }

    /* ====== M√ÄU V√Ä GIAO DI·ªÜN CHUNG ====== */
    body {
        background-color: var(--background-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

   
    .text-success, h4.text-success, h5.text-success, .filter-label {
        color: var(--primary-green-dark) !important;
    }

    /* N√∫t h√†nh ƒë·ªông ch√≠nh (T·∫°o m·ªõi, L∆∞u) */
    .btn-xanhbo {
        background-color: var(--primary-green-dark);
        color: #fff;
        border: none;
        transition: 0.3s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-xanhbo:hover {
        background-color: #218838; /* M√†u hover t·ªëi h∆°n */
        color: #fff;
    }
    
    /* N√∫t Xu·∫•t file */
    .btn-action-blue {
        background-color: var(--action-blue);
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-action-blue:hover {
        background-color: #0069d9;
        color: #fff;
    }

   
    .filter-card {
        background-color: #fff;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        padding: 18px;
        border: 1px solid var(--border-color);
    }
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
        color: #555;
    }

    /* Input/Select (Th·ªëng nh·∫•t ki·ªÉu d√°ng) */
    .form-control, .form-select {
        border-radius: 6px;
        font-size: 14px;
        border-color: var(--light-green-border);
    }
    
    /* Focus */
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25); /* Box-shadow xanh l√° */
        border-color: var(--primary-green-dark);
    }

    /* ====== THANH T√åM KI·∫æM + N√öT (action-bar) ====== */
    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
    }
    #globalSearchBox {
        font-size: 14px;
    }

    /* ====== B·∫¢NG D·ªÆ LI·ªÜU ====== */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden; 
        border: 1px solid var(--border-color);
    }
    .table th {
        background-color: var(--table-header-bg) !important;
        color: var(--table-header-color);
        font-weight: 600;
        font-size: 13px; 
        border-bottom: 2px solid #ddd !important;
        border-top: none !important;
        padding: 10px 8px;
    }
    
    .table td {
        font-size: 13px;
        border-top: 1px solid #f0f0f0;
        vertical-align: middle;
        padding: 8px;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f5fff5; 
    }
    
    /* ƒê·ªäNH D·∫†NG DATATABLES PH√ÇN TRANG */
    .dataTables_paginate .paginate_button.current, 
    .dataTables_paginate .paginate_button.current:hover {
        background: var(--action-blue) !important; 
        color: white !important;
        border-color: var(--action-blue) !important;
        border-radius: 4px;
    }
    .dataTables_paginate .paginate_button {
        border-radius: 4px;
        padding: 5px 10px;
    }
    
    /* Modal Header (Cho c·∫£ Th√™m m·ªõi v√† Ch·ªânh s·ª≠a) */
    #newItemModal .modal-header,
    #editItemModal .modal-header { /* √Åp d·ª•ng cho modal ch·ªânh s·ª≠a */
        background-color: var(--primary-green-dark) !important;
        color: white;
        border-bottom: none;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    .modal-title {
        font-weight: 600;
    }

    /* **QUAN TR·ªåNG: Override n√∫t btn-warning c≈© th√†nh m√†u xanh l√°** */
    /* √Åp d·ª•ng cho n√∫t Ch·ªânh s·ª≠a trong DataTables */
    .btn-warning.text-white {
        background-color: var(--primary-green-dark) !important;
        border-color: var(--primary-green-dark) !important;
        color: white !important;
    }
    .btn-warning.text-white:hover {
        background-color: #218838 !important;
        border-color: #1e7e34 !important;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <h5 class="mb-3 text-success fw-bold">B·ªô l·ªçc Xe</h5>

                <div class="mb-3">
                    <label class="filter-label" for="filterGroup">Nh√≥m xe</label>
                    <select id="filterGroup" class="form-select">
                        <option value="">T·∫•t c·∫£ nh√≥m</option>
                        <option>Xe m√°y ƒëi·ªán</option>
                        <option>Xe ƒë·∫°p ƒëi·ªán</option>
                        <option>Xe tay ga</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="filterStock">T·ªìn kho</label>
                    <select id="filterStock" class="form-select">
                        <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                        <option value="available">C√≤n h√†ng</option>
                        <option value="outOfStock">H·∫øt h√†ng</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <h4 class="fw-bold text-success mb-3">
                <i class="fa-solid fa-boxes-stacked"></i> Qu·∫£n l√Ω Xe
            </h4>
            <div class="action-bar mb-3 d-flex justify-content-between flex-wrap align-items-center">
                <input type="text" id="globalSearchBox" class="form-control me-2" placeholder="üîç Theo m√£, t√™n xe/h√†ng h√≥a..." style="width: 250px;">
                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <button class="btn btn-xanhbo" data-bs-toggle="modal" data-bs-target="#newItemModal">
                        <i class="fa fa-plus"></i> T·∫°o m·ªõi
                    </button>
                    <button class="btn btn-action-blue" onclick="alert('Ch·ª©c nƒÉng Xu·∫•t file ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh.');">
                        <i class="fa-solid fa-file-export"></i> Xu·∫•t file
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="itemTable" class="table table-hover bg-white" style="width:100%">
                    <thead class="text-center">
                        <tr>
                            <th>M√£ xe</th>
                            <th>T√™n xe</th>
                            <th>Nh√≥m xe</th>
                            <th>Gi√° b√°n</th>
                            <th>Gi√° v·ªën</th>
                            <th>T·ªìn kho</th>
                            <th>Kh√°ch ƒë·∫∑t</th>
                            <th>Th·ªùi gian t·∫°o</th>
                            <th>ƒê·∫∑t NCC</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>    
        </div>
    </div>
</div>

<div class="modal fade" id="newItemModal" tabindex="-1" aria-labelledby="newItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newItemModalLabel"><i class="fa fa-plus"></i> Th√™m Xe M·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="itemName" class="form-label">T√™n Xe <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemCode" class="form-label">M√£ Xe (ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± t·∫°o)</label>
                        <input type="text" class="form-control" id="itemCode">
                    </div>
                    <div class="mb-3">
                        <label for="itemGroup" class="form-label">Nh√≥m xe</label>
                        <select class="form-select" id="itemGroup" required>
                            <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
                            <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
                            <option value="Xe tay ga">Xe tay ga</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sellPrice" class="form-label">Gi√° b√°n (‚Ç´)</label>
                            <input type="number" class="form-control" id="sellPrice" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="costPrice" class="form-label">Gi√° v·ªën (‚Ç´)</label>
                            <input type="number" class="form-control" id="costPrice" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="initialStock" class="form-label">T·ªìn kho ban ƒë·∫ßu</label>
                        <input type="number" class="form-control" id="initialStock" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-xanhbo" onclick="handleNewItemSubmit()">L∆∞u Xe</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="modal fade" id="editItemModal" tabindex="-1">
  <div class="modal-dialog">
   <div class="modal-content">

     <div class="modal-header">
       <h5 class="modal-title"><i class="fa-solid fa-pen-to-square"></i> Ch·ªânh s·ª≠a Xe</h5>
       <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
     </div>

     <div class="modal-body">
       <form id="formEdit">
         <input type="hidden" id="editMaHang">

         <label class="form-label mt-2">T√™n xe</label>
         <input class="form-control" id="editTenHang">

         <label class="form-label mt-2">Nh√≥m xe</label>
         <select class="form-select" id="editLoaiHang">
             <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
             <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
             <option value="Xe tay ga">Xe tay ga</option>
         </select>

         <label class="form-label mt-2">Gi√° b√°n</label>
         <input class="form-control" id="editGiaBan" type="number">

         <label class="form-label mt-2">Gi√° v·ªën</label>
         <input class="form-control" id="editGiaVon" type="number">

         <label class="form-label mt-2">T·ªìn kho</label>
         <input class="form-control" id="editTonKho" type="number">
       </form>
     </div>

     <div class="modal-footer">
       <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
       <button class="btn btn-xanhbo" onclick="submitEdit()">L∆∞u thay ƒë·ªïi</button>
     </div>

   </div>
  </div>
</div>


<script>
var table;
const CODE_COL = 0, GROUP_COL = 2, SELL_PRICE_COL = 3, COST_PRICE_COL = 4, STOCK_COL = 5;

// Format ti·ªÅn t·ªá Vi·ªát Nam
function formatCurrency(number){
    const num = parseInt(number) || 0;
    return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',minimumFractionDigits:0}).format(num).replace('‚Ç´', 'ƒë');
}

// 1. Th√™m m·ªõi h√†ng h√≥a (S·ª≠ d·ª•ng AJAX Server-Side)
function handleNewItemSubmit(){
    const name = $('#itemName').val().trim();
    if(!name){ alert('Vui l√≤ng nh·∫≠p T√™n xe.'); return; }

    const data = {
        MaHang: $('#itemCode').val().trim(),
        TenHang: name,
        LoaiHang: $('#itemGroup').val(),
        GiaBan: parseInt($('#sellPrice').val())||0,
        GiaVon: parseInt($('#costPrice').val())||0,
        TonKho: parseInt($('#initialStock').val())||0,
        KhachDat: 0,
        DatNCC: 0
    };


    $.ajax({
        url:"/HangHoa/Create", 
        type:"POST",
        contentType:"application/json",
        data: JSON.stringify(data),
        success: function(res){
            if (res.success) {
                // T·∫£i l·∫°i DataTables sau khi th√™m
                table.ajax.reload(null, false); 
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('newItemModal'));
                modal.hide();
                $('#addItemForm')[0].reset();
                alert(`ƒê√£ th√™m xe "${name}" th√†nh c√¥ng! M√£: ${res.maHang}`);
            } else {
                alert('Th√™m xe th·∫•t b·∫°i. L·ªói: ' + (res.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'));
            }
        },
        error:function(xhr){ 
            console.error("L·ªói AJAX:", xhr.responseText);
            alert('C√≥ l·ªói Server khi th√™m xe.'); 
        }
    });
}

// 2. M·ªü Modal Ch·ªânh s·ª≠a (T·∫£i d·ªØ li·ªáu)
function openEditModal(maHang){
    $.ajax({
        url: '/HangHoa/GetById?ma=' + maHang,
        type: 'GET',
        success: function(res){
            $('#editMaHang').val(res.maHang);
            $('#editTenHang').val(res.tenHang);
            $('#editLoaiHang').val(res.loaiHang);
            $('#editGiaBan').val(res.giaBan);
            $('#editGiaVon').val(res.giaVon);
            $('#editTonKho').val(res.tonKho);
            
            $('#editItemModal').modal('show');
        },
        error: function(xhr) { 
            console.error("L·ªói AJAX GetById:", xhr.responseText);
            alert('L·ªói Server khi t·∫£i d·ªØ li·ªáu xe.'); 
        }
    });
}

// 3. G·ª≠i d·ªØ li·ªáu Ch·ªânh s·ª≠a
function submitEdit(){
    var data = {
        MaHang: $('#editMaHang').val(),
        TenHang: $('#editTenHang').val(),
        LoaiHang: $('#editLoaiHang').val(),
        GiaBan: parseInt($('#editGiaBan').val()) || 0,
        GiaVon: parseInt($('#editGiaVon').val()) || 0,
        TonKho: parseInt($('#editTonKho').val()) || 0
    };
    
    if(!data.TenHang){ alert('Vui l√≤ng nh·∫≠p T√™n xe.'); return; }


    $.ajax({
        url:'/HangHoa/EditAjax',
        type:'POST',
        contentType:'application/json',
        data:JSON.stringify(data),
        success:function(res){
            if(res.success){
                $('#editItemModal').modal('hide');
                // T·∫£i l·∫°i DataTables ƒë·ªÉ hi·ªÉn th·ªã thay ƒë·ªïi
                table.ajax.reload(null, false); 
                alert("C·∫≠p nh·∫≠t xe th√†nh c√¥ng!");
            } else alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
        },
        error: function(xhr) { 
            console.error("L·ªói AJAX EditAjax:", xhr.responseText);
            alert('L·ªói Server khi c·∫≠p nh·∫≠t xe.'); 
        }
    });
}

// 4. X√≥a H√†ng H√≥a (S·ª≠ d·ª•ng AJAX)
function deleteItem(maHang, tenHang) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a xe:\n\n M√£: ${maHang}\n T√™n: ${tenHang}\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
        return;
    }

    $.ajax({
        url: '/HangHoa/DeleteAjax', // G·ªçi ƒë·∫øn Action m·ªõi trong Controller
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ MaHang: maHang }), // Truy·ªÅn MaHang d∆∞·ªõi d·∫°ng JSON object
        success: function (res) {
            if (res.success) {
                // T·∫£i l·∫°i DataTables sau khi x√≥a th√†nh c√¥ng
                table.ajax.reload(null, false);
                alert(res.message); // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng t·ª´ Controller
            } else {
                alert(`X√≥a th·∫•t b·∫°i: ${res.message}`);
            }
        },
        error: function (xhr) {
            console.error("L·ªói AJAX X√≥a:", xhr.responseText);
            alert('L·ªói Server khi th·ª±c hi·ªán x√≥a.');
        }
    });
}

// H√†m √°p d·ª•ng t·∫•t c·∫£ c√°c b·ªô l·ªçc (Nh√≥m v√† T·ªìn kho)
function applyFilter() {
    const groupValue = $('#filterGroup').val();
    // 1. L·ªçc theo Nh√≥m (LoaiHang) ch√≠nh x√°c gi√° tr·ªã: ^value$
    table.column(GROUP_COL).search(groupValue ? '^' + groupValue + '$' : '', true, false);

    // 2. K√≠ch ho·∫°t l·∫°i draw() ƒë·ªÉ ch·∫°y Custom Filter (T·ªìn kho)
    table.draw();
}

$(document).ready(function(){
    // Kh·ªüi t·∫°o DataTable v·ªõi c·∫•u h√¨nh AJAX v√† COLUMNS
    table = $('#itemTable').DataTable({
        ajax:{
            url: "/HangHoa/GetAllXe", // API l·∫•y danh s√°ch xe
            dataSrc: "" 
        },
        columns:[
            { data:"maHang", className:"text-center" },
            { data:"tenHang", className:"text-start" },
            { data:"loaiHang", className:"text-center" },
            { data:"giaBan", className:"text-end" },
            { data:"giaVon", className:"text-end" },
            { data:"tonKho", className:"text-center" },
            { data:"khachDat", className:"text-center" },
            { data:"thoiGianTao", className:"text-center" },
            { data:"datNCC", className:"text-center" },
            { data:"maHang", orderable:false, searchable:false, className:"text-center",
                render: (d, type, row) => `
                    <div class="d-flex justify-content-center gap-2">
                        <a href="javascript:void(0)" 
                            onclick="openEditModal('${d}')" 
                            class="btn btn-sm btn-warning text-white" title="Ch·ªânh s·ª≠a">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        <a href="javascript:void(0)" 
                            onclick="deleteItem('${d}', '${row.tenHang.replace(/'/g, "\\'")}')" 
                            class="btn btn-sm btn-danger" title="X√≥a">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </div>
                `
            }
        ],
        dom:'rtip', 
        order:[[STOCK_COL,'desc']],
        language: {
            sProcessing: "ƒêang x·ª≠ l√Ω...",
            sLengthMenu: "Xem _MENU_ m·ª•c",
            sZeroRecords: "Kh√¥ng t√¨m th·∫•y xe n√†o ph√π h·ª£p",
            sInfo: "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng s·ªë _TOTAL_ m·ª•c",
            sInfoEmpty: "Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong t·ªïng s·ªë 0 m·ª•c",
            sInfoFiltered: "(ƒë∆∞·ª£c l·ªçc t·ª´ t·ªïng s·ªë _MAX_ m·ª•c)",
            sSearch: "T√¨m ki·∫øm:",
            oPaginate: { sFirst:"ƒê·∫ßu", sLast:"Cu·ªëi", sNext:"Ti·∫øp", sPrevious:"Tr∆∞·ªõc" }
        },
        columnDefs: [
            // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
            { targets:[SELL_PRICE_COL,COST_PRICE_COL], render:function(data,type){ const num=parseInt(data)||0; return (type==='display'||type==='filter')?formatCurrency(num):num; }, className:'text-end' },
            // ƒê·ªãnh d·∫°ng badge cho Nh√≥m xe (s·ª≠ d·ª•ng style ƒë·ªìng b·ªô)
            { targets:GROUP_COL, render:function(data,type){ if(type==='display') return `<span class="badge" style="background-color:#e0f7e0;color:#2b542c;padding:5px 8px;font-weight:500">${data}</span>`; return data; }, className:'text-center' },
            // C·ªôt Thao t√°c
            { targets:9, orderable:false, searchable:false } 
        ]
    });


    // Custom Filter T·ªíN KHO
    $.fn.dataTable.ext.search.push(function(settings,data){
        if(settings.nTable.id !== 'itemTable') return true;
        const stockFilter = $('#filterStock').val();
        const stock = parseInt(data[STOCK_COL])||0;

        if(stockFilter==='available' && stock<=0) return false;
        if(stockFilter==='outOfStock' && stock>0) return false;
        return true;
    });

    // Event Handler (G·ªçi h√†m applyFilter chung)
    $('#filterGroup,#filterStock').on('change',()=>applyFilter());
    
    // Global search
    $('#globalSearchBox').on('keyup',()=>table.search($('#globalSearchBox').val()).draw());
});
</script>