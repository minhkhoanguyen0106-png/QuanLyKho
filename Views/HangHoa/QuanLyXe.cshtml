@{
    ViewBag.Title = "Qu·∫£n l√Ω h√†ng h√≥a";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* S·ª≠ d·ª•ng bi·∫øn CSS ƒë·ªÉ qu·∫£n l√Ω m√†u s·∫Øc nh·∫•t qu√°n, ƒê·ªíNG B·ªò V·ªöI NCC: #28a745 */
    :root {
        --primary-green-dark: #28a745; 
        --table-header-bg: white; 
        --table-header-color: #4a4a4a; 
        --background-color: #f7fcf7;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e1e1e1; /* Vi·ªÅn nh·∫π h∆°n */
        --action-blue: #007bff; /* M√†u xanh d∆∞∆°ng cho ph√¢n trang/n√∫t xu·∫•t file */
        --light-green-border: #cde8c8; /* M√†u xanh l√° nh·∫°t cho border input */
    }

    /* ====== M√ÄU V√Ä GIAO DI·ªÜN CHUNG ====== */
    body {
        background-color: var(--background-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    /* N√∫t h√†nh ƒë·ªông ch√≠nh (T·∫°o m·ªõi, L∆∞u) - ƒê·ªìng b·ªô v·ªõi NCC */
    .btn-xanhbo {
        background-color: var(--primary-green-dark);
        color: #fff;
        border: none;
        transition: 0.3s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-xanhbo:hover {
        background-color: #218838; 
        color: #fff;
    }
    
    /* N√∫t Xu·∫•t file (ƒê·ªìng b·ªô v·ªõi NCC) */
    .btn-action-blue {
        background-color: var(--action-blue);
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-action-blue:hover {
        background-color: #0069d9;
        color: #fff;
    }

    .text-success, h4.text-success, .filter-label {
        color: var(--primary-green-dark) !important;
    }

    /* N√∫t √Åp d·ª•ng b·ªô l·ªçc (ƒê√£ x√≥a kh·ªèi HTML, gi·ªØ l·∫°i style ph√≤ng tr∆∞·ªùng h·ª£p c·∫ßn d√πng l·∫°i) */
    .btn-apply-filter {
        background-color: var(--primary-green-dark);
        color: white;
        border-radius: 6px;
        padding: 8px 15px;
        width: 100%;
        margin-top: 15px;
        font-weight: 600;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    .btn-apply-filter:hover {
        background-color: #218838;
        color: white;
    }

    /* ====== KHUNG L·ªåC (filter-card) ====== */
    .filter-card {
        background-color: #fff;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        padding: 18px;
        border: 1px solid var(--border-color);
    }
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
    }

    /* Input/Select (Th·ªëng nh·∫•t ki·ªÉu d√°ng) */
    .form-control, .form-select {
        border-radius: 6px;
        font-size: 14px;
        border-color: var(--light-green-border);
    }
    
    /* Focus */
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25);
        border-color: var(--primary-green-dark);
    }

    /* ====== THANH T√åM KI·∫æM + N√öT (action-bar) ====== */
    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
    }
    #globalSearchBox {
        font-size: 14px;
    }

    /* ====== B·∫¢NG D·ªÆ LI·ªÜU ====== */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden; 
        border: 1px solid var(--border-color);
    }
    .table th {
        background-color: var(--table-header-bg) !important;
        color: var(--table-header-color);
        font-weight: 600;
        font-size: 13px; 
        border-bottom: 2px solid #ddd !important;
        border-top: none !important;
        padding: 10px 8px;
    }
    
    .table td {
        font-size: 13px;
        border-top: 1px solid #f0f0f0;
        vertical-align: middle;
        padding: 8px;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f5fff5; 
    }
    
    /* ƒê·ªäNH D·∫†NG DATATABLES PH√ÇN TRANG (ƒê·ªìng b·ªô v·ªõi NCC) */
    .dataTables_paginate .paginate_button.current, 
    .dataTables_paginate .paginate_button.current:hover {
        background: var(--action-blue) !important; 
        color: white !important;
        border-color: var(--action-blue) !important;
        border-radius: 4px;
    }
    .dataTables_paginate .paginate_button {
        border-radius: 4px;
        padding: 5px 10px;
    }
    
    /* Modal Header */
    #newItemModal .modal-header {
        background-color: var(--primary-green-dark) !important;
        color: white;
        border-bottom: none;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    .modal-title {
        font-weight: 600;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-success fw-bold">B·ªô l·ªçc H√†ng h√≥a</h5>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="filterGroup">Nh√≥m h√†ng h√≥a</label>
                    <select id="filterGroup" class="form-select">
                        <option value="">T·∫•t c·∫£ nh√≥m</option>
                        <option>Xe m√°y ƒëi·ªán</option>
                        <option>Xe ƒë·∫°p ƒëi·ªán</option>
                        <option>Xe tay ga</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="filterStock">T·ªìn kho</label>
                    <select id="filterStock" class="form-select">
                        <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                        <option value="available">C√≤n h√†ng</option>
                        <option value="outOfStock">H·∫øt h√†ng</option>
                    </select>
                </div>
                
                </div>
        </div>

        <div class="col-lg-9">
            <h4 class="fw-bold text-success mb-3">
                <i class="fa-solid fa-boxes-stacked"></i> Qu·∫£n l√Ω Xe / H√†ng h√≥a
            </h4>

            <div class="action-bar mb-3 d-flex justify-content-between flex-wrap align-items-center">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <input type="text" id="globalSearchBox" class="form-control" placeholder="üîç Theo m√£, t√™n xe/h√†ng h√≥a..." style="width: 250px;">
                    </div>

                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <button class="btn btn-xanhbo" data-bs-toggle="modal" data-bs-target="#newItemModal">
                        <i class="fa fa-plus"></i> T·∫°o m·ªõi
                    </button>
                    <button class="btn btn-action-blue" onclick="alert('Ch·ª©c nƒÉng Xu·∫•t file ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh.');">
                        <i class="fa-solid fa-file-export"></i> Xu·∫•t file
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="itemTable" class="table table-hover bg-white" style="width:100%">
                    <thead class="text-center">
                        <tr>
                            <th>M√£ xe</th> <th>T√™n xe</th> <th>Nh√≥m xe</th> <th>Gi√° b√°n</th> <th>Gi√° v·ªën</th> <th>T·ªìn kho</th> <th>Kh√°ch ƒë·∫∑t</th> <th>Th·ªùi gian t·∫°o</th> <th>ƒê·∫∑t NCC</th> <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        <tr><td>XD001</td><td class="text-start">VinFast Klara S</td><td>Xe m√°y ƒëi·ªán</td><td>34000000</td><td>30000000</td><td>15</td><td>2</td><td>03/11/2025 09:30</td><td>0</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                        <tr><td>XD002</td><td class="text-start">Yadea V-Power</td><td>Xe m√°y ƒëi·ªán</td><td>18500000</td><td>16000000</td><td>8</td><td>1</td><td>02/11/2025 14:22</td><td>0</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                        <tr><td>XD003</td><td class="text-start">Pega Xmen Neo</td><td>Xe ƒë·∫°p ƒëi·ªán</td><td>10000000</td><td>8500000</td><td>0</td><td>0</td><td>01/11/2025 15:15</td><td>5</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                        <tr><td>XD004</td><td class="text-start">Honda Vision (M·ªõi)</td><td>Xe tay ga</td><td>30000000</td><td>27000000</td><td>12</td><td>0</td><td>04/11/2025 10:00</td><td>0</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                        <tr><td>XD005</td><td class="text-start">Xe ƒëi·ªán mini</td><td>Xe ƒë·∫°p ƒëi·ªán</td><td>5500000</td><td>4500000</td><td>5</td><td>1</td><td>15/10/2025 10:00</td><td>0</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                        <tr><td>XD006</td><td class="text-start">Vespa Sprint</td><td>Xe tay ga</td><td>75000000</td><td>70000000</td><td>0</td><td>0</td><td>20/11/2025 12:00</td><td>10</td><td><i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info" id="itemTable_info" role="status" aria-live="polite"></div>
                <div class="dataTables_paginate paging_simple_numbers" id="itemTable_paginate"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newItemModal" tabindex="-1" aria-labelledby="newItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newItemModalLabel"><i class="fa fa-plus"></i> Th√™m Xe/H√†ng h√≥a M·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="itemName" class="form-label">T√™n Xe/H√†ng h√≥a <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemCode" class="form-label">M√£ Xe/H√†ng h√≥a (ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông t·∫°o)</label>
                        <input type="text" class="form-control" id="itemCode">
                    </div>
                    <div class="mb-3">
                        <label for="itemGroup" class="form-label">Nh√≥m h√†ng h√≥a</label>
                        <select class="form-select" id="itemGroup" required>
                            <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
                            <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
                            <option value="Xe tay ga">Xe tay ga</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sellPrice" class="form-label">Gi√° b√°n (‚Ç´)</label>
                            <input type="number" class="form-control" id="sellPrice" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="costPrice" class="form-label">Gi√° v·ªën (‚Ç´)</label>
                            <input type="number" class="form-control" id="costPrice" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="initialStock" class="form-label">T·ªìn kho ban ƒë·∫ßu</label>
                        <input type="number" class="form-control" id="initialStock" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-xanhbo" onclick="handleNewItemSubmit()">L∆∞u H√†ng h√≥a</button>
            </div>
        </div>
    </div>
</div>


<script>
    var table;
    const CODE_COL = 0; // C·ªôt M√£ xe
    const GROUP_COL = 2; // C·ªôt Nh√≥m xe
    const STOCK_COL = 5; // C·ªôt T·ªìn kho
    // const DATE_COL = 7; // ƒê√£ b·ªè c·ªôt ng√†y

    // H√†m format s·ªë th√†nh ti·ªÅn t·ªá Vi·ªát Nam
    function formatCurrency(number) {
        if (typeof number !== 'number') return number;
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(number).replace('‚Ç´', 'ƒë'); 
    }
    
    // H√†m chuy·ªÉn ƒë·ªïi chu·ªói ng√†y (dd/mm/yyyy hh:mm) th√†nh ƒë·ªëi t∆∞·ª£ng Date (ƒê√£ b·ªè, gi·ªØ l·∫°i ƒë·ªÉ d·ªÖ d√†ng ph·ª•c h·ªìi)
    /*
    function parseDate(dateString) {
        if (!dateString) return null;
        const [datePart] = dateString.split(' '); 
        const parts = datePart.split('/');
        return new Date(Date.UTC(parts[2], parts[1] - 1, parts[0])); 
    }
    */

    /* -------------------------------------------
    // LOGIC X·ª¨ L√ù KHI NH·∫§N L∆ØU H√ÄNG H√ìA M·ªöI
    ------------------------------------------- */
    function handleNewItemSubmit() {
        const name = $('#itemName').val().trim();
        
        if (!name) {
            alert("Vui l√≤ng nh·∫≠p T√™n Xe/H√†ng h√≥a.");
            return;
        }

        let newCode = $('#itemCode').val().trim(); 
        
        // T·ª± ƒë·ªông t·∫°o m√£ n·∫øu ng∆∞·ªùi d√πng ƒë·ªÉ tr·ªëng
        if (!newCode) {
             const allData = table.rows().data().toArray();
             let lastNum = 0;
             allData.forEach(row => {
                 const code = row[CODE_COL].replace(/<[^>]*>/g, '').trim(); 
                 if (code.startsWith('XD') && !isNaN(parseInt(code.slice(2)))) {
                     const currentNum = parseInt(code.slice(2));
                     if (currentNum > lastNum) {
                         lastNum = currentNum;
                     }
                 }
             });
             newCode = 'XD' + (lastNum + 1).toString().padStart(3, '0');
        }


        const group = $('#itemGroup').val();
        const sell = parseInt($('#sellPrice').val()) || 0;
        const cost = parseInt($('#costPrice').val()) || 0;
        const stock = parseInt($('#initialStock').val()) || 0;

        const now = new Date();
        const dateString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        // Th√™m h√†ng m·ªõi v√†o DataTables
        table.row.add([
            newCode, // C·ªôt M√£ xe
            name, // C·ªôt T√™n xe (DataTables s·∫Ω t·ª± b·ªçc <td>)
            group, // C·ªôt Nh√≥m xe
            sell, // Gi√° b√°n
            cost, // Gi√° v·ªën
            stock, // T·ªìn kho
            0, // Kh√°ch ƒë·∫∑t
            dateString, // Th·ªùi gian t·∫°o
            0, // ƒê·∫∑t NCC
            '<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i>' // Thao t√°c
        ]).draw(false); 

        // ƒê√≥ng Modal v√† Reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('newItemModal'));
        modal.hide();
        $('#addItemForm')[0].reset();
        alert(`ƒê√£ th√™m h√†ng h√≥a "${name}" th√†nh c√¥ng v·ªõi m√£ ${newCode}!`);
    }
    
    /* -------------------------------------------
    // LOGIC L·ªåC T√ôY CH·ªàNH
    // Ch·ªâ c√≤n l·∫°i l·ªçc theo Nh√≥m v√† T·ªìn kho
    ------------------------------------------- */
    
    // H√†m k√≠ch ho·∫°t l·ªçc DataTables
    function applyAllFilters() {
        table.draw();
    }
    

    $(document).ready(function () {
        
        /* -------------------------------------------
        // 1. KH·ªûI T·∫†O DATATABLES
        ------------------------------------------- */
        table = $('#itemTable').DataTable({
            dom: 'rtip', 
            order: [[STOCK_COL, 'desc']], 
            language: {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Xem _MENU_ m·ª•c",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y h√†ng h√≥a n√†o ph√π h·ª£p",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng s·ªë _TOTAL_ m·ª•c",
                "sInfoEmpty": "Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong t·ªïng s·ªë 0 m·ª•c",
                "sInfoFiltered": "(ƒë∆∞·ª£c l·ªçc t·ª´ t·ªïng s·ªë _MAX_ m·ª•c)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sLast": "Cu·ªëi",
                    "sNext": "Ti·∫øp",
                    "sPrevious": "Tr∆∞·ªõc"
                }
            },
            columnDefs: [
                // ƒê·ªãnh d·∫°ng c·ªôt Gi√° b√°n v√† Gi√° v·ªën (format ti·ªÅn t·ªá)
                {
                    targets: [3, 4],
                    render: function (data, type, row) {
                        const num = parseInt(data.toString().replace(/,/g, ''));
                        if (type === 'display' || type === 'filter') {
                            return formatCurrency(num);
                        }
                        return num;
                    },
                    className: 'text-end'
                },
                // ƒê·ªãnh d·∫°ng c·ªôt T·ªìn kho, Kh√°ch ƒë·∫∑t, ƒê·∫∑t NCC
                {
                    targets: [5, 6, 8],
                    className: 'text-center'
                },
                // ƒê·ªãnh d·∫°ng c·ªôt Nh√≥m xe - Th√™m badge m√†u nh·∫π
                {
                    targets: GROUP_COL,
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return `<span class="badge" style="background-color:#e0f7e0; color:#2b542c; font-weight:500; padding: 5px 8px;">${data.replace(/<[^>]*>/g, '')}</span>`;
                        }
                        return data.replace(/<[^>]*>/g, '');
                    },
                    className: 'text-center'
                },
                // C·ªôt T√™n xe - CƒÉn tr√°i
                {
                    targets: 1, 
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return `<span class="text-start">${data.replace(/<[^>]*>/g, '')}</span>`;
                        }
                        return data.replace(/<[^>]*>/g, '');
                    },
                    className: 'text-start'
                },
                // C·ªôt Thao t√°c - Kh√¥ng cho DataTables s·∫Øp x·∫øp/t√¨m ki·∫øm
                {
                    targets: 9,
                    orderable: false,
                    searchable: false,
                }
            ]
        });

        /* -------------------------------------------
        // 2. CUSTOM FILTERS (Nh√≥m, T·ªìn kho)
        ------------------------------------------- */
        
        // Custom filter cho Nh√≥m h√†ng h√≥a v√† T·ªìn kho
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                if (settings.nTable.id !== 'itemTable') {
                    return true;
                }

                // L·∫•y data th√¥ (kh√¥ng c√≥ HTML) t·ª´ m·∫£ng data
                const rowGroup = data[GROUP_COL].replace(/<[^>]*>/g, '').trim(); 
                const stock = parseInt(data[STOCK_COL]) || 0; 
                
                // --- L·ªçc theo Nh√≥m h√†ng h√≥a ---
                const groupFilter = $('#filterGroup').val();
                if (groupFilter && rowGroup !== groupFilter) {
                    return false;
                }

                // --- L·ªçc theo T·ªìn kho ---
                const stockFilter = $('#filterStock').val();
                if (stockFilter === 'available' && stock <= 0) {
                    return false; 
                } else if (stockFilter === 'outOfStock' && stock > 0) {
                    return false; 
                }
                
                // --- L·ªçc theo Th·ªùi gian t·∫°o (ƒê√É B·ªé LOGIC) ---
                
                return true; 
            }
        );
        
        /* -------------------------------------------
        // 3. K·∫æT N·ªêI S·ª∞ KI·ªÜN L·ªåC
        // L·ªçc ƒë∆∞·ª£c k√≠ch ho·∫°t ngay khi gi√° tr·ªã filter thay ƒë·ªïi
        ------------------------------------------- */
        
        // K√≠ch ho·∫°t l·ªçc ngay khi thay ƒë·ªïi dropdown Nh√≥m h√†ng h√≥a v√† T·ªìn kho
        $('#filterGroup, #filterStock').on('change', function() {
            applyAllFilters();
        });

        // Global Search (T√¨m ki·∫øm to√†n c·ª•c)
        $('#globalSearchBox').on('keyup', function () {
            table.search(this.value).draw();
        });
        
    });
</script>