@{
    ViewBag.Title = "Danh s√°ch h√†ng h√≥a";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
    :root {
        --primary-green-dark: #28a745; 
        --table-header-bg: white; 
        --table-header-color: #4a4a4a; 
        --background-color: #f7fcf7;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e1e1e1;
        --action-blue: #007bff;
        --light-green-border: #cde8c8;
        --action-edit: #28a745; /* ƒê√£ ƒë·ªïi t·ª´ m√†u c≈© sang xanh l√° */
    }

    body {
        background-color: var(--background-color);
        font-family: "Segoe UI", sans-serif;
    }

    /* Buttons */
    .btn-xanhbo {
        background-color: var(--primary-green-dark);
        color: #fff;
        border: none;
        transition: 0.3s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-xanhbo:hover {
        background-color: #218838; /* M√†u hover t·ªëi h∆°n m·ªôt ch√∫t */
        color: #fff;
    }
    .btn-action-blue {
        background-color: var(--action-blue);
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-action-blue:hover {
        background-color: #0069d9;
        color: #fff;
    }

    /* Filter Card (Sidebar b√™n tr√°i) */
    .filter-card {
        background-color: #fff;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        padding: 18px;
        border: 1px solid var(--border-color);
    }
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
        color: #555;
    }

    /* Inputs */
    .form-control, .form-select {
        border-radius: 6px;
        font-size: 14px;
        border-color: var(--light-green-border);
    }
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25);
        border-color: var(--primary-green-dark);
    }

    /* Action Bar (Thanh t√¨m ki·∫øm b√™n ph·∫£i) */
    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
    }

    /* Table */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden; 
        border: 1px solid var(--border-color);
    }
    .table th {
        background-color: var(--table-header-bg) !important;
        color: var(--table-header-color);
        font-weight: 600;
        font-size: 13px; 
        border-bottom: 2px solid #ddd !important;
        border-top: none !important;
        padding: 10px 8px;
    }
    .table td {
        font-size: 13px;
        border-top: 1px solid #f0f0f0;
        vertical-align: middle;
        padding: 8px;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f5fff5; 
    }

    /* Pagination */
    .dataTables_paginate .paginate_button.current, 
    .dataTables_paginate .paginate_button.current:hover {
        background: var(--action-blue) !important; 
        color: white !important;
        border-color: var(--action-blue) !important;
        border-radius: 4px;
    }
    .dataTables_paginate .paginate_button {
        border-radius: 4px;
        padding: 5px 10px;
    }

    /* Modal Headers */
    /* √Åp d·ª•ng m√†u xanh cho c·∫£ 2 modal */
    #newProductModal .modal-header,
    #editItemModal .modal-header {
        background-color: var(--primary-green-dark) !important;
        color: white;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    /* Badges */
    .badge-xedien { 
        background-color: var(--primary-green-dark); 
        color: white; 
        padding: 5px 8px; 
        border-radius: 4px; 
    }
    /* ƒê√£ ƒë·ªïi badge linh ki·ªán sang xanh l√° */
    .badge-linhkien { 
        background-color: var(--primary-green-dark); 
        color: white; 
        padding: 5px 8px; 
        border-radius: 4px; 
    }
</style>

<div class="container-fluid mt-4">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <h5 class="mb-3 text-success fw-bold"><i class="fa-solid fa-filter"></i> B·ªô l·ªçc H√†ng h√≥a</h5>

                <div class="mb-3">
                    <label class="filter-label" for="typeFilter">Lo·∫°i h√†ng h√≥a</label>
                    <select id="typeFilter" class="form-select">
                        <option value="">T·∫•t c·∫£ lo·∫°i h√†ng</option>
                        <option value="Xe ƒëi·ªán">Xe ƒëi·ªán</option>
                        <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
                        <option value="Linh ki·ªán">Linh ki·ªán</option>
                        <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
                        <option value="Xe tay ga">Xe tay ga</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="stockFilter">T·ªìn kho</label>
                    <select id="stockFilter" class="form-select">
                        <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                        <option value="available">C√≤n h√†ng</option>
                        <option value="outOfStock">H·∫øt h√†ng</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <h4 class="fw-bold text-success mb-3">
                <i class="fa-solid fa-boxes-stacked"></i> Danh s√°ch h√†ng h√≥a
            </h4>

            <div class="action-bar mb-3 d-flex justify-content-between flex-wrap align-items-center">
                <input type="text" id="globalSearchBox" class="form-control me-2" placeholder="üîç T√¨m theo m√£, t√™n h√†ng h√≥a..." style="width: 300px;">
                
                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <button class="btn btn-xanhbo" data-bs-toggle="modal" data-bs-target="#newProductModal">
                        <i class="fa fa-plus"></i> T·∫°o m·ªõi
                    </button>
                    <button class="btn btn-action-blue" onclick="alert('Ch·ª©c nƒÉng Xu·∫•t file ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh.');">
                        <i class="fa-solid fa-file-export"></i> Xu·∫•t file
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="productTable" class="table table-hover bg-white" style="width:100%">
                    <thead class="text-center">
                        <tr>
                            <th>Lo·∫°i h√†ng</th>
                            <th>M√£ h√†ng</th>
                            <th>T√™n h√†ng</th>
                            <th>Gi√° b√°n</th>
                            <th>Gi√° v·ªën</th>
                            <th>T·ªìn kho</th>
                            <th>Th·ªùi gian t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-plus"></i> Th√™m H√†ng H√≥a M·ªõi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formAdd">
            <label class="form-label">M√£ h√†ng (ƒê·ªÉ tr·ªëng t·ª± t·∫°o)</label>
            <input class="form-control mb-2" name="MaHang" />
            
            <label class="form-label">T√™n h√†ng <span class="text-danger">*</span></label>
            <input class="form-control mb-2" name="TenHang" required />
            
            <label class="form-label">Lo·∫°i h√†ng</label>
            <select class="form-select mb-2" name="LoaiHang">
                <option value="Xe ƒëi·ªán">Xe ƒëi·ªán</option>
                <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
                <option value="Linh ki·ªán">Linh ki·ªán</option>
                <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
                <option value="Xe tay ga">Xe tay ga</option>
            </select>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Gi√° b√°n (‚Ç´)</label>
                    <input class="form-control mb-2" name="GiaBan" type="number" value="0" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Gi√° v·ªën (‚Ç´)</label>
                    <input class="form-control mb-2" name="GiaVon" type="number" value="0" />
                </div>
            </div>
            
            <label class="form-label">T·ªìn kho ban ƒë·∫ßu</label>
            <input class="form-control mb-2" name="TonKho" type="number" value="0" />
            
            <label class="form-label">Kh√°ch ƒë·∫∑t</label>
            <input class="form-control mb-2" name="KhachDat" type="number" value="0" />
            
            <label class="form-label">Ghi ch√∫</label>
            <input class="form-control mb-2" name="GhiChu" />
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-xanhbo" onclick="handleNewProductSubmit()">L∆∞u H√†ng H√≥a</button> 
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editItemModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-pen-to-square"></i> Ch·ªânh s·ª≠a H√†ng h√≥a</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formEdit">
          <input type="hidden" id="editMaHang">

          <label class="form-label mt-2">T√™n h√†ng</label>
          <input class="form-control" id="editTenHang">

          <label class="form-label mt-2">Lo·∫°i h√†ng</label>
          <select class="form-select" id="editLoaiHang">
              <option value="Xe ƒëi·ªán">Xe ƒëi·ªán</option>
              <option value="Xe ƒë·∫°p ƒëi·ªán">Xe ƒë·∫°p ƒëi·ªán</option>
                <option value="Linh ki·ªán">Linh ki·ªán</option>
                <option value="Xe m√°y ƒëi·ªán">Xe m√°y ƒëi·ªán</option>
                <option value="Xe tay ga">Xe tay ga</option>
          </select>

          <label class="form-label mt-2">Gi√° b√°n</label>
          <input class="form-control" id="editGiaBan" type="number">

          <label class="form-label mt-2">Gi√° v·ªën</label>
          <input class="form-control" id="editGiaVon" type="number">

          <label class="form-label mt-2">T·ªìn kho</label>
          <input class="form-control" id="editTonKho" type="number">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button class="btn btn-xanhbo" onclick="submitEdit()">L∆∞u thay ƒë·ªïi</button>
      </div>

    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var table;
    const TYPE_COL = 0, CODE_COL = 1, SELL_PRICE_COL = 3, COST_PRICE_COL = 4, STOCK_COL = 5, ACTION_COL = 7;

    // Format ti·ªÅn t·ªá Vi·ªát Nam
    function formatCurrency(number){
        const num = parseInt(number) || 0;
        return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',minimumFractionDigits:0}).format(num).replace('‚Ç´', 'ƒë');
    }

    // 1. Th√™m m·ªõi h√†ng h√≥a
    function handleNewProductSubmit(){
        const tenHang = $('input[name="TenHang"]').val().trim();
        if(!tenHang){ alert('Vui l√≤ng nh·∫≠p T√™n h√†ng h√≥a.'); return; }

        var data = {
            MaHang: $('input[name="MaHang"]').val().trim(),
            TenHang: tenHang,
            LoaiHang: $('select[name="LoaiHang"]').val(),
            GiaBan: parseInt($('input[name="GiaBan"]').val()) || 0,
            GiaVon: parseInt($('input[name="GiaVon"]').val()) || 0,
            TonKho: parseInt($('input[name="TonKho"]').val()) || 0,
            KhachDat: parseInt($('input[name="KhachDat"]').val()) || 0,
            GhiChu: $('input[name="GhiChu"]').val()
        };

        $.ajax({
            url: '/HangHoa/Create',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(res){
                if(res.success) {
                    table.ajax.reload(null, false);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newProductModal'));
                    modal.hide();
                    $('#formAdd')[0].reset();
                    alert(`ƒê√£ th√™m h√†ng h√≥a "${tenHang}" th√†nh c√¥ng!`);
                }
                else alert("Th√™m h√†ng h√≥a th·∫•t b·∫°i! L·ªói: " + (res.message || 'Kh√¥ng r√µ.'));
            },
            error: function(xhr){
                console.error("L·ªói AJAX:", xhr.responseText);
                alert('C√≥ l·ªói Server khi th√™m h√†ng h√≥a.');
            }
        });
    }

    // 2. M·ªü Modal Ch·ªânh s·ª≠a
    function openEditModal(maHang){
        $.ajax({
            url: '/HangHoa/GetById?ma=' + maHang,
            type: 'GET',
            success: function(res){
                $('#editMaHang').val(res.maHang);
                $('#editTenHang').val(res.tenHang);
                $('#editLoaiHang').val(res.loaiHang);
                $('#editGiaBan').val(res.giaBan);
                $('#editGiaVon').val(res.giaVon);
                $('#editTonKho').val(res.tonKho);
                $('#editItemModal').modal('show');
            }
        });
    }

    // 3. G·ª≠i d·ªØ li·ªáu Ch·ªânh s·ª≠a
    function submitEdit(){
        var data = {
            MaHang: $('#editMaHang').val(),
            TenHang: $('#editTenHang').val(),
            LoaiHang: $('#editLoaiHang').val(),
            GiaBan: parseInt($('#editGiaBan').val()) || 0,
            GiaVon: parseInt($('#editGiaVon').val()) || 0,
            TonKho: parseInt($('#editTonKho').val()) || 0
        };

        $.ajax({
            url:'/HangHoa/EditAjax',
            type:'POST',
            contentType:'application/json',
            data:JSON.stringify(data),
            success:function(res){
                if(res.success){
                    $('#editItemModal').modal('hide');
                    table.ajax.reload(null, false);
                    alert("C·∫≠p nh·∫≠t h√†ng h√≥a th√†nh c√¥ng!");
                } else alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
            }
        });
    }

    // 4. X√≥a H√†ng H√≥a
    function deleteProduct(maHang) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√†ng h√≥a c√≥ M√£: ${maHang}? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
            return; 
        }
        $.ajax({
            url: '/HangHoa/DeleteAjax',
            type: 'POST', 
            contentType: 'application/json',
            data: JSON.stringify({ MaHang: maHang }), 
            success: function(res) {
                if (res.success) {
                    alert(`ƒê√£ x√≥a h√†ng h√≥a [${maHang}] th√†nh c√¥ng kh·ªèi h·ªá th·ªëng!`);
                    table.ajax.reload(null, false);
                } else {
                    alert("X√≥a h√†ng h√≥a th·∫•t b·∫°i! L·ªói: " + (res.message || 'Kh√¥ng r√µ.'));
                }
            },
            error: function(xhr) {
                console.error("L·ªói AJAX khi x√≥a:", xhr.responseText);
                alert('C√≥ l·ªói Server khi th·ª±c hi·ªán x√≥a h√†ng h√≥a.');
            }
        });
    }

    $(document).ready(function(){
        table = $('#productTable').DataTable({
            ajax:{
                url: "/HangHoa/GetAll",
                dataSrc: "" 
            },
            columns:[
                { data:"loaiHang", className:"text-center" }, 
                { data:"maHang", className:"text-center" },
                { data:"tenHang", className:"text-start" },
                { data:"giaBan", className:"text-end" },
                { data:"giaVon", className:"text-end" },
                { data:"tonKho", className:"text-center" },
                { data:"thoiGianTao", className:"text-center", 
                    render: function(data){ 
                        if (!data) return '';
                        const date = new Date(data);
                        if (isNaN(date.getTime())) return data; 
                        return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN').substring(0,5); 
                    } 
                },
                { data:"maHang", orderable:false, searchable:false, className:"text-center",
                    render: function(d){
                        // N√∫t S·ª≠a ƒë√£ chuy·ªÉn sang class btn-xanhbo
                        return `
                             <div class="d-flex justify-content-center gap-2">
                             <a href="javascript:void(0)" onclick="openEditModal('${d}')" class="btn btn-sm btn-xanhbo" title="Ch·ªânh s·ª≠a"><i class="fa-solid fa-pen-to-square"></i></a>
                             <a href="javascript:void(0)" onclick="deleteProduct('${d}')" class="btn btn-sm btn-danger" title="X√≥a h√†ng h√≥a"><i class="fa-solid fa-trash"></i></a>
                             </div>
                        `;
                    }
                }
            ],
            dom:'rtip',
            order:[[STOCK_COL,'desc']],
            language:{
                  sProcessing:"ƒêang x·ª≠ l√Ω...",
                  sLengthMenu:"Xem _MENU_ m·ª•c",
                  sZeroRecords:"Kh√¥ng t√¨m th·∫•y h√†ng h√≥a n√†o ph√π h·ª£p",
                  sInfo:"Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng s·ªë _TOTAL_ m·ª•c",
                  sInfoEmpty:"Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong t·ªïng s·ªë 0 m·ª•c",
                  sInfoFiltered:"(ƒë∆∞·ª£c l·ªçc t·ª´ t·ªïng s·ªë _MAX_ m·ª•c)",
                  sSearch:"T√¨m ki·∫øm:",
                  oPaginate:{ sFirst:"ƒê·∫ßu", sLast:"Cu·ªëi", sNext:"Ti·∫øp", sPrevious:"Tr∆∞·ªõc" }
            },
            columnDefs:[
                {
                    targets:TYPE_COL,
                    render:function(data,type,row){
                        if(type==='display'){
                            // Badge ƒë√£ d√πng m√†u xanh l√°
                            let cls = (data==='Xe ƒëi·ªán' || data==='Xe m√°y ƒëi·ªán') ? 'badge-xedien':'badge-linhkien';
                            return `<span class="badge ${cls}">${data}</span>`;
                        }
                        return data;
                    }
                },
                {
                    targets:[SELL_PRICE_COL,COST_PRICE_COL],
                    render:function(data,type,row){
                        return (type==='display'||type==='filter')?formatCurrency(data):parseInt(data)||0;
                    },
                    className:'text-end'
                }
            ]
        });

        // Event Handlers cho b·ªô l·ªçc b√™n tr√°i
        $('#typeFilter').on('change',function(){
            const val = $(this).val();
            table.column(TYPE_COL).search(val?'^'+val+'$':'',true,false).draw();
        });

        $.fn.dataTable.ext.search.push(function(settings,data,index){
            if(settings.nTable.id!=='productTable') return true;
            const stockFilter=$('#stockFilter').val();
            const stock=parseInt(data[STOCK_COL])||0;
            if(stockFilter==='available') return stock>0;
            if(stockFilter==='outOfStock') return stock<=0;
            return true;
        });
        $('#stockFilter').on('change',()=>table.draw());

        $('#globalSearchBox').on('keyup',function(){ table.search(this.value).draw(); });
    });
</script>