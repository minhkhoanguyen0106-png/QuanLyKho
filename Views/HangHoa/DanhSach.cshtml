@{
    ViewBag.Title = "Danh s√°ch h√†ng h√≥a";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* ====== M√ÄU V√Ä GIAO DI·ªÜN ƒê·ªíNG B·ªò NCC (M√ÄU XANH CH·ª¶ ƒê·∫†O: #28a745) ====== */
    :root {
        --main-green: #28a745; /* M√†u xanh l√° ƒë·∫≠m cho n√∫t ch√≠nh v√† ti√™u ƒë·ªÅ */
        --light-green: #dff6da; /* M√†u n·ªÅn nh·∫π cho table header (gi·ªØ l·∫°i) */
    }
    
    body {
        background-color: #f7fcf7;
        font-family: "Segoe UI", sans-serif;
    }

    /* N√öT T·∫†O M·ªöI (Gi·ªëng n√∫t + Nh√† cung c·∫•p) */
    .btn-primary-green {
        background-color: var(--main-green);
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
    }
    .btn-primary-green:hover {
        background-color: #218838; /* Xanh ƒë·∫≠m h∆°n khi hover */
        color: #fff;
    }
    
    /* N√∫t H√ÄNH ƒê·ªòNG kh√°c (Xu·∫•t file) - Gi·ªëng m√†u xanh d∆∞∆°ng trong h√¨nh */
    .btn-action-blue {
        background-color: #007bff;
        color: #fff;
        border: none;
        transition: 0.2s;
        font-weight: 500;
        border-radius: 6px;
    }
    .btn-action-blue:hover {
        background-color: #0069d9;
    }

    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; /* Gi·∫£m bo tr√≤n */
        box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        border: 1px solid #e1e1e1; /* Vi·ªÅn nh·∫π h∆°n */
    }

    /* ƒê·ªäNH D·∫†NG B·∫¢NG */
    #productTable {
        border: none !important; /* B·ªé VI·ªÄN NGO√ÄI */
        box-shadow: none !important; /* B·ªé SHADOW */
    }
    
    /* B·ªé VI·ªÄN BORDER v√† SHADOW C·ª¶A TABLE WRAPPER */
    .table-responsive > .dataTables_wrapper > .bg-white { 
        border: none !important; 
        box-shadow: none !important;
    }
    
    .table thead tr {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
    }

    .table th {
        background-color: white !important; /* Thay m√†u header th√†nh TR·∫ÆNG */
        color: #4a4a4a; /* M√†u ch·ªØ ƒë·∫≠m h∆°n */
        font-weight: 600;
        font-size: 13px; /* K√≠ch th∆∞·ªõc ch·ªØ nh·ªè h∆°n */
        border-bottom: 2px solid #ddd !important; /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi r√µ r√†ng h∆°n */
        border-top: none !important;
    }

    .table td {
        vertical-align: middle;
        font-size: 13px; /* K√≠ch th∆∞·ªõc ch·ªØ nh·ªè h∆°n */
        border-top: 1px solid #f0f0f0;
    }

    .table-hover tbody tr:hover {
        background-color: #f5fcf5; /* M√†u hover nh·∫π h∆°n */
    }
    
    /* TI√äU ƒê·ªÄ CH√çNH */
    h4 {
        color: var(--main-green) !important;
    }

    /* INPUT/SELECT */
    .form-control, .form-select {
        border-radius: 6px;
    }
    .form-control::placeholder {
        color: #999;
    }

    /* ƒê·ªäNH D·∫†NG DATATABLES */
    .dataTables_wrapper {
        padding-top: 5px;
    }
    .dataTables_info {
        font-size: 13px;
        padding-top: 10px !important;
        color: #6c757d;
    }
    .dataTables_paginate {
        float: right;
    }
    
    /* Thi·∫øt k·∫ø n√∫t ph√¢n trang gi·ªëng h√¨nh image_ae4d89.png */
    .dataTables_paginate .paginate_button {
        padding: 6px 12px !important;
        border-radius: 4px !important;
        margin: 0 2px !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
        background: #fff !important;
        font-size: 13px;
        transition: 0.2s;
    }
    .dataTables_paginate .paginate_button:hover:not(.current) {
        background: #f0f0f0 !important;
        border-color: #ccc !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #007bff !important; /* M√†u xanh d∆∞∆°ng cho n√∫t hi·ªán t·∫°i */
        color: white !important;
        border-color: #007bff !important;
    }
    .dataTables_paginate .paginate_button.disabled {
        color: #ccc !important;
    }
    
    /* Modal Header */
    #newProductModal .modal-header {
        background-color: var(--main-green) !important;
    }
</style>

<div class="container-fluid mt-4">
    <h4 class="fw-bold mb-3">
        <i class="fa-solid fa-boxes-stacked"></i> Danh s√°ch h√†ng h√≥a
    </h4>

    <div class="action-bar mb-3 d-flex justify-content-between flex-wrap align-items-center">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="text" id="globalSearchBox" class="form-control" placeholder="üîç T√¨m theo m√£, t√™n h√†ng h√≥a..." style="width: 250px; border-color: #cde8c8;">
            <select id="typeFilter" class="form-select" style="width: 180px; border-color: #cde8c8;">
                <option value="">T·∫•t c·∫£ lo·∫°i h√†ng</option>
                <option value="Xe ƒëi·ªán">Xe ƒëi·ªán</option>
                <option value="Linh ki·ªán">Linh ki·ªán</option>
            </select>
            <select id="stockFilter" class="form-select" style="width: 150px; border-color: #cde8c8;">
                <option value="">T·∫•t c·∫£ t·ªìn kho</option>
                <option value="available">C√≤n h√†ng</option>
                <option value="outOfStock">H·∫øt h√†ng</option>
            </select>
        </div>

        <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
            <button class="btn btn-primary-green" data-bs-toggle="modal" data-bs-target="#newProductModal">
                <i class="fa fa-plus"></i> T·∫°o m·ªõi
            </button>
            <button class="btn btn-action-blue" onclick="alert('Ch·ª©c nƒÉng Xu·∫•t file ch∆∞a ƒë∆∞·ª£c l·∫≠p tr√¨nh.');">
                 <i class="fa-solid fa-file-export"></i> Xu·∫•t file
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="productTable" class="table table-hover bg-white" style="width:100%">
            <thead class="text-center">
                <tr>
                    <th>Lo·∫°i h√†ng</th>
                    <th>M√£ h√†ng</th>
                    <th>T√™n h√†ng</th>
                    <th>Gi√° b√°n</th>
                    <th>Gi√° v·ªën</th>
                    <th>T·ªìn kho</th>
                    <th>Kh√°ch ƒë·∫∑t</th>
                    <th>Th·ªùi gian t·∫°o</th>
                    <th>Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody class="text-center">
                <tr><td>Xe ƒëi·ªán</td><td>XD001</td><td class="text-start">VinFast Klara S</td><td>34000000</td><td>30000000</td><td>15</td><td>2</td><td>03/11/2025 09:30</td><td>---</td></tr>
                <tr><td>Xe ƒëi·ªán</td><td>XD002</td><td class="text-start">Yadea G5</td><td>31500000</td><td>27000000</td><td>0</td><td>0</td><td>02/11/2025 14:22</td><td>---</td></tr>
                <tr><td>Xe ƒëi·ªán</td><td>XD003</td><td class="text-start">DatBike Gogo SS</td><td>39000000</td><td>35000000</td><td>10</td><td>1</td><td>01/11/2025 15:15</td><td>---</td></tr>
                <tr><td>Linh ki·ªán</td><td>LK001</td><td class="text-start">·∫Æc quy Lithium 60V</td><td>3200000</td><td>2700000</td><td>25</td><td>3</td><td>03/11/2025 09:30</td><td>---</td></tr>
                <tr><td>Linh ki·ªán</td><td>LK002</td><td class="text-start">ƒê·ªông c∆° 1200W</td><td>2800000</td><td>2300000</td><td>18</td><td>1</td><td>02/11/2025 14:22</td><td>---</td></tr>
                <tr><td>Linh ki·ªán</td><td>LK003</td><td class="text-start">Phanh ƒëƒ©a th·ªßy l·ª±c</td><td>950000</td><td>700000</td><td>30</td><td>0</td><td>01/11/2025 15:15</td><td>---</td></tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="dataTables_info" id="productTable_info" role="status" aria-live="polite"></div>
        <div class="dataTables_paginate paging_simple_numbers" id="productTable_paginate"></div>
    </div>
</div>

<div class="modal fade" id="newProductModal" tabindex="-1" aria-labelledby="newProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newProductModalLabel"><i class="fa fa-plus"></i> Th√™m H√†ng H√≥a M·ªõi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addProductForm">
          <div class="mb-3">
            <label for="productName" class="form-label">T√™n h√†ng h√≥a <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="productName" required>
          </div>
          <div class="mb-3">
            <label for="productCode" class="form-label">M√£ h√†ng h√≥a</label>
            <input type="text" class="form-control" id="productCode">
          </div>
          <div class="mb-3">
            <label for="productType" class="form-label">Lo·∫°i h√†ng</label>
            <select class="form-select" id="productType" required>
                <option value="Xe ƒëi·ªán">Xe ƒëi·ªán</option>
                <option value="Linh ki·ªán">Linh ki·ªán</option>
            </select>
          </div>
          <div class="row">
              <div class="col-md-6 mb-3">
                <label for="sellPrice" class="form-label">Gi√° b√°n (‚Ç´)</label>
                <input type="number" class="form-control" id="sellPrice" value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label for="costPrice" class="form-label">Gi√° v·ªën (‚Ç´)</label>
                <input type="number" class="form-control" id="costPrice" value="0">
              </div>
          </div>
          <div class="mb-3">
            <label for="initialStock" class="form-label">T·ªìn kho ban ƒë·∫ßu</label>
            <input type="number" class="form-control" id="initialStock" value="0">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary-green" onclick="handleNewProductSubmit()">L∆∞u H√†ng H√≥a</button>
      </div>
    </div>
  </div>
</div>


<script>
    var table;
    const TYPE_COL = 0;
    const SELL_PRICE_COL = 3;
    const COST_PRICE_COL = 4;
    const STOCK_COL = 5;

    function formatCurrency(number) {
        if (typeof number !== 'number') return number;
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(number);
    }

    function handleNewProductSubmit() {
        const name = $('#productName').val();
        const code = $('#productCode').val() || 'T·ª± ƒë·ªông';
        const type = $('#productType').val();
        const sell = parseInt($('#sellPrice').val()) || 0;
        const cost = parseInt($('#costPrice').val()) || 0;
        const stock = parseInt($('#initialStock').val()) || 0;

        if (!name) {
            alert("Vui l√≤ng nh·∫≠p T√™n h√†ng h√≥a.");
            return;
        }

        const now = new Date();
        const dateString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

        table.row.add([
            type,       
            code,       
            name,       
            sell,       
            cost,       
            stock,      
            0,          
            dateString, 
            '---'       
        ]).draw(false); 

        const modal = bootstrap.Modal.getInstance(document.getElementById('newProductModal'));
        modal.hide();
        $('#addProductForm')[0].reset();
        alert(`ƒê√£ th√™m h√†ng h√≥a "${name}" th√†nh c√¥ng!`);
    }

    $(document).ready(function () {
        
        /* -------------------------------------------
        // 1. KH·ªûI T·∫†O DATATABLES
        ------------------------------------------- */
        table = $('#productTable').DataTable({
            dom: 'rtip', 
            order: [[STOCK_COL, 'desc']], 
            language: {
                "sProcessing": "ƒêang x·ª≠ l√Ω...",
                "sLengthMenu": "Xem _MENU_ m·ª•c",
                "sZeroRecords": "Kh√¥ng t√¨m th·∫•y h√†ng h√≥a n√†o ph√π h·ª£p",
                "sInfo": "Hi·ªÉn th·ªã _START_ ƒë·∫øn _END_ trong t·ªïng s·ªë _TOTAL_ m·ª•c",
                "sInfoEmpty": "Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong t·ªïng s·ªë 0 m·ª•c",
                "sInfoFiltered": "(ƒë∆∞·ª£c l·ªçc t·ª´ t·ªïng s·ªë _MAX_ m·ª•c)",
                "sSearch": "T√¨m ki·∫øm:",
                "oPaginate": {
                    "sFirst": "ƒê·∫ßu",
                    "sLast": "Cu·ªëi",
                    "sNext": "Ti·∫øp",
                    "sPrevious": "Tr∆∞·ªõc"
                }
            },
            columnDefs: [
                {
                    targets: TYPE_COL,
                    render: function (data, type, row) {
                        if (type === 'display') {
                            // Gi·ªØ l·∫°i badge m√†u s·∫Øc cho lo·∫°i h√†ng
                            let className = (data === 'Xe ƒëi·ªán') ? 'bg-success' : 'bg-warning text-dark';
                            return `<span class="badge ${className}">${data}</span>`;
                        }
                        return data;
                    }
                },
                {
                    targets: [SELL_PRICE_COL, COST_PRICE_COL],
                    render: function (data, type, row) {
                        const num = parseInt(data.toString().replace(/,/g, ''));
                        if (type === 'display' || type === 'filter') {
                            return formatCurrency(num);
                        }
                        return num;
                    },
                    className: 'text-end'
                },
                {
                    targets: [STOCK_COL, 6],
                    render: function (data, type, row) {
                        return parseInt(data);
                    },
                    className: 'text-center'
                }
            ]
        });

        /* -------------------------------------------
        // 2. LOGIC L·ªåC V√Ä T√åM KI·∫æM
        ------------------------------------------- */

        // a) L·ªçc theo Lo·∫°i h√†ng (C·ªôt 0)
        $('#typeFilter').on('change', function () {
            const typeValue = $(this).val();
            table.column(TYPE_COL).search(typeValue ? '^' + typeValue + '$' : '', true, false).draw();
        });

        // b) L·ªçc theo T·ªìn kho (C·ªôt 5)
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                if (settings.nTable.id !== 'productTable') {
                    return true;
                }

                const stockFilter = $('#stockFilter').val();
                const stock = parseInt(data[STOCK_COL]) || 0; 
                
                if (stockFilter === 'available') {
                    return stock > 0;
                } else if (stockFilter === 'outOfStock') {
                    return stock <= 0;
                }
                
                return true;
            }
        );
        
        $('#stockFilter').on('change', function () {
            table.draw();
        });

        // c) Global Search (T√¨m ki·∫øm to√†n c·ª•c)
        $('#globalSearchBox').on('keyup', function () {
            table.search(this.value).draw();
        });
        
    });
</script>