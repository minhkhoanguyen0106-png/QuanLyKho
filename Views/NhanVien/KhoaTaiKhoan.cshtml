@{
    ViewData["Title"] = "Kh√≥a T√†i Kho·∫£n Nh√¢n Vi√™n";
    var user = Context.Session.GetString("User");
}

<div class="container-fluid mt-3" style="font-family:'Segoe UI', sans-serif;">
    <!-- Console Debug Panel -->
    <div class="card border-info mb-3" id="debugPanel">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <strong>üêõ Debug Console</strong>
            <button class="btn btn-sm btn-light" onclick="toggleDebug()">Hide/Show</button>
        </div>
        <div class="card-body bg-light" id="debugContent" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            <div id="debugLog"></div>
        </div>
    </div>

    <!-- Ti√™u ƒë·ªÅ -->
    <div class="d-flex justify-content-between align-items-center p-3 rounded shadow-sm"
         style="background-color:#428446; color:white;">
        <h4 class="fw-semibold m-0">üîí Kh√≥a t√†i kho·∫£n nh√¢n vi√™n</h4>
        <div class="fw-semibold">
            Xin ch√†o, @(user ?? "Ng∆∞·ªùi d√πng")
        </div>
    </div>

    <!-- Danh s√°ch nh√¢n vi√™n ho·∫°t ƒë·ªông -->
    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header fw-semibold text-white" style="background-color:#428446;">
            Danh s√°ch t√†i kho·∫£n ƒëang ho·∫°t ƒë·ªông
        </div>
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0" id="employeeTable">
                <thead style="background-color:#cde9cd; color:#1f421f;">
                    <tr>
                        <th>#</th>
                        <th>M√£ NV</th>
                        <th>H·ªç v√† t√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ch·ª©c v·ª•</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-manv="NV002">
                        <td>1</td>
                        <td>NV002</td>
                        <td>L√™ VƒÉn C</td>
                        <td>levanc@email.com</td>
                        <td>0923456789</td>
                        <td>Nh√¢n vi√™n kho</td>
                        <td><span class="badge bg-success">Ho·∫°t ƒë·ªông</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm btn-lock" 
                                    data-manv="NV002" 
                                    data-name="L√™ VƒÉn C">
                                Kh√≥a
                            </button>
                        </td>
                    </tr>
                    <tr data-manv="NV003">
                        <td>2</td>
                        <td>NV003</td>
                        <td>Ph·∫°m Th·ªã D</td>
                        <td>phamthid@email.com</td>
                        <td>0934567890</td>
                        <td>Qu·∫£n l√Ω</td>
                        <td><span class="badge bg-success">Ho·∫°t ƒë·ªông</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm btn-lock" 
                                    data-manv="NV003" 
                                    data-name="Ph·∫°m Th·ªã D">
                                Kh√≥a
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Kh√≥a T√†i Kho·∫£n -->
<div class="modal fade" id="modalLockAccount" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark">Kh√≥a t√†i kho·∫£n nh√¢n vi√™n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc mu·ªën kh√≥a t√†i kho·∫£n c·ªßa nh√¢n vi√™n <strong id="employeeName"></strong> kh√¥ng?</p>
                <p class="text-muted small">M√£ NV: <span id="employeeCode"></span></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="btnConfirmLock">Kh√≥a</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Debug Logger
    function debugLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('vi-VN');
        const logDiv = document.getElementById('debugLog');
        const colors = {
            info: '#0d6efd',
            success: '#198754',
            warning: '#ffc107',
            error: '#dc3545'
        };
        
        const logEntry = document.createElement('div');
        logEntry.style.color = colors[type] || colors.info;
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        
        // Console log
        console.log(`[${timestamp}] ${message}`);
    }

    function toggleDebug() {
        const content = document.getElementById('debugContent');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }

    // Page Load
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('‚úÖ Trang KhoaTaiKhoan ƒë√£ load th√†nh c√¥ng', 'success');
        debugLog(`üìç URL: ${window.location.href}`, 'info');
        debugLog(`üë§ User: @(user ?? "NULL")`, 'info');
        
        const table = document.getElementById('employeeTable');
        if (table) {
            debugLog(`‚úÖ T√¨m th·∫•y b·∫£ng nh√¢n vi√™n`, 'success');
            const rows = table.querySelectorAll('tbody tr');
            debugLog(`üìä S·ªë l∆∞·ª£ng nh√¢n vi√™n: ${rows.length}`, 'info');
        } else {
            debugLog(`‚ùå KH√îNG t√¨m th·∫•y b·∫£ng nh√¢n vi√™n`, 'error');
        }

        // Ki·ªÉm tra Bootstrap
        if (typeof bootstrap !== 'undefined') {
            debugLog(`‚úÖ Bootstrap ƒë√£ load (version: ${bootstrap.Tooltip.VERSION || 'unknown'})`, 'success');
        } else {
            debugLog(`‚ùå Bootstrap CH∆ØA load`, 'error');
        }

        // Ki·ªÉm tra jQuery (n·∫øu c√≥)
        if (typeof jQuery !== 'undefined') {
            debugLog(`‚úÖ jQuery ƒë√£ load (version: ${jQuery.fn.jquery})`, 'success');
        }

        initializeLockButtons();
    });

    // Initialize Lock Buttons
    let currentMaNV = null;

    function initializeLockButtons() {
        debugLog('üîß ƒêang kh·ªüi t·∫°o c√°c n√∫t Kh√≥a...', 'info');
        
        const lockButtons = document.querySelectorAll('.btn-lock');
        debugLog(`üìä T√¨m th·∫•y ${lockButtons.length} n√∫t Kh√≥a`, 'info');
        
        lockButtons.forEach((btn, index) => {
            const maNV = btn.getAttribute('data-manv');
            const name = btn.getAttribute('data-name');
            
            debugLog(`  ‚îî‚îÄ N√∫t ${index + 1}: MaNV=${maNV}, Name=${name}`, 'info');
            
            btn.addEventListener('click', function() {
                debugLog(`üñ±Ô∏è Click n√∫t Kh√≥a - MaNV: ${maNV}`, 'warning');
                currentMaNV = maNV;
                
                document.getElementById('employeeName').textContent = name;
                document.getElementById('employeeCode').textContent = maNV;
                
                const modal = new bootstrap.Modal(document.getElementById('modalLockAccount'));
                modal.show();
                debugLog(`‚úÖ Modal ƒë√£ m·ªü`, 'success');
            });
        });
    }

    // Confirm Lock
    document.addEventListener('DOMContentLoaded', function() {
        const btnConfirm = document.getElementById('btnConfirmLock');
        
        if (btnConfirm) {
            btnConfirm.addEventListener('click', function() {
                debugLog(`üîí B·∫Øt ƒë·∫ßu kh√≥a t√†i kho·∫£n: ${currentMaNV}`, 'warning');
                
                if (!currentMaNV) {
                    debugLog(`‚ùå L·ªñI: currentMaNV = null`, 'error');
                    alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c m√£ nh√¢n vi√™n');
                    return;
                }

                // Disable button
                btnConfirm.disabled = true;
                btnConfirm.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
                
                debugLog(`üì° G·ª≠i POST request ƒë·∫øn /NhanVien/KhoaTaiKhoan`, 'info');
                
                fetch('/NhanVien/KhoaTaiKhoan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ maNV: currentMaNV })
                })
                .then(response => {
                    debugLog(`üì° Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                    return response.json();
                })
                .then(data => {
                    debugLog(`üì¶ Response Data: ${JSON.stringify(data)}`, 'info');
                    
                    if (data.success) {
                        debugLog(`‚úÖ Kh√≥a t√†i kho·∫£n th√†nh c√¥ng!`, 'success');
                        alert('Kh√≥a t√†i kho·∫£n th√†nh c√¥ng!');
                        
                        // ·∫®n row
                        const row = document.querySelector(`tr[data-manv="${currentMaNV}"]`);
                        if (row) {
                            row.remove();
                            debugLog(`‚úÖ ƒê√£ x√≥a row kh·ªèi b·∫£ng`, 'success');
                        }
                        
                        // ƒê√≥ng modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalLockAccount'));
                        modal.hide();
                    } else {
                        debugLog(`‚ùå L·ªói: ${data.message}`, 'error');
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    debugLog(`‚ùå EXCEPTION: ${error.message}`, 'error');
                    console.error('Full error:', error);
                    alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                })
                .finally(() => {
                    btnConfirm.disabled = false;
                    btnConfirm.innerHTML = 'Kh√≥a';
                    debugLog(`üèÅ Ho√†n t·∫•t x·ª≠ l√Ω`, 'info');
                });
            });
        } else {
            debugLog(`‚ùå KH√îNG t√¨m th·∫•y n√∫t Confirm`, 'error');
        }
    });
</script>
}