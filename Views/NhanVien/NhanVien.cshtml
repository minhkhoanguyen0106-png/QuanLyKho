@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var uniformColor = "#28a745"; 
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω nh√¢n vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Bi·∫øn CSS ƒë·ªìng b·ªô */
        :root {
            --primary-green-dark: #28a745; 
            --primary-green-light: #e8f9e8;
            --secondary-green-text: #1f421f;
            --background-color: #f7fcf7;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --border-color: #e1e1e1;
            --light-green-border: #cde8c8;
            --toast-success: #198754;
            --toast-error: #dc3545;
        }

        body {
            background-color: var(--background-color);
            font-family: "Segoe UI", sans-serif;
        }
        
        /* ====== HEADER CHUNG ====== */
        .app-header {
            background-color: var(--primary-green-dark);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* ====== CARD CHUNG ====== */
        .custom-card {
            background-color: #fff;
            border-radius: 8px; 
            box-shadow: 0 1px 6px var(--shadow-color);
            border: 1px solid var(--border-color);
            margin-bottom: 20px; 
        }

        /* ====== N√öT XANH ƒê·∫¨M (btn-xanhbo) & N√öT TR√äN HEADER ====== */
        .btn-xanhbo {
            background-color: var(--primary-green-dark);
            color: #fff;
            border: none;
            transition: 0.3s;
            font-weight: 500;
            border-radius: 4px; 
            padding: 8px 15px;
            font-size: 14px;
        }
        .btn-xanhbo:hover {
            background-color: #218838; 
            color: #fff;
        }
        .btn-outline-green {
             border: 1px solid var(--primary-green-dark);
             color: var(--primary-green-dark);
             background-color: transparent;
        }
        .btn-outline-green:hover {
            background-color: var(--primary-green-light);
            color: var(--primary-green-dark);
        }
        
        /* ====== THANH T√åM KI·∫æM & H√ÄNH ƒê·ªòNG ====== */
        .action-bar {
            padding: 12px 16px;
            display: flex; 
            gap: 10px;
        }
        .form-control, .form-select {
            border-radius: 4px;
            font-size: 14px;
            border-color: var(--light-green-border);
        }
        
        /* ====== B·∫¢NG D·ªÆ LI·ªÜU ====== */
        .table thead {
            background-color: var(--primary-green-light); 
            color: var(--secondary-green-text);
            font-weight: 600;
            font-size: 14px;
        }
        .table th, .table td {
            padding: 10px 15px;
            vertical-align: middle;
        }

        /* BADGES */
        .badge-status {
            font-size: 12px;
            padding: 6px 8px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-block;
            line-height: 1; 
        }
        /* ƒê·ªìng b·ªô m√†u s·∫Øc v·ªõi gi√° tr·ªã ti·∫øng Vi·ªát t·ª´ Controller */
        .bg-active { background-color: #28a745; color: white; } 
        .bg-locked { background-color: #dc3545; color: white; } 
        .bg-inactive { background-color: #6c757d; color: white; } /* M√†u x√°m cho ngh·ªâ vi·ªác */
        
        /* N√∫t S·ª≠a/Kh√≥a trong b·∫£ng */
        .btn-sm-action {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            font-weight: 500;
            line-height: 1;
        }

        /* Footer ƒë∆°n gi·∫£n */
        .app-footer {
            padding: 10px 0;
            text-align: right;
            font-size: 12px;
            color: #6c757d;
        }

        /* Toast Notification */
        #customToast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
            padding: 10px 15px;
            color: #fff;
            border-radius: 5px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast-success { background-color: var(--toast-success); }
        .toast-error { background-color: var(--toast-error); }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        
        <div class="app-header d-flex justify-content-between align-items-center">
            <h4 class="fw-semibold m-0"><i class="fa-solid fa-users"></i> Qu·∫£n l√Ω Nh√¢n vi√™n</h4>
        </div>
        
        <div class="custom-card action-bar">
            <input type="text" id="globalSearchBox" class="form-control" placeholder="üîç T√¨m theo M√£ NV, H·ªç t√™n..." style="max-width: 250px;">
            
            <button class="btn btn-xanhbo" data-bs-toggle="modal" data-bs-target="#employeeModal" onclick="prepareForm('add')">
                <i class="fa fa-plus"></i> Th√™m Nh√¢n vi√™n m·ªõi
            </button>
            
            <div class="ms-auto d-flex align-items-center">
                <select id="filterStatus" class="form-select form-select-sm" style="width: 170px;" onchange="applyFilter()">
                    <option value="">T·∫•t c·∫£ Tr·∫°ng th√°i</option>
                    <option value="Ho·∫°t ƒë·ªông">ƒêang ho·∫°t ƒë·ªông</option>
                    <option value="B·ªã kh√≥a">B·ªã kh√≥a</option>
                    <option value="Ngh·ªâ vi·ªác">Ngh·ªâ vi·ªác</option>
                </select>
            </div>
        </div>

        <div class="custom-card p-0 table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-success">
                    <tr>
                        <th>M√£ NV</th>
                        <th>H·ªç t√™n</th>
                        <th>Ch·ª©c v·ª•</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <tr><td colspan="6" class="text-center p-4 text-muted"><i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="app-footer">
            <span>¬© 2025</span> | <span>Kho Ebike System</span>
        </div>
    </div>
    
    <div id="customToast" class="toast-success" role="alert" aria-live="assertive" aria-atomic="true">
        <span id="toastMessage"></span>
    </div>

    <div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--primary-green-dark); color: white;">
                    <h5 class="modal-title" id="employeeModalLabel">Th√™m Nh√¢n vi√™n m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="employeeForm">
                        <input type="hidden" id="employeeIdInput">
                        <div class="mb-3">
                            <label for="idInput" class="form-label">M√£ NV</label>
                            <input type="text" class="form-control" id="idInput" required maxlength="20" placeholder="V√≠ d·ª•: NV005">
                        </div>
                        <div class="mb-3">
                            <label for="nameInput" class="form-label">H·ªç t√™n</label>
                            <input type="text" class="form-control" id="nameInput" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="positionInput" class="form-label">Ch·ª©c v·ª•</label>
                            <select class="form-select" id="positionInput" required>
                                <option value="">Ch·ªçn ch·ª©c v·ª•</option>
                                <option value="Qu·∫£n l√Ω kho">Qu·∫£n l√Ω kho</option>
                                <option value="Nh√¢n vi√™n b√°n h√†ng">Nh√¢n vi√™n b√°n h√†ng</option>
                                <option value="K·∫ø to√°n">K·∫ø to√°n</option>
                                <option value="Nh√¢n vi√™n kho">Nh√¢n vi√™n kho</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="phoneInput" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="phoneInput" pattern="[0-9]{10,11}" title="Ch·ªâ ch·∫•p nh·∫≠n s·ªë ƒëi·ªán tho·∫°i (10-11 ch·ªØ s·ªë)" required maxlength="20">
                        </div>
                        <div class="mb-3" id="statusGroup" style="display:none;">
                            <label for="statusInput" class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="statusInput" required>
                                <option value="Ho·∫°t ƒë·ªông">ƒêang ho·∫°t ƒë·ªông</option>
                                <option value="B·ªã kh√≥a">B·ªã kh√≥a</option>
                                <option value="Ngh·ªâ vi·ªác">Ngh·ªâ vi·ªác</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-xanhbo" id="saveEmployeeBtn" onclick="saveEmployee()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentEmployees = []; // L∆∞u tr·ªØ d·ªØ li·ªáu nh√¢n vi√™n hi·ªán t·∫°i
        let currentMode = 'add'; // 'add' or 'edit'

        // Mapping tr·∫°ng th√°i
        const statusClassMap = {
            'Ho·∫°t ƒë·ªông': 'bg-active',
            'B·ªã kh√≥a': 'bg-locked',
            'Ngh·ªâ vi·ªác': 'bg-inactive'
        };

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showToast(message, isSuccess = true) {
            const toast = $('#customToast');
            const messageEl = $('#toastMessage');
            
            toast.removeClass('toast-success toast-error').addClass(isSuccess ? 'toast-success' : 'toast-error');
            messageEl.text(message);
            
            toast.fadeIn(300).delay(3000).fadeOut(300); // Hi·ªÉn th·ªã 3 gi√¢y
        }

        // H√†m l·∫•y Badge tr·∫°ng th√°i
        function getStatusBadge(status) {
            const className = statusClassMap[status] || 'bg-secondary';
            return `<span class="badge badge-status ${className}">${status}</span>`;
        }
        
        // H√†m t·∫°o n√∫t H√†nh ƒë·ªông
        function renderActionButtons(employee) {
            let lockUnlockButton;
            const isLocked = employee.trangThai === 'B·ªã kh√≥a';
            const isActive = employee.trangThai === 'Ho·∫°t ƒë·ªông';
            
            if (isActive) {
                // ƒêang ho·∫°t ƒë·ªông -> Cho ph√©p Kh√≥a
                lockUnlockButton = `
                    <button class="btn btn-sm-action btn-danger ms-2" title="Kh√≥a t√†i kho·∫£n" onclick="toggleStatus('${employee.maNV}', 'B·ªã kh√≥a', '${employee.tenNV}')">
                        <i class="fa fa-lock"></i> Kh√≥a
                    </button>
                `;
            } else if (isLocked) {
                // B·ªã kh√≥a -> Cho ph√©p M·ªü
                lockUnlockButton = `
                    <button class="btn btn-sm-action btn-success ms-2" title="M·ªü kh√≥a t√†i kho·∫£n" onclick="toggleStatus('${employee.maNV}', 'Ho·∫°t ƒë·ªông', '${employee.tenNV}')">
                        <i class="fa fa-unlock"></i> M·ªü kh√≥a
                    </button>
                `;
            } else {
                // Ngh·ªâ vi·ªác (kh√¥ng cho ph√©p thay ƒë·ªïi tr·∫°ng th√°i)
                lockUnlockButton = '';
            }

            return `
                <button class="btn btn-sm-action btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#employeeModal" onclick="prepareForm('edit', '${employee.maNV}')">
                    <i class="fa fa-pen"></i> S·ª≠a
                </button>
                ${lockUnlockButton}
            `;
        }

        /**
         * Render l·∫°i b·∫£ng nh√¢n vi√™n d·ª±a tr√™n d·ªØ li·ªáu t·ª´ Server.
         */
        function renderTable(data) {
            const tbody = $('#employeeTableBody');
            tbody.empty();
            
            if (data.length === 0) {
                tbody.html(`<tr><td colspan="6" class="text-center p-4 text-muted">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o ph√π h·ª£p.</td></tr>`);
                return;
            }

            data.forEach(emp => {
                const row = `
                    <tr>
                        <td>${emp.maNV}</td>
                        <td>${emp.tenNV}</td>
                        <td>${emp.viTri}</td>
                        <td>${emp.dienThoai}</td>
                        <td>${getStatusBadge(emp.trangThai)}</td>
                        <td class="text-center">${renderActionButtons(emp)}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        /**
         * L·∫•y d·ªØ li·ªáu nh√¢n vi√™n t·ª´ Controller (AJAX POST)
         */
        function fetchEmployees() {
            const searchTerm = $('#globalSearchBox').val();
            const statusFilter = $('#filterStatus').val();
            
            $('#employeeTableBody').html(`<tr><td colspan="6" class="text-center p-4 text-muted"><i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>`);

            $.ajax({
                url: '/NhanVien/GetDanhSachNhanVien', // G·ªçi Action 2 trong Controller
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ SearchTerm: searchTerm, StatusFilter: statusFilter }),
                success: function(data) {
                    currentEmployees = data;
                    // L·ªçc th√™m theo tr·∫°ng th√°i ·ªü Client side n·∫øu c·∫ßn (Controller ƒë√£ l·ªçc theo SearchTerm)
                    let filteredData = data;
                    if (statusFilter) {
                        filteredData = data.filter(emp => emp.trangThai === statusFilter);
                    }
                    renderTable(filteredData);
                },
                error: function(xhr) {
                    let errorMsg = "L·ªói Server khi t·∫£i d·ªØ li·ªáu.";
                    try {
                        const responseJson = JSON.parse(xhr.responseText);
                        errorMsg = responseJson.message || errorMsg;
                    } catch (e) {}
                    $('#employeeTableBody').html(`<tr><td colspan="6" class="text-center p-4 text-danger">L·ªói: ${errorMsg}</td></tr>`);
                    showToast("T·∫£i d·ªØ li·ªáu th·∫•t b·∫°i: " + errorMsg, false);
                }
            });
        }

        /**
         * √Åp d·ª•ng b·ªô l·ªçc v√† t√¨m ki·∫øm.
         */
        function applyFilter() {
            // T·∫°m th·ªùi ch·ªâ c·∫ßn g·ªçi l·∫°i fetchEmployees ƒë·ªÉ Server x·ª≠ l√Ω SearchTerm v√† FilterStatus
            fetchEmployees();
        }

        // --- Qu·∫£n l√Ω Form Modal ---

        /**
         * Thi·∫øt l·∫≠p form cho ch·∫ø ƒë·ªô Th√™m m·ªõi ho·∫∑c Ch·ªânh s·ª≠a.
         */
        function prepareForm(mode, id = null) {
            currentMode = mode;
            const modalTitle = $('#employeeModalLabel');
            const saveBtn = $('#saveEmployeeBtn');
            const form = $('#employeeForm')[0];
            const idInput = $('#idInput');
            const statusGroup = $('#statusGroup');

            // 1. Reset Form
            form.reset(); 
            $('#employeeIdInput').val('');
            statusGroup.hide();

            if (mode === 'add') {
                modalTitle.text('Th√™m Nh√¢n vi√™n m·ªõi');
                saveBtn.text('L∆∞u');
                idInput.prop('disabled', false); // M√£ NV c√≥ th·ªÉ nh·∫≠p
                
            } else if (mode === 'edit' && id) {
                modalTitle.text('Ch·ªânh s·ª≠a th√¥ng tin Nh√¢n vi√™n');
                saveBtn.text('C·∫≠p nh·∫≠t');
                idInput.prop('disabled', true); // M√£ NV kh√¥ng ƒë∆∞·ª£c s·ª≠a khi Edit
                statusGroup.show();
                
                const emp = currentEmployees.find(e => e.maNV === id);
                if (emp) {
                    // ƒê·ªï d·ªØ li·ªáu v√†o form
                    $('#employeeIdInput').val(emp.maNV);
                    idInput.val(emp.maNV); // ƒê·ªï v√†o √¥ hi·ªÉn th·ªã MaNV
                    $('#nameInput').val(emp.tenNV);
                    $('#positionInput').val(emp.viTri);
                    $('#phoneInput').val(emp.dienThoai);
                    $('#statusInput').val(emp.trangThai);
                }
            }
        }
        
        /**
         * X·ª≠ l√Ω l∆∞u th√¥ng tin (Th√™m m·ªõi ho·∫∑c C·∫≠p nh·∫≠t) qua AJAX.
         */
        function saveEmployee() {
            const maNV = $('#idInput').val();
            const tenNV = $('#nameInput').val();
            const viTri = $('#positionInput').val();
            const dienThoai = $('#phoneInput').val();
            let trangThai = "Ho·∫°t ƒë·ªông"; // M·∫∑c ƒë·ªãnh cho Add
            
            if (!maNV || !tenNV || !viTri || !dienThoai) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.");
                return;
            }

            const employeeData = {
                MaNV: maNV,
                TenNV: tenNV,
                ViTri: viTri,
                DienThoai: dienThoai
            };

            let url = '';
            if (currentMode === 'add') {
                url = '/NhanVien/AddNhanVien'; // G·ªçi Action 3
            } else if (currentMode === 'edit') {
                url = '/NhanVien/UpdateNhanVien'; // G·ªçi Action 4
                employeeData.TrangThai = $('#statusInput').val(); // L·∫•y tr·∫°ng th√°i t·ª´ form khi Edit
            }

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(employeeData),
                success: function(response) {
                    showToast(response.message, true);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('employeeModal'));
                    modal.hide();
                    fetchEmployees(); // T·∫£i l·∫°i d·ªØ li·ªáu
                },
                error: function(xhr) {
                    let errorMsg = "L·ªói k·∫øt n·ªëi Server.";
                    try {
                        const responseJson = JSON.parse(xhr.responseText);
                        errorMsg = responseJson.message || errorMsg;
                    } catch (e) {
                         if (xhr.status === 409) errorMsg = "M√£ nh√¢n vi√™n ƒë√£ t·ªìn t·∫°i.";
                         else if (xhr.status === 404) errorMsg = "Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n c·∫ßn c·∫≠p nh·∫≠t.";
                         else errorMsg = "L·ªói Server kh√¥ng x√°c ƒë·ªãnh.";
                    }
                    showToast(errorMsg, false);
                }
            });
        }
        
        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i (Kh√≥a/M·ªü) nh√¢n vi√™n qua AJAX.
         */
        function toggleStatus(maNV, newStatus, tenNV) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn tr·∫°ng th√°i nh√¢n vi√™n ${tenNV} sang '${newStatus}'?`)) {
                return;
            }

            const data = {
                MaNV: maNV,
                NewStatus: newStatus
            };

            $.ajax({
                url: '/NhanVien/UpdateTrangThai', // G·ªçi Action 6
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    showToast(response.message, true);
                    fetchEmployees(); // T·∫£i l·∫°i d·ªØ li·ªáu
                },
                error: function(xhr) {
                    let errorMsg = "L·ªói Server khi c·∫≠p nh·∫≠t tr·∫°ng th√°i.";
                    try {
                        const responseJson = JSON.parse(xhr.responseText);
                        errorMsg = responseJson.message || errorMsg;
                    } catch (e) {}
                    showToast(errorMsg, false);
                }
            });
        }
        
        // G·∫Øn s·ª± ki·ªán cho √¥ t√¨m ki·∫øm v√† b·ªô l·ªçc
        $('#globalSearchBox').on('keyup', function() {
            // D√πng debounce n·∫øu mu·ªën t·ªëi ∆∞u h∆°n, hi·ªán t·∫°i c·ª© g·ªçi applyFilter
            applyFilter();
        });
        
        // Kh·ªüi t·∫°o b·∫£ng khi trang t·∫£i xong
        $(document).ready(function() {
            fetchEmployees(); // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
        });
    </script>
</body>
</html>