@model IEnumerable<QuanLyKho.Models.PhieuNhap> 
@{
    ViewBag.Title = "Danh sách phiếu nhập";
    Layout = "/Views/Shared/_Layout.cshtml";
}

<style>
    /* ... Giữ nguyên phần Style ... */
    .app-header {
        background-color: #28a745; 
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between; 
        align-items: center;
        position: sticky; top: 0; z-index: 1000;
    }
    .app-header .btn-header-group { display: flex; align-items: center; }
    .app-header .btn-white-green-text {
        color: #28a745 !important; background-color: white !important;
        border: 1px solid white !important; font-weight: bold;
        margin-left: 5px; padding: 0.25rem 0.5rem; font-size: 0.8rem;
        display: inline-flex; align-items: center; justify-content: center;
    }

    /* 2. NÚT BẤM THẲNG HÀNG */
    .action-buttons { display: flex; align-items: center; gap: 5px; height: 100%; }
    .action-buttons .btn {
        white-space: nowrap !important; height: 38px;
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 90px; font-weight: 600; border-radius: 5px; padding: 0 12px;
    }
    #searchInput { height: 38px; }
    .input-group-append .btn {
        height: 38px; display: flex; align-items: center; justify-content: center;
        padding-top: 0; padding-bottom: 0;
    }
    #phieuNhapTable tbody tr td:nth-child(3) { max-width: 200px; word-break: break-word; white-space: normal; }

    /* 3. RESPONSIVE */
    @@media (max-width: 767.98px) {
        .app-header h4 { max-width: 50%; font-size: 1.1rem; }
        .app-header .btn-header-group { overflow-x: auto; white-space: nowrap; justify-content: flex-end; }
        .action-buttons .btn { font-size: 0.8rem; padding: 0 8px; }
    }
    @@media (min-width: 768px) { .app-header { display: none !important; } }

    /* 4. IN ẤN */
    @@media print {
        .app-header, .main-sidebar, .main-header, .action-buttons, #filterCollapseContent, #searchBtn, #searchInput, .main-footer, .card-header, #selectAll {
            display: none !important;
        }
        .content-wrapper { margin-left: 0 !important; padding-top: 0 !important; background: white !important; }
        .card { box-shadow: none !important; border: none !important; }
        table { width: 100% !important; border-collapse: collapse !important; }
        th, td { border: 1px solid #000 !important; padding: 5px !important; color: #000 !important; }
    }
</style>

<div class="app-header">
    <h4 class="m-0 font-weight-bold"><i class="fas fa-file-export mr-2"></i> Phiếu nhập hàng</h4>
    <div class="btn-header-group d-flex d-md-none">
        <a href="@Url.Action("Create", "NhapHang")" class="btn btn-white-green-text">
            <i class="fas fa-plus"></i>
        </a>
        <button class="btn btn-white-green-text" id="btnPrintMobile"><i class="fas fa-print"></i></button>
        <button class="btn btn-white-green-text" id="btnExportMobile"><i class="fas fa-file-excel"></i></button>
    </div>
</div>

<section class="content">
    <div class="container-fluid pt-3">
        <div class="d-none d-md-flex justify-content-between align-items-center mb-3">
            <h3 class="font-weight-bold text-dark m-0">Danh sách phiếu nhập</h3>
        </div>

        <div class="row">
            <div class="col-12 col-md-3 mb-3 collapse d-md-block" id="filterCollapseContent">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="font-weight-bold mb-3 text-dark">Bộ lọc phiếu nhập</h5>

                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Chi nhánh</label>
                            <select class="form-control" id="chiNhanhFilter">
                                <option value="">Tất cả</option>
                                <option value="CN Nguyễn Văn Cừ - Cần Thơ">CN Nguyễn Văn Cừ</option>
                                <option value="CN Ninh Kiều">CN Ninh Kiều</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Người tạo</label>
                            <select class="form-control" id="nguoiTaoFilter">
                                <option value="">Tất cả</option>
                                @if (Model != null)
                                {
                                    var creatorNames = Model.Where(p => p.NhanVien != null).Select(p => p.NhanVien.TenNV).Distinct();
                                    foreach (var name in creatorNames)
                                    {
                                        <option value="@name">@name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Tổng tiền (Từ - Đến)</label>
                            <div class="d-flex">
                                <input type="number" class="form-control mr-2" id="minTotalFilter" placeholder="Từ" min="0" />
                                <input type="number" class="form-control" id="maxTotalFilter" placeholder="Đến" min="0" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label font-weight-bold text-dark">Thời gian</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="thoigian" id="thangnay" value="month" checked>
                                <label class="form-check-label text-dark" for="thangnay">Tháng này</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="thoigian" id="tuychinh" value="custom">
                                <label class="form-check-label text-dark" for="tuychinh">Tùy chỉnh</label>
                            </div>
                            <input type="date" class="form-control" id="dateFilter" style="display:none;" /> 
                        </div>
                        <button class="btn btn-success btn-block font-weight-bold mt-3" id="applyFilter">
                            <i class="fas fa-filter"></i> Áp dụng bộ lọc
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="d-flex align-items-center mb-3">
                    <div class="input-group flex-grow-1 mr-2">
                        <input type="text" class="form-control" id="searchInput" placeholder="Theo mã phiếu, khách hàng..." />
                        <div class="input-group-append">
                            <button class="btn btn-success" id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-secondary d-md-none" type="button" data-toggle="collapse" data-target="#filterCollapseContent">
                        <i class="fas fa-filter"></i> 
                    </button>
                    
                    <div class="ml-auto d-none d-md-flex action-buttons">
                        <a href="@Url.Action("Create", "NhapHang")" class="btn btn-success font-weight-bold mr-2">
                            <i class="fas fa-plus"></i> Tạo phiếu nhập
                        </a>
                        <button class="btn btn-outline-success mr-2" id="btnPrint">
                            <i class="fas fa-print mr-1"></i> In danh sách
                        </button>
                        <button class="btn btn-outline-secondary" id="btnExport">
                            <i class="fas fa-file-excel mr-1"></i> Xuất Excel
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header font-weight-bold bg-success text-white">
                        Danh sách phiếu nhập
                    </div>
                    <div class="card-body p-0 table-responsive">
                         <table class="table table-hover align-middle mb-0 text-center" id="phieuNhapTable">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th><input type="checkbox" id="selectAll" /></th>
                                    <th>Mã phiếu</th>
                                    <th>Tên hàng hóa</th>
                                    <th>Ngày tạo</th>
                                    <th>Người tạo</th>
                                    <th>Tổng tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null)
                                {
                                   @foreach (var item in Model)
                                {
                                <tr 
                                data-chinhanh="@(item.NhaCungCap?.TenNCC)" @* VẪN GIỮ NGUYÊN (Cho bộ lọc JS) *@
                                data-nguoitao="@(item.NhanVien?.TenNV)"> @* VẪN GIỮ NGUYÊN (Cho bộ lọc JS) *@
                                <td><input type="checkbox" /></td>
                                <td class="fw-bold text-success">@item.MaPN</td>
                                <td class="column-sanpham">
                                    @if (item.ChiTietPhieuNhap != null && item.ChiTietPhieuNhap.Any())
                                    {
                                        <span>@item.ChiTietPhieuNhap.First().MaHH</span>
                                        <span>(...@item.ChiTietPhieuNhap.Count() mặt hàng)</span> 
                                    }
                                    else
                                    {
                                        <span>Không có chi tiết</span>
                                    }
                                </td>
                                <td>@(item.NgayNhap?.ToString("dd/MM/yyyy"))</td>
                                <td>@(item.NhanVien?.TenNV)</td> @* Hiển thị Tên Người tạo *@
                                <td class="fw-bold">@item.TongGiaTri?.ToString("N0") ₫</td> </tr>
                                }
                                }
                            </tbody>
                        </table>
                    </div>

                    @* CẬP NHẬT ĐIỀU KIỆN HIỂN THỊ NO-RESULTS DỰA TRÊN MODEL *@
                    <div class="text-center py-5 text-muted" id="noResults" 
                         style="@(Model == null || !Model.Any() ? "" : "display:none;")">
                        <i class="fas fa-inbox fa-3x text-secondary"></i>
                        <p class="mt-2">Không tìm thấy kết quả</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 1. XỬ LÝ NÚT IN & EXPORT
            $('#btnPrint, #btnPrintMobile').click(function() { window.print(); });
            
            $('#btnExport, #btnExportMobile').click(function() {
                var html = document.getElementById("phieuNhapTable").outerHTML;
                var blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.download = "DanhSachPhieuNhap.xls";
                link.href = url;
                link.click();
            });

            // 2. LOGIC LỌC & TÌM KIẾM
            $('#dateFilter').hide();
            $('input[name="thoigian"]').change(function () {
                if ($(this).val() === 'custom') $('#dateFilter').slideDown();
                else { $('#dateFilter').slideUp(); $('#dateFilter').val(''); }
            });

            $('#applyFilter').click(function () {
                if ($(window).width() < 768) $('#filterCollapseContent').collapse('hide');
                performFilter();
            });

            $('#searchBtn').click(function () { performSearch(); });
            $('#searchInput').on('keyup', function (e) { if (e.key === 'Enter') performSearch(); });

            function performSearch() {
                var keyword = $('#searchInput').val().toLowerCase().trim();
                var found = false;
                $('#phieuNhapTable tbody tr').each(function () {
                    var text = $(this).text().toLowerCase();
                    if (text.indexOf(keyword) > -1) { $(this).show(); found = true; }
                    else { $(this).hide(); }
                });
                toggleNoResults(!found);
            }

            function performFilter() {
                var cn = $('#chiNhanhFilter').val();
                var user = $('#nguoiTaoFilter').val();
                var date = $('input[name="thoigian"]:checked').val() === 'custom' ? $('#dateFilter').val() : '';
                
                // Lấy giá trị lọc Tổng tiền
                var minTotal = parseFloat($('#minTotalFilter').val()) || 0;
                var maxTotal = parseFloat($('#maxTotalFilter').val()) || Infinity;

                var visibleCount = 0;

                $('#phieuNhapTable tbody tr').each(function () {
                    var row = $(this);
                    var rCN = row.data('chinhanh');
                    var rUser = row.data('nguoitao');
                    var rDate = row.find('td:eq(3)').text().trim();
                    
                    // Lấy giá trị Tổng tiền từ cột thứ 6 (index 5) và chuyển thành số
                    // Loại bỏ ký tự không phải số và dấu phân cách (dấu chấm)
                    var rTotalText = row.find('td:eq(5)').text().replace(/[^0-9.]/g, ''); 
                    var rTotal = parseFloat(rTotalText.replace(/\./g, '')) || 0;

                    var show = true;
                    // Lọc Chi nhánh
                    if (cn && rCN.indexOf(cn) === -1) show = false;
                    
                    // Lọc Người tạo
                    if (user && rUser !== user) show = false;
                    
                    // Lọc Ngày tạo
                    if (date) {
                        var fDate = date.split('-').reverse().join('/');
                        if (rDate !== fDate) show = false;
                    }

                    // Lọc Tổng tiền (Phạm vi)
                    if (rTotal < minTotal || rTotal > maxTotal) show = false;

                    if (show) { row.show(); visibleCount++; } else { row.hide(); }
                });
                
                toggleNoResults(visibleCount === 0);
            }

            function toggleNoResults(isEmpty) {
                if (isEmpty) { $('#noResults').show(); $('#phieuNhapTable').hide(); }
                else { $('#noResults').hide(); $('#phieuNhapTable').show(); }
            }
            
            $('#selectAll').click(function () {
                $('#phieuNhapTable tbody input[type="checkbox"]').prop('checked', this.checked);
            });
        });
    </script>
}