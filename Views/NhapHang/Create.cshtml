@{
    ViewData["Title"] = "Th√™m phi·∫øu nh·∫≠p h√†ng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Link CSS ri√™ng -->
<link rel="stylesheet" href="~/css/nhaphang_create.css" />

<div class="container mt-4">
    <a href="@Url.Action("Index", "NhapHang")" class="text-primary d-inline-block mb-3">
        ‚¨Ö Quay l·∫°i danh s√°ch phi·∫øu nh·∫≠p
    </a>

    <h2 class="mb-4">Th√™m phi·∫øu nh·∫≠p h√†ng</h2>

    <div class="row g-3">
        <!-- B·∫£ng h√†ng h√≥a -->
        <div class="col-12 col-lg-8">
            <div class="card p-3">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="T√¨m h√†ng h√≥a theo m√£ ho·∫∑c t√™n (F3)" />

                <div class="table-responsive" style="max-height:500px; overflow:auto;">
                    <table class="table table-bordered align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>STT</th>
                                <th>M√£ h√†ng</th>
                                <th>T√™n h√†ng</th>
                                <th>ƒêVT</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>Gi·∫£m gi√°</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="productTable">
                            <!-- Demo: th√™m s·∫£n ph·∫©m t·ª´ JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-2">
                    <input type="file" id="fileInput" style="display:none;" onchange="updateFileName()" />
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                        üìÇ Ch·ªçn file d·ªØ li·ªáu
                    </button>
                    <span id="fileName" class="ms-2"></span>
                </div>
            </div>
        </div>

        <!-- Th√¥ng tin phi·∫øu -->
        <div class="col-12 col-lg-4">
            <div class="card p-3">
                <div class="mb-3">
                    <label>Nh√† cung c·∫•p</label>
                    <input type="text" placeholder="T√¨m nh√† cung c·∫•p" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>M√£ phi·∫øu nh·∫≠p</label>
                    <input type="text" placeholder="M√£ phi·∫øu t·ª± ƒë·ªông" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Tr·∫°ng th√°i</label>
                    <input type="text" value="Phi·∫øu t·∫°m" readonly class="form-control" />
                </div>
                <div class="mb-3">
                    <label>T·ªïng ti·ªÅn h√†ng</label>
                    <input type="text" value="0" readonly class="form-control" id="tongTien" />
                </div>
                <div class="mb-3">
                    <label>Gi·∫£m gi√°</label>
                    <input type="number" value="0" class="form-control" id="giamGia" />
                </div>
                <div class="mb-3">
                    <label>C·∫ßn tr·∫£ nh√† cung c·∫•p</label>
                    <input type="text" value="0" readonly class="form-control text-primary fw-bold" id="canTra" />
                </div>
                <div class="mb-3">
                    <label>Ghi ch√∫</label>
                    <textarea rows="3" placeholder="Ghi ch√∫" class="form-control"></textarea>
                </div>

                <form method="post">
                    <div class="d-flex flex-column flex-sm-row gap-2">
                        <button type="submit" formaction="/Phieu/Nhap/LuuTam" class="btn btn-primary flex-fill">üíæ L∆∞u t·∫°m</button>
                        <button type="submit" formaction="/Phieu/Nhap/HoanThanh" class="btn btn-success flex-fill">‚úÖ Ho√†n th√†nh</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Hi·ªÉn th·ªã t√™n file
    function updateFileName() {
        const input = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        if(input.files.length > 0) fileName.textContent = input.files[0].name;
    }

    // Demo d·ªØ li·ªáu s·∫£n ph·∫©m
    const productTable = document.getElementById('productTable');
    const demoProducts = [
        {stt:1, ma:'H001', ten:'Xe ƒë·∫°p A', dvt:'C√°i', sl:1, dg:5000000, gg:0},
        {stt:2, ma:'H002', ten:'Xe ƒë·∫°p B', dvt:'C√°i', sl:2, dg:3000000, gg:0}
    ];

    function renderProducts() {
        productTable.innerHTML = '';
        demoProducts.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.stt}</td>
                <td>${p.ma}</td>
                <td>${p.ten}</td>
                <td>${p.dvt}</td>
                <td><input type="number" class="form-control so-luong" value="${p.sl}" min="0"/></td>
                <td><input type="number" class="form-control don-gia" value="${p.dg}" min="0"/></td>
                <td><input type="number" class="form-control giam-gia" value="${p.gg}" min="0"/></td>
                <td><input type="text" class="form-control thanh-tien" value="0" readonly/></td>
            `;
            productTable.appendChild(tr);
        });
        tinhTien();
        addInputListeners();
    }

    function tinhTien() {
        let tong = 0;
        document.querySelectorAll('#productTable tr').forEach(row => {
            const sl = parseFloat(row.querySelector('.so-luong')?.value || 0);
            const dg = parseFloat(row.querySelector('.don-gia')?.value || 0);
            const gg = parseFloat(row.querySelector('.giam-gia')?.value || 0);
            const tt = sl * dg - gg;
            row.querySelector('.thanh-tien')?.setAttribute('value', tt.toLocaleString());
            tong += tt;
        });
        const giamGia = parseFloat(document.getElementById('giamGia').value || 0);
        document.getElementById('tongTien').value = tong.toLocaleString();
        document.getElementById('canTra').value = (tong - giamGia).toLocaleString();
    }

    function addInputListeners() {
        document.querySelectorAll('.so-luong, .don-gia, .giam-gia').forEach(input => {
            input.addEventListener('input', tinhTien);
        });
        document.getElementById('giamGia').addEventListener('input', tinhTien);
    }

    renderProducts();
</script>
}