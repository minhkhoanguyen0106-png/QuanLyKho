@model List<QuanLyKho.Models.NCC>
@{
    ViewData["Title"] = "Danh sách Nhà Cung Cấp";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<style>
/* ----------------------------------------------------- */
/* KIOTVIET-STYLE CSS & RESPONSIVE FIX */
/* ----------------------------------------------------- */

/* LAYOUT CƠ BẢN */
body { background: #f5f7fa; margin:0; }
.page-content { display: flex; gap: 20px; padding: 20px; max-width: 1400px; margin: auto; }
.filter-sidebar-wrapper { 
    width: 280px; 
    flex-shrink: 0; 
    transition: all .35s; 
}
.filter-sidebar { 
    background: white; 
    padding: 15px; 
    border-radius: 4px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    position: sticky;
    top: 20px;
}
.main-content { flex: 1; background: white; padding: 15px; border-radius: 4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.main-actions { display: flex; justify-content: space-between; margin-bottom: 15px; align-items:center; flex-wrap:wrap; }

/* INPUT & SELECT KIOTVIET-STYLE */
.filter-sidebar label { font-weight: 600; font-size: 0.9em; margin-top: 15px; display: block; }
.filter-sidebar h4 { font-size: 1.1em; margin-bottom: 5px; }
.filter-sidebar select, 
.filter-sidebar input[type="number"], 
.filter-sidebar input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    margin-bottom: 5px;
    border-radius: 4px;
    border: 1px solid #ddd;
    box-sizing: border-box;
    font-size: 0.95em;
    min-height: 38px;
}
.input-range-group {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

/* SEARCH BAR */
.search-container {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px 10px;
    width: 350px;
    max-width: 100%;
    background: #fff;
}
.search-container i { color: #888; margin-right: 8px; }
#searchBox {
    border: none;
    outline: none;
    padding: 0;
    width: 100%;
    font-size: 0.95em;
}

/* BUTTONS */
.action-buttons button {
    padding: 8px 15px;
    border-radius: 4px;
    border: none;
    cursor:pointer;
    font-weight: 500;
    transition:.2s;
    font-size: 0.95em;
}
#addSupplierBtn { background:#28a745; color:#fff; }
#exportBtn { background:#007bff; color:#fff; }

/* CHỈNH MÀU NÚT LƯU NHÀ CUNG CẤP (YÊU CẦU MỚI) */
#saveSupplierBtn { 
    background:#28a745; 
    color:#fff; 
    font-weight: 600; /* Tăng độ đậm để nổi bật */
}

/* STATUS FILTER GROUP */
.statusFilter {
    padding: 8px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 4px;
    margin-bottom: 4px;
    font-size: 0.9em;
}
.statusFilter.active {
    background: #28a745;
    color: #fff;
    border-color: #28a745;
}

/* DATATABLES */
.dataTables_filter, .dataTables_info, .dt-buttons, .dataTables_length { display: none !important; }
td.details-control i { color: #007bff; }
#supplierTable th { font-weight: 600; }

/* RESPONSIVE CSS */
@@media(max-width: 992px){
    .filter-sidebar-wrapper{ 
        position: fixed; 
        top:0; left:0; 
        width: 80%; max-width: 300px; 
        height:100vh; 
        padding:20px 0;
        box-shadow:3px 0 12px rgba(0,0,0,0.15); 
        transform: translateX(-100%); 
        opacity:0; 
        z-index:1000;
        background:white;
        overflow-y: auto;
    }
    .filter-sidebar-wrapper.show{ 
        transform: translateX(0); 
        opacity:1; 
    }
    .filter-sidebar {
        position: static;
        box-shadow: none;
        padding: 0 15px;
    }
    #showSidebar{ 
        display:inline-block !important; 
        background:#28a745; 
        color:white; 
        padding:8px 14px; 
        border-radius:4px; 
        font-weight:600; 
        margin-bottom:12px; 
        border: none;
    }
    #collapseSidebar{
        display: block !important;
        padding: 15px;
        text-align: right;
    }
    .page-content { padding: 10px; flex-direction: column; }
    .search-container { width: 100%; margin-bottom: 10px; }
    .action-buttons { margin-top: 10px; }
}
/* CHỈNH MÀU NÚT LƯU NHÀ CUNG CẤP */
#saveSupplierBtn { 
    background:#28a745; 
    color:#fff; 
    font-weight: 600; 
}

/* CSS cho detail row */
.detail-info { padding: 10px 20px; background-color: #f9f9f9; border-left: 5px solid #007bff; }
.detail-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.detail-col { flex-basis: 32%; font-size: 0.9em; }
</style>

<div class="page-content">

    <div class="filter-sidebar-wrapper" id="filterSidebarWrapper">
        <div class="filter-sidebar">
            <span id="collapseSidebar" style="cursor:pointer;color:#888;font-weight:600; display:none;">
                <i class="fa fa-times"></i> Đóng
            </span>
            <h4>Bộ lọc Nhà cung cấp</h4>

            <label>Tổng mua (VNĐ)</label>
            <div class="input-range-group">
                <input id="totalMin" type="number" placeholder="Từ">
                <input id="totalMax" type="number" placeholder="Đến">
            </div>
            <div id="totalError" style="color:red;font-size:0.9em;margin-bottom:10px"></div>

            <label>Nợ hiện tại (VNĐ)</label>
            <div class="input-range-group">
                <input id="debtMin" type="number" placeholder="Từ">
                <input id="debtMax" type="number" placeholder="Đến">
            </div>
            <div id="debtError" style="color:red;font-size:0.9em;margin-bottom:10px"></div>

            <label>Trạng thái</label>
            <div style="margin-bottom:10px">
                <button type="button" class="statusFilter active" data-val="">Tất cả</button>
                <button type="button" class="statusFilter" data-val="Active">Đang hoạt động</button>
                <button type="button" class="statusFilter" data-val="Inactive">Ngừng hoạt động</button>
            </div>

            <div id="addSupplierForm" style="display:none; padding-top: 15px; border-top: 1px solid #eee;">
                <h4>Thêm Nhà cung cấp mới</h4>
                <input type="text" id="newCode" placeholder="Mã NCC (Bắt buộc)">
                <input type="text" id="newName" placeholder="Tên NCC (Bắt buộc)">
                <input type="text" id="newContact" placeholder="Điện thoại">
                <input type="number" id="newDebt" placeholder="Nợ hiện tại (0)">
                <input type="number" id="newTotal" placeholder="Tổng mua (0)">
                <select id="newStatus">
                    <option value="Active">Đang hoạt động</option>
                    <option value="Inactive">Ngừng hoạt động</option>
                </select>
                <button id="saveSupplierBtn" style="margin-top: 10px; width: 100%;"><i class="fa fa-save"></i> Lưu Nhà cung cấp</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <button id="showSidebar" style="display:none;"><i class="fa fa-filter"></i> Bộ lọc</button> 

        <div class="main-actions">
            <div class="search-container">
                <i class="fa fa-search"></i>
                <input type="text" id="searchBox" placeholder="Theo mã, tên, số điện thoại...">
            </div>
            <div class="action-buttons">
                <button id="addSupplierBtn"><i class="fa fa-plus-circle"></i> Nhà cung cấp</button>
                <button id="exportBtn"><i class="fa fa-file-export"></i> Xuất file</button>
            </div>
        </div>

        <table id="supplierTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th></th>
                    <th>Mã nhà cung cấp</th>
                    <th>Tên nhà cung cấp</th>
                    <th>Điện thoại</th>
                    <th>Nợ hiện tại</th>
                    <th>Tổng mua</th> 
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ncc in Model)
                {
                    <tr>
                        <td></td> @* Cột 0: Details Control *@
                        <td>@ncc.MaNCC</td> @* Cột 1: Mã NCC *@
                        <td>@ncc.TenNCC</td> @* Cột 2: Tên NCC *@
                        <td>@ncc.DienThoai</td> @* Cột 3: Điện thoại *@
                        <td data-order="@ncc.NoHienTai">@ncc.NoHienTai</td> @* Cột 4: Nợ hiện tại *@
                        <td data-order="@ncc.TongMua">@ncc.TongMua</td> @* Cột 5: Tổng mua *@
                        <td>@ncc.TrangThai</td> @* Cột 6: Trạng thái *@
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
/* ----------------------------------------------------- */
/* JAVASCRIPT LOGIC */
/* ----------------------------------------------------- */
function formatCurrency(number) {
    if (number == null || isNaN(number)) return '0 ₫';
    return number.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
}

function checkMobile() {
    if ($(window).width() <= 992) {
        $('#showSidebar').show();
        $('#collapseSidebar').show();
        $('.filter-sidebar-wrapper').removeClass('show');
    } else {
        $('#showSidebar').hide();
        $('#collapseSidebar').hide();
        $('.filter-sidebar-wrapper').removeClass('show');
    }
}

$(document).ready(function(){
    checkMobile();
    $(window).on('resize', checkMobile);

    /* SIDEBAR ANIMATION (Responsive) */
    $('#showSidebar').click(function(){ 
        $('#filterSidebarWrapper').addClass('show');
    });
    $('#collapseSidebar').click(function(){ 
        $('#filterSidebarWrapper').removeClass('show');
    });

    /* RENDER DEBT/TOTAL AMOUNT (Format tiền tệ) */
    function renderAmount(data, type) {
        if (type === 'display' || type === 'filter') {
            const num = parseFloat(data.toString().replace(/[^0-9.]/g, '')) || 0; 
            // Thêm định dạng tiền tệ cho dữ liệu hiển thị trên DataTables
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num).replace('₫', '').trim() + 'đ';
        }
        return data;
    }

    /* RENDER STATUS */
    function renderStatus(data, type) {
        if (type === 'display') {
            const statusText = (data === 'Active' || data === 'Đang hoạt động') ? 'Đang hoạt động' : 'Ngừng hoạt động';
            const statusValue = (data === 'Active' || data === 'Đang hoạt động') ? 'Active' : 'Inactive';
            const color = statusValue === 'Active' ? '#28a745' : '#dc3545';
            return `<span style="color: ${color}; font-weight: 500;">${statusText}</span>`;
        }
        return data;
    }
    
    /* DATATABLE CUSTOM SEARCH LOGIC */
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // -------------------------------------------------------------
            // ĐÃ XÓA LOGIC LỌC NHÓM (Vì cột nhóm đã bị xóa)
            // -------------------------------------------------------------

            // Lọc Nợ hiện tại (Cột 4)
            let debtMin = parseInt($('#debtMin').val()) || 0;
            let debtMax = parseInt($('#debtMax').val()) || Infinity;
            let debtCol = parseFloat(data[4].toString().replace(/[^0-9.]/g,'')) || 0; // ĐÃ SỬA: data[4]
            if (debtMin > debtMax || !(debtCol >= debtMin && debtCol <= debtMax)) {
                return false;
            }
            
            // Lọc Tổng mua (Cột 5)
            let totalMin = parseInt($('#totalMin').val()) || 0;
            let totalMax = parseInt($('#totalMax').val()) || Infinity;
            let totalCol = parseFloat(data[5].toString().replace(/[^0-9.]/g,'')) || 0; // ĐÃ SỬA: data[5]
            if (totalMin > totalMax || !(totalCol >= totalMin && totalCol <= totalMax)) {
                return false;
            }

            return true;
        }
    );

    /* DATATABLE INITIALIZATION */
    var table = $('#supplierTable').DataTable({
        dom: 'rtip', 
        pagingType: 'simple_numbers',
        order: [[1, 'asc']], 
        buttons: [
            {
                extend: 'excelHtml5',
                title: 'DanhSachNhaCungCap',
                exportOptions: { columns: [1, 2, 3, 4, 5, 6] } 
            }
        ],
        columnDefs: [
            { targets: 0, orderable: false, className: 'details-control', defaultContent: '<i class="fa fa-plus-circle"></i>' },
            { targets: 4, render: renderAmount, type: 'num-fmt' }, // Nợ hiện tại (Index 4)
            { targets: 5, render: renderAmount, type: 'num-fmt' }, // Tổng mua (Index 5)
            { targets: 6, render: renderStatus }                     // Trạng thái (Index 6)
        ],
        "aoColumns": [null, null, null, null, null, null, null] // Tổng cộng 7 cột
    });

    // Xử lý mở rộng chi tiết dòng (Detail row)
    $('#supplierTable tbody').on('click','td.details-control',function(){
        var tr = $(this).closest('tr');
        var row = table.row(tr);
        var icon = $(this).find('i');

        if(row.child.isShown()){
            row.child.hide();
            icon.removeClass('fa-minus-circle').addClass('fa-plus-circle');
        } else {
            var d = row.data();
            row.child(`
                <div class="detail-info">
                    <div class="detail-row">
                        <div class="detail-col"><b>Thông tin</b></div>
                        <div class="detail-col"><b>Lịch sử nhập/trả hàng</b></div>
                        <div class="detail-col"><b>Nợ cần trả nhà cung cấp</b></div>
                    </div>
                    <hr style="margin: 5px 0; border-top: 1px solid #eee;">
                    <div class="detail-row">
                        <div class="detail-col"><b>Người tạo:</b> ADM KHO -Thương</div>
                        <div class="detail-col"><b>Ngày tạo:</b> 05/11/2025</div>
                        <div class="detail-col"><b>Nhóm nhà cung cấp:</b> Chưa có</div> 
                    </div>
                    <div class="detail-row">
                        <div class="detail-col"><b>Điện thoại:</b> ${d[3] || 'Chưa có'}</div>
                        <div class="detail-col"><b>Email:</b> Chưa có</div>
                        <div class="detail-col"><b>Địa chỉ:</b> Chưa có</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-sm btn-outline-primary" style="padding: 5px 10px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 4px;"><i class="fa fa-edit"></i> Chỉnh sửa</button>
                        <button class="btn btn-sm btn-outline-danger ml-2" style="padding: 5px 10px; border: 1px solid #dc3545; background: white; color: #dc3545; border-radius: 4px;"><i class="fa fa-trash"></i> Xóa</button>
                    </div>
                </div>
            `).show();
            icon.removeClass('fa-plus-circle').addClass('fa-minus-circle');
        }
    });

    $('#searchBox').keyup(function(){ table.search(this.value).draw(); });

    $('.statusFilter').click(function(){
        $('.statusFilter').removeClass('active');
        $(this).addClass('active');
        let searchVal = $(this).data('val');
        // ĐÃ SỬA: Cột trạng thái là index 6
        table.column(6).search(searchVal ? '^'+searchVal+'$' : '', true, false).draw();
    });

    $('#groupFilter, #debtMin, #debtMax, #totalMin, #totalMax').on('input change', function () {
        let debtMin = parseInt($('#debtMin').val()) || 0;
        let debtMax = parseInt($('#debtMax').val()) || Infinity;
        $('#debtError').text(
            ($('#debtMin').val() !== "" && $('#debtMax').val() !== "" && debtMin > debtMax) ? "Tối đa phải lớn hơn tối thiểu" : ""
        );

        let totalMin = parseInt($('#totalMin').val()) || 0;
        let totalMax = parseInt($('#totalMax').val()) || Infinity;
        $('#totalError').text(
            ($('#totalMin').val() !== "" && $('#totalMax').val() !== "" && totalMin > totalMax) ? "Tối đa phải lớn hơn tối thiểu" : ""
        );

        table.draw();
    });

    $('#exportBtn').click(function(){
        table.button(0).trigger();
        $('#filterSidebarWrapper').removeClass('show');
    });

    $('#addSupplierBtn').click(function(){
        $('#addSupplierForm').slideToggle();
    });
    
    /* Gửi AJAX POST để LƯU VÀO DATABASE */
    $('#saveSupplierBtn').click(function() {
        let code = $('#newCode').val();
        let name = $('#newName').val();
        let contact = $('#newContact').val() || '';
        let debt = parseInt($('#newDebt').val()) || 0;
        let total = parseInt($('#newTotal').val()) || 0;
        let status = $('#newStatus').val();
        
        if (!code || !name) { 
            alert("Mã và Tên NCC là bắt buộc."); 
            return; 
        }

        const supplierData = {
            MaNCC: code,
            TenNCC: name,
            DienThoai: contact, 
            NoHienTai: debt,
            TongMua: total,
            TrangThai: status
        };

        // 3. Gửi AJAX POST request đến Controller
        $.ajax({
            url: '@Url.Action("AddSupplier", "NCC")', 
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(supplierData),
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    
                    // 4. Thêm dòng vào DataTables (7 cột)
                    const newData = response.data;
                    table.row.add([
                        '',                 // Cột 0: Details Control
                        newData.ma,         // Cột 1: Mã NCC
                        newData.ten,        // Cột 2: Tên NCC
                        newData.dienthoai,  // Cột 3: Điện thoại
                        newData.noHienTai,  // Cột 4: Nợ hiện tại
                        newData.tongMua,    // Cột 5: Tổng mua
                        newData.trangThai   // Cột 6: Trạng thái
                    ]).draw(false); // Dùng draw(false) để thêm và giữ nguyên vị trí trang

                    // 5. Reset form và ẩn
                    $('#addSupplierForm input').val(''); 
                    $('#newStatus').val('Active'); 
                    $('#addSupplierForm').slideUp();
                    $('#filterSidebarWrapper').removeClass('show');

                } else {
                    alert("Lỗi: " + response.message);
                }
            },
            // KHỐI XỬ LÝ LỖI AJAX (Giữ nguyên)
            error: function(xhr) {
                let errorMsg = "Lỗi kết nối Server. ";
                
                if (xhr.status === 404) {
                    errorMsg = "Lỗi 404: Không tìm thấy Action AddSupplier. Vui lòng kiểm tra Controller.";
                } else if (xhr.status === 500) {
                    errorMsg = "Lỗi 500: Lỗi Server nội bộ (thường do trùng Mã NCC hoặc lỗi DB).";
                } else if (xhr.status === 400) {
                    errorMsg = "Lỗi 400: Lỗi dữ liệu gửi lên (Model Binding).";
                }

                let responseJson = null;
                try {
                    responseJson = JSON.parse(xhr.responseText);
                } catch (e) {}

                if (responseJson && responseJson.message) {
                    errorMsg = responseJson.message;
                } else if (xhr.responseText && xhr.responseText.length < 200) {
                    errorMsg += " Chi tiết phản hồi: " + xhr.responseText;
                }
                
                alert("LỖI LƯU NCC: " + errorMsg);
            }
        });
    });
});
</script>