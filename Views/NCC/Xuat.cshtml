@{
    ViewBag.Title = "L·ªãch s·ª≠ xu·∫•t c·ªßa nh√† cung c·∫•p";
    Layout = "/Views/Shared/_Layout.cshtml"; /* Gi·ªØ nguy√™n Layout c·ªßa b·∫°n */
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<style>
    /* ----------------------------------------------------- */
    /* KIOTVIET-STYLE CSS & CUSTOM BOOTSTRAP (ƒê·ªíNG B·ªò) */
    /* ----------------------------------------------------- */

    body {
        background-color: #f5f7fa;
    
    }

    /* ====== SIDEBAR L·ªåC ====== */
    .filter-sidebar {
        background-color: #fff;
        border-right: 1px solid #eee;
        padding: 16px;
        min-width: 280px;
        max-width: 280px;
        height: 100vh;
        position: sticky;
        top: 0;
        overflow-y: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filter-sidebar h5 {
        font-weight: 600;
        margin-bottom: 15px;
        color: #444;
        font-size: 1.15rem;
    }

    .filter-sidebar h6 {
        font-weight: 600;
        font-size: 14px;
        margin-top: 18px;
        margin-bottom: 5px;
        color: #333;
    }

    .filter-sidebar input,
    .filter-sidebar select,
    .form-control-sm,
    .form-select-sm {
        font-size: 14px !important;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    /* FIX M·∫†NH M·∫º L·ªñI DATEPICKER: ƒê·∫£m b·∫£o input date kh√¥ng b·ªã ƒë√® */
    #customDateRange input {
        position: relative;
        z-index: 1051; 
    }

    /* N√∫t l·ªçc Tr·∫°ng th√°i */
    .filter-btn-group button {
        font-size: 13px;
        border-radius: 4px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: #fff;
        color: #555;
        font-weight: 500;
        transition: none;
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .filter-btn-group button.btn-active {
        background-color: #28a745; 
        color: #fff;
        border-color: #28a745;
    }

    /* ====== MAIN CONTENT ====== */
    .main-content {
        flex: 1;
        padding: 20px;
        max-width: calc(100% - 280px);
    }

    .top-bar {
        background: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-bar input {
        width: 350px;
        max-width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 8px 12px;
    }
    
    /* N√∫t h√†nh ƒë·ªông ph·∫£i */
    .action-buttons button {
        font-size: 14px;
        border-radius: 4px;
        padding: 8px 15px;
        font-weight: 500;
        background-color: #fff;
        color: #555;
        border: 1px solid #ddd;
    }

    /* N√∫t xu·∫•t file m√†u xanh l√° */
    #exportBtn {
        background-color: #28a745;
        color: #fff;
        border-color: #28a745;
    }

    /* DATATABLES & TABLE STYLE */
    .dataTables_wrapper { padding-top: 5px; }
    .dataTables_info {
        font-size: 13px;
        padding-top: 10px !important;
        display: inline-block;
    }
    .dataTables_paginate {
        float: right;
        padding-top: 10px !important;
    }
    .dataTables_paginate .paginate_button {
        padding: 4px 8px !important; 
        border-radius: 4px !important;
        margin: 2px !important;
        border: 1px solid #ddd !important;
        color: #333 !important; 
        background: #fff !important; 
        font-size: 13px; 
    }
    .dataTables_paginate .paginate_button:hover {
        background: #f1f1f1 !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #28a745 !important; 
        color: white !important;
        border-color: #28a745 !important;
    }


    .table thead th {
        background-color: #f1f1f1;
        font-weight: 600;
        color: #333;
        font-size: 14px;
        border-bottom: 2px solid #ddd;
    }
    
    .table-hover tbody tr:hover {
        background-color: #e6f8e5;
    }

    .badge-status {
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
    }

    .badge-completed {
        background-color: #e6f4ea;
        color: #2e7d32;
    }

    .badge-canceled {
        background-color: #fdecea;
        color: #b71c1c;
    }

    .badge-pending {
        background-color: #fff8e1;
        color: #9c6800;
    }
    
    /* Responsive for Sidebar */
    @@media (max-width: 992px) {
        .filter-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1050;
        }
        .filter-sidebar.show {
            transform: translateX(0);
        }
        .main-content {
            max-width: 100%;
        }
    }
</style>

<div class="d-flex" style="min-height: 90vh;">
    <div class="filter-sidebar" id="filterSidebar">
        <button id="closeSidebar" class="btn btn-sm btn-outline-secondary d-lg-none float-end" style="margin-top: -10px;"><i class="fa fa-times"></i></button>

        <h5>L·ªãch s·ª≠ xu·∫•t h√†ng</h5> <h6>Nh√† cung c·∫•p</h6>
        <select id="supplierFilter" class="form-select form-select-sm mb-2">
            <option value="">T·∫•t c·∫£ nh√† cung c·∫•p</option>
            <option value="VIPOMALL">VIPOMALL</option>
            <option value="EBIKE PH·ª§ T√ôNG">EBIKE PH·ª§ T√ôNG</option>
            <option value="HU·ª≤NH THU·∫¨N (PIN)">HU·ª≤NH THU·∫¨N (PIN)</option>
        </select>

        <h6>Th·ªùi gian</h6>
        <select id="timeRangeFilter" class="form-select form-select-sm mb-2">
            <option value="all">To√†n th·ªùi gian</option>
            <option value="today">H√¥m nay</option>
            <option value="last7days">7 ng√†y qua</option>
            <option value="thisMonth">Th√°ng n√†y</option>
            <option value="custom">T√πy ch·ªânh</option>
        </select>
        <div class="d-flex gap-2" id="customDateRange">
            <input type="date" id="dateStart" class="form-control form-control-sm" disabled>
            <input type="date" id="dateEnd" class="form-control form-control-sm" disabled>
        </div>

    
        
    </div>

    <div class="main-content">
        <div class="top-bar">
            <button id="openSidebar" class="btn btn-success d-lg-none me-3" style="padding: 8px 12px;"><i class="fa fa-filter"></i> B·ªô l·ªçc</button>

            <div class="search-bar d-flex gap-2">
                <input type="text" id="globalSearchBox" class="form-control shadow-sm" placeholder="üîç Theo m√£ phi·∫øu, nh√† cung c·∫•p...">
            </div>

            <div class="d-flex gap-2 action-buttons">
                <button class="btn" id="exportBtn"><i class="fa fa-file-export"></i> Xu·∫•t file</button>
            </div>
        </div>

        <table id="exportHistoryTable" class="table table-hover border rounded-3 shadow-sm bg-white" style="width:100%">
            <thead>
                <tr class="text-center">
                    <th>M√£ phi·∫øu</th>
                    <th>Ng√†y xu·∫•t</th> <th>Nh√† cung c·∫•p</th>
                    <th>Nh√¢n vi√™n x·ª≠ l√Ω</th>
                    <th>T·ªïng gi√° tr·ªã xu·∫•t</th> 
                    <th>Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody class="text-center">
                <tr>
                    <td>PX0001</td>
                    <td>02/11/2025</td>
                    <td>EBIKE PH·ª§ T√ôNG</td>
                    <td>Nguy·ªÖn VƒÉn C·ª≠</td>
                    <td>12350000</td>
                    <td>Xu·∫•t pin v√† s·∫°c</td>
                </tr>
                <tr>
                    <td>PX0002</td>
                    <td>31/10/2025</td>
                    <td>HU·ª≤NH THU·∫¨N (PIN)</td>
                    <td>Tr·∫ßn M·ªπ</td>
                    <td>7500000</td>
                    <td>Phi·∫øu h·ªßy do sai kho</td>
                </tr>
                <tr>
                    <td>PX0003</td>
                    <td>29/10/2025</td>
                    <td>VIPOMALL</td>
                    <td>H·ªìng Thanh</td>
                    <td>25000000</td>
                    <td>Xu·∫•t xe m·∫´u ki·ªÉm tra</td>
                </tr>
                <tr>
                    <td>PC0001</td>
                    <td>01/11/2025</td>
                    <td>VIPOMALL</td>
                    <td>Tr·∫ßn M·ªπ</td>
                    <td>15000000</td>
                    <td>Chuy·ªÉn kho ki·ªÉm k√™</td>
                </tr>
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-3">
             <div class="dataTables_info" id="exportHistoryTable_info" role="status" aria-live="polite"></div>
             <div class="dataTables_paginate paging_simple_numbers" id="exportHistoryTable_paginate"></div>
        </div>
    </div>
</div>

<script>
    /* ----------------------------------------------------- */
    /* JAVASCRIPT LOGIC V√Ä DATATABLES (ƒê·ªíNG B·ªò) */
    /* ----------------------------------------------------- */

    var table; // Bi·∫øn global cho DataTable
    
    // Khai b√°o c√°c Index C·ªôt cho d·ªÖ qu·∫£n l√Ω
    const SUPPLIER_COLUMN_INDEX = 2; // Nh√† cung c·∫•p
    const DATE_COLUMN_INDEX = 1;     // Ng√†y xu·∫•t (dd/mm/yyyy)
    const VALUE_COLUMN_INDEX = 4;    // T·ªïng gi√° tr·ªã xu·∫•t
    const STATUS_COLUMN_INDEX = 5;   // Tr·∫°ng th√°i

    /**
     * Chuy·ªÉn ƒë·ªïi chu·ªói ng√†y th√°ng (dd/mm/yyyy) trong b·∫£ng th√†nh ƒë·ªëi t∆∞·ª£ng Date (ch·ªâ ng√†y, reset gi·ªù).
     */
    function parseTableDate(dateString) {
        if (!dateString) return null;
        const parts = dateString.split('/');
        if (parts.length === 3) {
            // new Date(yyyy, mm-1, dd)
            const date = new Date(parts[2], parts[1] - 1, parts[0]); 
            date.setHours(0, 0, 0, 0); 
            return date;
        }
        return null;
    }

    /**
     * Chuy·ªÉn ƒë·ªïi chu·ªói ng√†y th√°ng t·ª´ input type="date" (yyyy-mm-dd) th√†nh ƒë·ªëi t∆∞·ª£ng Date (ch·ªâ ng√†y, reset gi·ªù).
     */
    function parseInputDate(dateString) {
        if (!dateString) return null;
        const date = new Date(dateString);
        date.setHours(0, 0, 0, 0); 
        return date;
    }

    $(document).ready(function () {
        
        /* --- DATATABLES INITIALIZATION --- */
        table = $('#exportHistoryTable').DataTable({ // ƒê·ªïi ID b·∫£ng
            dom: 'rtip', 
            pagingType: 'simple_numbers',
            order: [[DATE_COLUMN_INDEX, 'desc']], 
            buttons: [
                {
                    extend: 'excelHtml5',
                    title: 'LichSuXuatHang', // ƒê·ªïi t√™n file export
                    exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6] } 
                }
            ],
            "aoColumns": [null, null, null, null, null, null, null], 
            columnDefs: [
                { 
                    targets: VALUE_COLUMN_INDEX, // C·ªôt T·ªïng gi√° tr·ªã (Index 4)
                    render: function (data, type, row) {
                        const num = parseInt(data.toString().replace(/\D/g, '')) || 0;
                        if (type === 'display' || type === 'filter') {
                            const formatted = new Intl.NumberFormat('vi-VN').format(num) + 'ƒë';
                            return num < 0 ? `<span style="color:#dc3545;">${formatted}</span>` : formatted;
                        }
                        return num;
                    }
                },
                { 
                    }
                }
            ]
        });

        /* --- CUSTOM DATATABLES FILTER LOGIC (ƒê·ªíNG B·ªò HO√ÄN TO√ÄN) --- */
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                // ƒê·∫£m b·∫£o ch·ªâ √°p d·ª•ng cho b·∫£ng n√†y
                if (settings.nTable.id !== 'exportHistoryTable') { 
                    return true;
                }
                
                // --- L·ªåC 1: NH√Ä CUNG C·∫§P (C·ªôt 2) ---
                const selectedSupplier = $('#supplierFilter').val();
                if (selectedSupplier && selectedSupplier !== data[SUPPLIER_COLUMN_INDEX]) {
                    return false;
                }

                // --- L·ªåC 2: TH·ªúI GIAN (C·ªôt 1) ---
                const dateString = data[DATE_COLUMN_INDEX];
                const rowDate = parseTableDate(dateString); // S·ª≠ d·ª•ng h√†m parseTableDate

                const timeRange = $('#timeRangeFilter').val();
                let filterPass = true;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                
                if (timeRange === 'today') {
                    if (!rowDate || rowDate.getTime() !== today.getTime()) filterPass = false;
                } else if (timeRange === 'last7days') {
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7); 
                    if (!rowDate || rowDate < sevenDaysAgo) filterPass = false;
                } else if (timeRange === 'thisMonth') {
                    if (!rowDate || rowDate.getMonth() !== today.getMonth() || rowDate.getFullYear() !== today.getFullYear()) filterPass = false;
                } else if (timeRange === 'custom') {
                    const dateStartStr = $('#dateStart').val(); // yyyy-mm-dd
                    const dateEndStr = $('#dateEnd').val();     // yyyy-mm-dd
                    
                    const startDate = parseInputDate(dateStartStr);
                    const endDate = parseInputDate(dateEndStr);

                    if (startDate && rowDate) {
                        if (rowDate < startDate) filterPass = false;
                    }
                    if (endDate && rowDate) {
                        // Th√™m 1 ng√†y ƒë·ªÉ bao g·ªìm c·∫£ ng√†y k·∫øt th√∫c (ƒê·ªìng b·ªô logic)
                        const endOfDay = new Date(endDate);
                        endOfDay.setDate(endDate.getDate() + 1); 
                        if (rowDate >= endOfDay) filterPass = false;
                    }
                }
                
                if (!filterPass) return false;
                
                return true;
            }
        );

        /* --- EVENT HANDLERS --- */

        // 1. Global Search Box
        $('#globalSearchBox').on('keyup', function () {
            table.search(this.value).draw();
        });

        // 2. Supplier Filter
        $('#supplierFilter').on('change', function () {
            table.draw();
        });

        // 3. Time Range Filter Logic
        $('#timeRangeFilter').on('change', function () {
            const range = $(this).val();
            if (range === 'custom') {
                // K√≠ch ho·∫°t input
                $('#dateStart, #dateEnd').prop('disabled', false).val('');
            } else {
                // V√¥ hi·ªáu h√≥a input
                $('#dateStart, #dateEnd').prop('disabled', true).val('');
            }
            table.draw();
        });
        // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi c·ªßa input type="date"
        $('#dateStart, #dateEnd').on('change', function() {
            table.draw();
        });
        
        // 4. Status Filter Logic (C·ªôt 5)
        $('.statusFilter').on('click', function () {
            const status = $(this).data('val');
            $('.statusFilter').removeClass('btn-active');
            $(this).addClass('btn-active');
            
            // L·ªçc c·ªôt Tr·∫°ng th√°i (C·ªôt 5)
            table.column(STATUS_COLUMN_INDEX).search(status ? status : '', true, false).draw();
        });

        // 5. Export Button
        $('#exportBtn').on('click', function () {
            table.button(0).trigger();
        });
        
        // 6. Sidebar Responsive Toggle (ƒê·ªìng b·ªô)
        $('#openSidebar').on('click', function() {
            $('#filterSidebar').addClass('show');
        });
        $('#closeSidebar').on('click', function() {
            $('#filterSidebar').removeClass('show');
        });

    });
</script>