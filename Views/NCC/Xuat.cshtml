@model IEnumerable<QuanLyKho.Models.PhieuXuat>?
@{
    // FIX: S·ª≠ d·ª•ng 'as List<...>' v√† '?? new List<...>()' ƒë·ªÉ x·ª≠ l√Ω an to√†n
    var suppliers = ViewData["Suppliers"] as List<QuanLyKho.Models.NCC> ?? new List<QuanLyKho.Models.NCC>();
    ViewBag.Title = "L·ªãch s·ª≠ xu·∫•t c·ªßa nh√† cung c·∫•p";
    Layout = "/Views/Shared/_Layout.cshtml";
}

@functions {
    // FIX L·ªñI CS1503: ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ ch·∫•p nh·∫≠n decimal? v√† x·ª≠ l√Ω null an to√†n.
    string FormatCurrency(decimal? value)
    {
        // S·ª≠ d·ª•ng 0m (decimal zero) n·∫øu value l√† null
        var safeValue = value ?? 0m; 
        // S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng s·ªë (N0) cho format ti·ªÅn t·ªá Vi·ªát Nam (VND)
        return $"{safeValue.ToString("N0", new System.Globalization.CultureInfo("vi-VN"))} ‚Ç´";
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

<style>
    /* ----------------------------------------------------- */
    /* KIOTVIET-STYLE CSS & CUSTOM BOOTSTRAP (ƒê·ªíNG B·ªò) */
    /* (GI·ªÆ NGUY√äN CSS) */
    /* ----------------------------------------------------- */

    body {
        background-color: #f5f7fa;
    }

    /* ====== SIDEBAR L·ªåC ====== */
    .filter-sidebar {
        background-color: #fff;
        border-right: 1px solid #eee;
        padding: 16px;
        min-width: 280px;
        max-width: 280px;
        height: 100vh;
        position: sticky;
        top: 0;
        overflow-y: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filter-sidebar h5 {
        font-weight: 600;
        margin-bottom: 15px;
        color: #444;
        font-size: 1.15rem;
    }

    .filter-sidebar h6 {
        font-weight: 600;
        font-size: 14px;
        margin-top: 18px;
        margin-bottom: 5px;
        color: #333;
    }

    .filter-sidebar input,
    .filter-sidebar select,
    .form-control-sm,
    .form-select-sm {
        font-size: 14px !important;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    #customDateRange input {
        position: relative;
        z-index: 1051; 
    }

    /* N√∫t l·ªçc Tr·∫°ng th√°i */
    .filter-btn-group button {
        font-size: 13px;
        border-radius: 4px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: #fff;
        color: #555;
        font-weight: 500;
        transition: none;
        margin-right: 5px;
        margin-bottom: 5px;
    }

    .filter-btn-group button.btn-active {
        background-color: #28a745; 
        color: #fff;
        border-color: #28a745;
    }

    /* ====== MAIN CONTENT ====== */
    .main-content {
        flex: 1;
        padding: 20px;
        max-width: calc(100% - 280px);
    }

    .top-bar {
        background: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-bar input {
        width: 350px;
        max-width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 8px 12px;
    }
    
    .action-buttons button {
        font-size: 14px;
        border-radius: 4px;
        padding: 8px 15px;
        font-weight: 500;
        background-color: #fff;
        color: #555;
        border: 1px solid #ddd;
    }

    #exportBtn {
        background-color: #28a745;
        color: #fff;
        border-color: #28a745;
    }

    /* DATATABLES & TABLE STYLE */
    .dataTables_wrapper { padding-top: 5px; }
    .dataTables_info {
        font-size: 13px;
        padding-top: 10px !important;
        display: inline-block;
    }
    .dataTables_paginate {
        float: right;
        padding-top: 10px !important;
    }
    .dataTables_paginate .paginate_button {
        padding: 4px 8px !important; 
        border-radius: 4px !important;
        margin: 2px !important;
        border: 1px solid #ddd !important;
        color: #333 !important; 
        background: #fff !important; 
        font-size: 13px; 
    }
    .dataTables_paginate .paginate_button:hover {
        background: #f1f1f1 !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #28a745 !important; 
        color: white !important;
        border-color: #28a745 !important;
    }


    .table thead th {
        background-color: #f1f1f1;
        font-weight: 600;
        color: #333;
        font-size: 14px;
        border-bottom: 2px solid #ddd;
    }
    
    .table-hover tbody tr:hover {
        background-color: #e6f8e5;
    }

    /* Th√™m c·ªôt tr·∫°ng th√°i v√†o b·∫£ng */
    .badge-status {
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
    }

    .badge-completed {
        background-color: #e6f4ea;
        color: #2e7d32;
    }

    .badge-canceled {
        background-color: #fdecea;
        color: #b71c1c;
    }

    .badge-pending {
        background-color: #fff8e1;
        color: #9c6800;
    }
    
    @@media (max-width: 992px) {
        .filter-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1050;
        }
        .filter-sidebar.show {
            transform: translateX(0);
        }
        .main-content {
            max-width: 100%;
        }
    }
</style>

<div class="d-flex" style="min-height: 90vh;">
    <div class="filter-sidebar" id="filterSidebar">
        <button id="closeSidebar" class="btn btn-sm btn-outline-secondary d-lg-none float-end" style="margin-top: -10px;"><i class="fa fa-times"></i></button>

        <h5>L·ªãch s·ª≠ xu·∫•t h√†ng</h5> 
        <h6>Nh√† cung c·∫•p</h6>
        <select id="supplierFilter" class="form-select form-select-sm mb-2">
            <option value="">T·∫•t c·∫£ nh√† cung c·∫•p</option>
            @if (suppliers.Any())
            {
                // ƒê·ªï d·ªØ li·ªáu t·ª´ Database v√†o b·ªô l·ªçc
                foreach (var supplier in suppliers.DistinctBy(s => s.TenNCC))
                {
                    <option value="@supplier.TenNCC">@supplier.TenNCC</option>
                }
            }
        </select>

        <h6>Th·ªùi gian</h6>
        <select id="timeRangeFilter" class="form-select form-select-sm mb-2">
            <option value="all">To√†n th·ªùi gian</option>
            <option value="today">H√¥m nay</option>
            <option value="last7days">7 ng√†y qua</option>
            <option value="thisMonth">Th√°ng n√†y</option>
            <option value="custom">T√πy ch·ªânh</option>
        </select>
        <div class="d-flex gap-2" id="customDateRange">
            <input type="date" id="dateStart" class="form-control form-control-sm" disabled>
            <input type="date" id="dateEnd" class="form-control form-control-sm" disabled>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <button id="openSidebar" class="btn btn-success d-lg-none me-3" style="padding: 8px 12px;"><i class="fa fa-filter"></i> B·ªô l·ªçc</button>

            <div class="search-bar d-flex gap-2">
                <input type="text" id="globalSearchBox" class="form-control shadow-sm" placeholder="üîç Theo m√£ phi·∫øu, nh√† cung c·∫•p...">
            </div>

            <div class="d-flex gap-2 action-buttons">
                <button class="btn" id="exportBtn"><i class="fa fa-file-export"></i> Xu·∫•t file</button>
            </div>
        </div>

        <table id="exportHistoryTable" class="table table-hover border rounded-3 shadow-sm bg-white" style="width:100%">
            <thead>
                <tr class="text-center">
                    <th>M√£ phi·∫øu</th>
                    <th>Ng√†y xu·∫•t</th>
                    <th>Nh√† cung c·∫•p</th>
                    <th>Nh√¢n vi√™n x·ª≠ l√Ω</th>
                    <th>T·ªïng gi√° tr·ªã xu·∫•t</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody class="text-center">
                @if (Model != null)
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.MaPX</td>
                            <td>@(item.NgayXuat?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                            <td>@(item.NhaCungCap?.TenNCC ?? "N/A")</td> 
                            <td>@(item.NhanVien?.TenNV ?? "N/A")</td> 
                            @* **ƒê√É S·ª¨A L·ªñI:** G·ªçi FormatCurrency v·ªõi decimal? *@
                            <td>@FormatCurrency(item.TongGiaTri)</td> 
                            <td>
                                @{
                                    // Logic gi·∫£ ƒë·ªãnh tr·∫°ng th√°i d·ª±a tr√™n Ghi ch√∫ (B·∫°n n√™n thay b·∫±ng thu·ªôc t√≠nh Tr·∫°ng Th√°i th·ª±c t·∫ø c·ªßa PhieuXuat)
                                    var statusText = "Ho√†n th√†nh";
                                    var statusClass = "badge-completed";

                                    if (item.GhiChu?.Contains("H·ªßy", StringComparison.OrdinalIgnoreCase) == true)
                                    {
                                        statusText = "ƒê√£ h·ªßy";
                                        statusClass = "badge-canceled";
                                    }
                                    else if (item.GhiChu?.Contains("ƒêang", StringComparison.OrdinalIgnoreCase) == true || item.GhiChu?.Contains("Ch·ªù", StringComparison.OrdinalIgnoreCase) == true)
                                    {
                                        statusText = "ƒêang x·ª≠ l√Ω";
                                        statusClass = "badge-pending";
                                    }
                                }
                                <span class="badge-status @statusClass">@statusText</span>
                            </td>
                            <td>@item.GhiChu</td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-3">
             <div class="dataTables_info" id="exportHistoryTable_info" role="status" aria-live="polite"></div>
             <div class="dataTables_paginate paging_simple_numbers" id="exportHistoryTable_paginate"></div>
        </div>
    </div>
</div>

<script>
    /* ----------------------------------------------------- */
    /* JAVASCRIPT LOGIC V√Ä DATATABLES (GI·ªÆ NGUY√äN) */
    /* ----------------------------------------------------- */

    var table;
    
    // C√ÅC CH·ªà S·ªê C·ªòT (7 c·ªôt: 0 ƒë·∫øn 6)
    const SUPPLIER_COLUMN_INDEX = 2; 
    const DATE_COLUMN_INDEX = 1; ¬† ¬†
    const VALUE_COLUMN_INDEX = 4; ¬† ¬†
    const STATUS_COLUMN_INDEX = 5; 
    const GHI_CHU_COLUMN_INDEX = 6; 

    /**
     * Chuy·ªÉn ƒë·ªïi chu·ªói ng√†y th√°ng (dd/mm/yyyy) trong b·∫£ng th√†nh ƒë·ªëi t∆∞·ª£ng Date (ch·ªâ ng√†y, reset gi·ªù).
     */
    function parseTableDate(dateString) {
        if (!dateString) return null;
        const parts = dateString.split('/');
        if (parts.length === 3) {
            // new Date(yyyy, mm-1, dd)
            const date = new Date(parts[2], parts[1] - 1, parts[0]); 
            date.setHours(0, 0, 0, 0); 
            return date;
        }
        return null;
    }

    /**
     * Chuy·ªÉn ƒë·ªïi chu·ªói ng√†y th√°ng t·ª´ input type="date" (yyyy-mm-dd) th√†nh ƒë·ªëi t∆∞·ª£ng Date (ch·ªâ ng√†y, reset gi·ªù).
     */
    function parseInputDate(dateString) {
        if (!dateString) return null;
        const date = new Date(dateString);
        date.setHours(0, 0, 0, 0); 
        return date;
    }

    $(document).ready(function () {
        
        /* --- DATATABLES INITIALIZATION --- */
        table = $('#exportHistoryTable').DataTable({ 
            dom: 'rtip', 
            pagingType: 'simple_numbers',
            order: [[DATE_COLUMN_INDEX, 'desc']], 
            buttons: [
                {
                    extend: 'excelHtml5',
                    title: 'LichSuXuatHang', 
                    // C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG C·ªòT CHO EXPORT (7 c·ªôt: 0 ƒë·∫øn 6)
                    exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6] } 
                }
            ],
            // C·∫¨P NH·∫¨T 7 NULL cho 7 c·ªôt 
            "aoColumns": [null, null, null, null, null, null, null], 
            columnDefs: [
                { 
                    targets: VALUE_COLUMN_INDEX, // C·ªôt T·ªïng gi√° tr·ªã (Index 4)
                    render: function (data, type, row) {
                        // Lo·∫°i b·ªè k√Ω t·ª± ti·ªÅn t·ªá v√† d·∫•u ch·∫•m/ph·∫©y format ƒë·ªÉ chuy·ªÉn th√†nh s·ªë
                        const num = parseFloat(data.toString().replace(/[^\d.,-]/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
                        
                        if (type === 'display' || type === 'filter') {
                            // Format l·∫°i cho hi·ªÉn th·ªã
                            const formatted = new Intl.NumberFormat('vi-VN').format(num) + ' ‚Ç´';
                            return num < 0 ? `<span style="color:#dc3545;">${formatted}</span>` : formatted;
                        }
                        return num; // Tr·∫£ v·ªÅ s·ªë cho s·∫Øp x·∫øp
                    }
                },
                {
                    targets: STATUS_COLUMN_INDEX, // C·ªôt Tr·∫°ng th√°i (Index 5)
                    render: function (data, type, row) {
                        if (type === 'filter' || type === 'sort') {
                            // L·ªçc/S·∫Øp x·∫øp theo n·ªôi dung text b√™n trong badge 
                            return $(data).text(); 
                        }
                        return data; // Gi·ªØ nguy√™n HTML cho hi·ªÉn th·ªã
                    }
                }
            ]
        });

        /* --- CUSTOM DATATABLES FILTER LOGIC (GI·ªÆ NGUY√äN) --- */
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                // ƒê·∫£m b·∫£o ch·ªâ √°p d·ª•ng cho b·∫£ng n√†y
                if (settings.nTable.id !== 'exportHistoryTable') { 
                    return true;
                }
                
                // --- L·ªåC 1: NH√Ä CUNG C·∫§P (C·ªôt 2) ---
                const selectedSupplier = $('#supplierFilter').val();
                if (selectedSupplier && selectedSupplier !== data[SUPPLIER_COLUMN_INDEX]) {
                    return false;
                }

                // --- L·ªåC 2: TH·ªúI GIAN (C·ªôt 1) ---
                const dateString = data[DATE_COLUMN_INDEX];
                const rowDate = parseTableDate(dateString); 

                const timeRange = $('#timeRangeFilter').val();
                let filterPass = true;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                
                if (timeRange === 'today') {
                    if (!rowDate || rowDate.getTime() !== today.getTime()) filterPass = false;
                } else if (timeRange === 'last7days') {
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7); 
                    if (!rowDate || rowDate < sevenDaysAgo) filterPass = false;
                } else if (timeRange === 'thisMonth') {
                    if (!rowDate || rowDate.getMonth() !== today.getMonth() || rowDate.getFullYear() !== today.getFullYear()) filterPass = false;
                } else if (timeRange === 'custom') {
                    const dateStartStr = $('#dateStart').val(); 
                    const dateEndStr = $('#dateEnd').val(); 
                    
                    const startDate = parseInputDate(dateStartStr);
                    const endDate = parseInputDate(dateEndStr);

                    if (startDate && rowDate) {
                        if (rowDate < startDate) filterPass = false;
                    }
                    if (endDate && rowDate) {
                        const endOfDay = new Date(endDate);
                        endOfDay.setDate(endDate.getDate() + 1); 
                        if (rowDate >= endOfDay) filterPass = false;
                    }
                }
                
                if (!filterPass) return false;
                
                return true;
            }
        );

        /* --- EVENT HANDLERS --- */
        $('#globalSearchBox').on('keyup', function () {
            table.search(this.value).draw();
        });

        $('#supplierFilter').on('change', function () {
            table.draw();
        });

        $('#timeRangeFilter').on('change', function () {
            const range = $(this).val();
            if (range === 'custom') {
                $('#dateStart, #dateEnd').prop('disabled', false).val('');
            } else {
                $('#dateStart, #dateEnd').prop('disabled', true).val('');
            }
            table.draw();
        });
        
        $('#dateStart, #dateEnd').on('change', function() {
            table.draw();
        });
        
        // Logic l·ªçc c·ªôt Tr·∫°ng th√°i (C·ªôt 5)
        $('.statusFilter').on('click', function () {
            const status = $(this).data('val');
            $('.statusFilter').removeClass('btn-active');
            $(this).addClass('btn-active');
            
            // L·ªçc c·ªôt Tr·∫°ng th√°i (Index 5) theo n·ªôi dung text.
            table.column(STATUS_COLUMN_INDEX).search(status ? status : '', true, false).draw();
        });

        $('#exportBtn').on('click', function () {
            table.button(0).trigger();
        });
        
        // Mobile sidebar control
        $('#openSidebar').on('click', function() {
            $('#filterSidebar').addClass('show');
        });
        $('#closeSidebar').on('click', function() {
            $('#filterSidebar').removeClass('show');
        });
    });
</script>