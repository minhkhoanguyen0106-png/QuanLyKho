@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Danh s√°ch B√°o c√°o";
    var user = Context.Session.GetString("User");
    
    // ƒê·ªíNG B·ªò M√ÄU CH·ª¶ ƒê·∫†O (T·ª™ TRANG LINH KI·ªÜN/NCC)
    // Gi·ªØ l·∫°i primaryGreenDark v√¨ n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü d√≤ng 117
    var primaryGreenDark = "#28a745"; 
    // X√≥a var primaryGreenLight = "#e8f9e8"; ƒë·ªÉ lo·∫°i b·ªè c·∫£nh b√°o CS0219
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* S·ª≠ d·ª•ng bi·∫øn CSS ƒë·ªÉ qu·∫£n l√Ω m√†u s·∫Øc nh·∫•t qu√°n */
    :root {
        --primary-green-dark: #28a745; 
        --primary-green-light: #e8f9e8;
        --secondary-green-text: #1f421f;
        --background-color: #f7fcf7;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --border-color: #e1e1e1;
        --light-green-border: #cde8c8;
        --action-blue: #007bff; /* M√†u xanh d∆∞∆°ng cho c√°c n√∫t action */
    }

    body {
        background-color: var(--background-color);
        font-family: "Segoe UI", sans-serif;
    }

    /* ====== HEADER CHUNG ====== */
    .app-header {
        background-color: var(--primary-green-dark) !important;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px var(--shadow-color);
        margin-bottom: 20px;
    }

    /* ====== CARD CHUNG (SIDEBAR FILTER/DATA CARDS) ====== */
    .custom-card {
        background-color: #fff;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
        margin-bottom: 16px; /* Kho·∫£ng c√°ch d∆∞·ªõi */
    }
    
    .card-header-green {
        background-color: var(--primary-green-light);
        color: var(--primary-green-dark);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        padding: 12px 16px;
    }
    
    .card-header-dark-green {
        background-color: var(--primary-green-dark);
        color: white;
        font-weight: 600;
        border-bottom: none;
    }

    /* ====== N√öT & FORM CONTROL ====== */
    .btn-xanhbo {
        background-color: var(--primary-green-dark);
        color: #fff;
        border: none;
        transition: 0.3s;
        font-weight: 500;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 14px;
    }
    .btn-xanhbo:hover {
        background-color: #218838; 
        color: #fff;
    }
    
    .btn-outline-success-custom {
        color: var(--primary-green-dark);
        border-color: var(--primary-green-dark);
        font-weight: 500;
        transition: 0.3s;
    }
    .btn-outline-success-custom:hover {
        background-color: var(--primary-green-dark);
        color: white;
    }
    
    .form-control, .form-select {
        border-radius: 6px;
        font-size: 14px;
        border-color: var(--light-green-border);
    }
    
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25);
        border-color: var(--primary-green-dark);
    }
    
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--secondary-green-text);
    }
    
    /* N√∫t toggle filter cho mobile/tablet */
    @@media (max-width: 991.98px) {
        .filter-toggle-btn {
            display: block;
            margin-bottom: 15px;
            width: 100%;
        }
        .filter-sidebar {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n tr√™n m√†n h√¨nh nh·ªè */
        }
        .filter-sidebar.show-filter {
            display: block; /* Hi·ªÉn th·ªã khi ƒë∆∞·ª£c toggle */
        }
    }
    @@media (min-width: 992px) {
        .filter-toggle-btn {
            display: none; /* ·∫®n tr√™n m√†n h√¨nh l·ªõn */
        }
        .filter-sidebar {
            display: block;
        }
    }

    /* ====== THANH H√ÄNH ƒê·ªòNG (ACTION BAR) ====== */
    .action-bar {
        background-color: #fff;
        padding: 12px 16px;
        border-radius: 8px; 
        box-shadow: 0 1px 6px var(--shadow-color);
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    
    /* ====== B·∫¢NG D·ªÆ LI·ªÜU ====== */
    .table thead {
        background-color: #cde9cd; 
        color: var(--secondary-green-text);
        font-weight: 600;
        font-size: 13.5px;
    }
    .table th {
        padding: 10px 8px;
        border-bottom: 1px solid #b7dbb7 !important;
    }
    .table td {
        font-size: 13px;
        padding: 8px;
        vertical-align: middle;
    }
    .table-hover > tbody > tr:hover {
        background-color: #f5fff5; 
    }
    
    /* BADGES */
    .badge-status {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    .bg-success { background-color: #28a745 !important; color: white !important; }
    .bg-warning { background-color: #ffc107 !important; }
    .bg-info { background-color: #17a2b8 !important; color: white !important; }

</style>

<div class="container-fluid mt-4">
    
    <div class="app-header mb-4 d-flex justify-content-between align-items-center">
        <h4 class="fw-semibold m-0">üìä Danh s√°ch B√°o c√°o</h4>
        <div class="fw-semibold">
            Xin ch√†o, @(user ?? "Ng∆∞·ªùi d√πng")
        </div>
    </div>
    
    <div class="row g-4">
        
        <div class="col-12">
            <button class="btn btn-xanhbo filter-toggle-btn d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterSidebar" aria-expanded="false" aria-controls="filterSidebar">
                <i class="fa-solid fa-filter"></i> Hi·ªán/·∫®n B·ªô l·ªçc
            </button>
        </div>

        <div class="col-lg-3 collapse d-lg-block filter-sidebar" id="filterSidebar">
            <div class="custom-card p-3">
                @* S·ª¨ D·ª§NG BI·∫æN C# primaryGreenDark ·ªû ƒê√ÇY *@
                <h5 class="mb-3 fw-bold" style="color:@primaryGreenDark;"><i class="fa-solid fa-filter"></i> B·ªô l·ªçc B√°o c√°o</h5>

                <div class="mb-3">
                    <label class="filter-label" for="filterLoaiBaoCao">Lo·∫°i b√°o c√°o</label>
                    <select id="filterLoaiBaoCao" class="form-select">
                        <option value="">T·∫•t c·∫£ lo·∫°i b√°o c√°o</option>
                        <option value="Doanh thu">B√°o c√°o doanh thu</option>
                        <option value="T·ªìn kho">B√°o c√°o t·ªìn kho</option>
                        <option value="C√¥ng n·ª£">B√°o c√°o c√¥ng n·ª£</option>
                        <option value="B√°n h√†ng">B√°o c√°o b√°n h√†ng</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="filter-label" for="filterTrangThai">Tr·∫°ng th√°i</label>
                    <select id="filterTrangThai" class="form-select">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="Ho√†n t·∫•t">Ho√†n t·∫•t</option>
                        <option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
                        <option value="ƒê√£ g·ª≠i">ƒê√£ g·ª≠i</option>
                    </select>
                </div>
                
                <div class="mt-4">
                    <label class="filter-label">Kho·∫£ng th·ªùi gian t·∫°o</label>
                    <div class="mb-2">
                        <label class="filter-label">T·ª´ ng√†y</label>
                        <input type="date" class="form-control" id="startDateFilter">
                    </div>
                    <div>
                        <label class="filter-label">ƒê·∫øn ng√†y</label>
                        <input type="date" class="form-control" id="endDateFilter">
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-sm btn-xanhbo w-100" onclick="applyFilters()">
                        <i class="fa-solid fa-magnifying-glass"></i> √Åp d·ª•ng b·ªô l·ªçc
                    </button>
                </div>
            </div>
            
            <div class="custom-card h-auto">
                <div class="card-header-green">
                    Ph√¢n b·ªï theo Lo·∫°i b√°o c√°o
                </div>
                <div class="card-body">
                    <canvas id="chartLoaiBaoCao" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            
            <div class="action-bar d-flex justify-content-between flex-wrap align-items-center">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <input type="text" id="globalSearchBox" class="form-control" placeholder="üîç T√¨m theo T√™n, M√£ b√°o c√°o..." style="width: 250px;">
                    <button class="btn btn-xanhbo" onclick="createNewReport()">
                        <i class="fa fa-plus"></i> T·∫°o b√°o c√°o m·ªõi
                    </button>
                </div>

                <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                    <button class="btn btn-sm btn-outline-success-custom" onclick="exportToExcel()">
                        <i class="fa-solid fa-file-export"></i> Xu·∫•t Excel
                    </button>
                </div>
            </div>

            <div class="custom-card mb-4">
                <div class="card-header-green">
                    Th·ªëng k√™ theo Tr·∫°ng th√°i
                </div>
                <div class="card-body">
                    <canvas id="chartTrangThai" height="120"></canvas>
                </div>
            </div>
            
            <div class="custom-card">
                <div class="card-header-dark-green">
                    Danh s√°ch b√°o c√°o g·∫ßn ƒë√¢y
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>T√™n b√°o c√°o</th>
                                <th>Lo·∫°i</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Ng∆∞·ªùi l·∫≠p</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @* D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript *@
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Gi·∫£ l·∫≠p d·ªØ li·ªáu b·∫£ng
        const reportData = [
            { id: 1, name: 'B√°o c√°o doanh thu th√°ng 10', type: 'Doanh thu', date: '01/11/2025', user: 'Nguy·ªÖn VƒÉn C', status: 'Ho√†n t·∫•t' },
            { id: 2, name: 'B√°o c√°o t·ªìn kho qu√Ω IV', type: 'T·ªìn kho', date: '28/10/2025', user: 'Tr·∫ßn Th·ªã B', status: 'ƒêang x·ª≠ l√Ω' },
            { id: 3, name: 'B√°o c√°o b√°n h√†ng tu·∫ßn 43', type: 'B√°n h√†ng', date: '25/10/2025', user: 'Ph·∫°m Minh D', status: 'Ho√†n t·∫•t' },
            { id: 4, name: 'B√°o c√°o c√¥ng n·ª£ kh√°ch h√†ng Q4', type: 'C√¥ng n·ª£', date: '20/10/2025', user: 'Nguy·ªÖn VƒÉn C', status: 'ƒê√£ g·ª≠i' },
            { id: 5, name: 'B√°o c√°o doanh thu th√°ng 9', type: 'Doanh thu', date: '01/10/2025', user: 'Nguy·ªÖn VƒÉn C', status: 'Ho√†n t·∫•t' },
            { id: 6, name: 'B√°o c√°o b√°n h√†ng tu·∫ßn 42', type: 'B√°n h√†ng', date: '18/10/2025', user: 'Ph·∫°m Minh D', status: 'Ho√†n t·∫•t' },
        ];
        
        let filteredData = [...reportData];
        
        /**
        * Gi·∫£ l·∫≠p ch·ª©c nƒÉng xem b√°o c√°o.
        * @@param {object} report - ƒê·ªëi t∆∞·ª£ng b√°o c√°o.
        */
        function viewReport(report) {
            alert(`ƒêang m·ªü b√°o c√°o: ${report.name} (Lo·∫°i: ${report.type}, ID: ${report.id})\n\n[Trang chi ti·∫øt b√°o c√°o s·∫Ω hi·ªán ra ·ªü ƒë√¢y]`);
            // Trong th·ª±c t·∫ø, s·∫Ω l√† window.location.href = `/reports/view/${report.id}`;
        }

        /**
        * Gi·∫£ l·∫≠p ch·ª©c nƒÉng t·∫£i b√°o c√°o.
        * @@param {object} report - ƒê·ªëi t∆∞·ª£ng b√°o c√°o.
        */
        function downloadReport(report) {
            alert(`ƒêang t·∫£i file: ${report.name}.pdf`);
            // Trong th·ª±c t·∫ø, s·∫Ω l√† request API ƒë·ªÉ t·∫£i file
        }

        /**
        * Gi·∫£ l·∫≠p ch·ª©c nƒÉng xu·∫•t t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ l·ªçc ra Excel.
        */
        function exportToExcel() {
            alert(`ƒêang xu·∫•t ${filteredData.length} b√°o c√°o ra file Excel...`);
            // Trong th·ª±c t·∫ø, s·∫Ω l√† window.location.href = `/reports/export-excel?filters=...`;
        }
        
        /**
        * Gi·∫£ l·∫≠p ch·ª©c nƒÉng chuy·ªÉn sang trang t·∫°o b√°o c√°o m·ªõi.
        */
        function createNewReport() {
            alert("Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang T·∫°o b√°o c√°o m·ªõi. (V√≠ d·ª•: /reports/create)");
            // Trong th·ª±c t·∫ø, s·∫Ω l√† window.location.href = '/reports/create';
        }

        // C·∫ßn d√πng JavaScript ƒë·ªÉ hi·ªÉn th·ªã l·∫°i b·∫£ng (n·∫øu kh√¥ng d√πng DataTables)
        function renderTable(data) {
            const tbody = document.querySelector('.table tbody');
            tbody.innerHTML = ''; 
            
            const btnOutlineClass = "btn-outline-success-custom"; 

            data.forEach((report, index) => {
                let statusBadgeClass = '';
                switch (report.status) {
                    case 'Ho√†n t·∫•t': statusBadgeClass = 'bg-success'; break;
                    case 'ƒêang x·ª≠ l√Ω': statusBadgeClass = 'bg-warning text-dark'; break;
                    case 'ƒê√£ g·ª≠i': statusBadgeClass = 'bg-info'; break;
                    default: statusBadgeClass = 'bg-secondary';
                }
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${report.name}</td>
                        <td>${report.type}</td>
                        <td>${report.date}</td>
                        <td>${report.user}</td>
                        <td><span class="badge badge-status ${statusBadgeClass}">${report.status}</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-xanhbo" onclick="viewReport(reportData.find(r => r.id === ${report.id}))">üìÑ Xem</button>
                            <button class="btn btn-sm ${btnOutlineClass}" onclick="downloadReport(reportData.find(r => r.id === ${report.id}))">‚¨á T·∫£i</button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        function applyFilters() {
            const typeFilter = document.getElementById('filterLoaiBaoCao').value;
            const statusFilter = document.getElementById('filterTrangThai').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            const search = document.getElementById('globalSearchBox').value.toLowerCase();

            filteredData = reportData.filter(report => {
                // L·ªçc theo Lo·∫°i
                if (typeFilter && report.type !== typeFilter) return false;
                
                // L·ªçc theo Tr·∫°ng th√°i
                if (statusFilter && report.status !== statusFilter) return false;
                
                // L·ªçc theo T√¨m ki·∫øm (T√™n ho·∫∑c ID)
                if (search && !(report.name.toLowerCase().includes(search) || report.id.toString().includes(search))) return false;
                
                // L·ªçc theo Ng√†y
                if (startDate || endDate) {
                    // Chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng dd/mm/yyyy sang yyyy-mm-dd ƒë·ªÉ t·∫°o Date object
                    const dateParts = report.date.split('/');
                    // new Date(year, monthIndex, day)
                    const reportDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]); 
                    
                    if (startDate) {
                         const start = new Date(startDate);
                         // ƒê·∫∑t gi·ªù v·ªÅ 0 ƒë·ªÉ so s√°nh ch√≠nh x√°c ng√†y
                         start.setHours(0, 0, 0, 0); 
                         if (reportDate.getTime() < start.getTime()) return false;
                    }
                    if (endDate) {
                         const end = new Date(endDate);
                         // ƒê·∫∑t gi·ªù v·ªÅ cu·ªëi ng√†y ƒë·ªÉ bao g·ªìm c·∫£ ng√†y ƒë√≥
                         end.setHours(23, 59, 59, 999); 
                         if (reportDate.getTime() > end.getTime()) return false;
                    }
                }

                return true;
            });

            renderTable(filteredData);
            updateChartData(filteredData);
        }
        
        function updateChartData(data) {
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Lo·∫°i B√°o c√°o (Doughnut)
            const typeCounts = { 'Doanh thu': 0, 'T·ªìn kho': 0, 'C√¥ng n·ª£': 0, 'B√°n h√†ng': 0 };
            const statusCounts = { 'Ho√†n t·∫•t': 0, 'ƒêang x·ª≠ l√Ω': 0, 'ƒê√£ g·ª≠i': 0 };

            data.forEach(report => {
                if (typeCounts.hasOwnProperty(report.type)) {
                    typeCounts[report.type]++;
                }
                if (statusCounts.hasOwnProperty(report.status)) {
                    statusCounts[report.status]++;
                }
            });
            
            // Bi·ªÉu ƒë·ªì 1
            const typeLabels = Object.keys(typeCounts);
            const typeValues = Object.values(typeCounts);
            chartLoai.data.labels = typeLabels.filter((_, i) => typeValues[i] > 0);
            chartLoai.data.datasets[0].data = typeValues.filter(v => v > 0);
            chartLoai.options.plugins.title.text = `T·ªïng s·ªë b√°o c√°o: ${data.length}`;
            chartLoai.update();
            
            // Bi·ªÉu ƒë·ªì 2
            chartTrangThai.data.datasets[0].data = Object.values(statusCounts);
            chartTrangThai.update();
        }

        // --- KH·ªûI T·∫†O BI·ªÇU ƒê·ªí ---
        let chartLoai, chartTrangThai;

        document.addEventListener('DOMContentLoaded', function() {
            
            // Bi·ªÉu ƒë·ªì 1: PH√ÇN B·ªî LO·∫†I B√ÅO C√ÅO (DOUGHNUT CHART)
            const ctxLoai = document.getElementById('chartLoaiBaoCao').getContext('2d');
            chartLoai = new Chart(ctxLoai, {
                type: 'doughnut',
                data: {
                    labels: ['Doanh thu', 'T·ªìn kho', 'C√¥ng n·ª£', 'B√°n h√†ng'],
                    datasets: [{
                        data: [3, 1, 1, 1], // D·ªØ li·ªáu gi·∫£ ƒë·ªãnh d·ª±a tr√™n reportData c√≥ 6 m·ª•c
                        backgroundColor: [
                            '#28a745', // Xanh ƒë·∫≠m
                            '#007bff', // Xanh d∆∞∆°ng (T·ªìn kho)
                            '#ffc107', // V√†ng (C√¥ng n·ª£)
                            '#dc3545' ¬†// ƒê·ªè (B√°n h√†ng)
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }, 
                        title: {
                            display: true,
                            text: 'T·ªïng s·ªë b√°o c√°o: 6', 
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                }
            });

            // Bi·ªÉu ƒë·ªì 2: TH·ªêNG K√ä TR·∫†NG TH√ÅI (BAR CHART)
            const ctxTrangThai = document.getElementById('chartTrangThai').getContext('2d');
            chartTrangThai = new Chart(ctxTrangThai, {
                type: 'bar',
                data: {
                    labels: ['Ho√†n t·∫•t', 'ƒêang x·ª≠ l√Ω', 'ƒê√£ g·ª≠i'],
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng b√°o c√°o',
                        data: [4, 1, 1], // D·ªØ li·ªáu gi·∫£ ƒë·ªãnh d·ª±a tr√™n reportData c√≥ 6 m·ª•c
                        backgroundColor: [
                            '#28a745', 
                            '#ffc107', 
                            '#17a2b8' ¬†
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'S·ªë l∆∞·ª£ng' }
                        },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // G√°n s·ª± ki·ªán cho c√°c b·ªô l·ªçc
            document.getElementById('filterLoaiBaoCao').addEventListener('change', applyFilters);
            document.getElementById('filterTrangThai').addEventListener('change', applyFilters);
            document.getElementById('startDateFilter').addEventListener('change', applyFilters);
            document.getElementById('endDateFilter').addEventListener('change', applyFilters);
            document.getElementById('globalSearchBox').addEventListener('keyup', applyFilters);

            // Render b·∫£ng v√† bi·ªÉu ƒë·ªì l·∫ßn ƒë·∫ßu
            renderTable(reportData);
            updateChartData(reportData);
        });
    </script>
}